
if(Ext.version=='3.0'){Ext.override(Ext.grid.GridView,{ensureVisible:function(row,col,hscroll){var resolved=this.resolveCell(row,col,hscroll);if(!resolved||!resolved.row){return;}
var rowEl=resolved.row,cellEl=resolved.cell,c=this.scroller.dom,ctop=0,p=rowEl,stop=this.el.dom;var p=rowEl,stop=this.el.dom;while(p&&p!=stop){ctop+=p.offsetTop;p=p.offsetParent;}
ctop-=this.mainHd.dom.offsetHeight;var cbot=ctop+rowEl.offsetHeight;var ch=c.clientHeight;var stop=parseInt(c.scrollTop,10);var sbot=stop+ch;if(ctop<stop){c.scrollTop=ctop;}else if(cbot>sbot){c.scrollTop=cbot-ch;}
if(hscroll!==false){var cleft=parseInt(cellEl.offsetLeft,10);var cright=cleft+cellEl.offsetWidth;var sleft=parseInt(c.scrollLeft,10);var sright=sleft+c.clientWidth;if(cleft<sleft){c.scrollLeft=cleft;}else if(cright>sright){c.scrollLeft=cright-c.clientWidth;}}
return this.getResolvedXY(resolved);}});}
Ext.namespace('Ext.ux.maximgb.tg');Ext.ux.maximgb.tg.AbstractTreeStore=Ext.extend(Ext.data.Store,{leaf_field_name:'_is_leaf',page_offset:0,active_node:null,constructor:function(config)
{Ext.ux.maximgb.tg.AbstractTreeStore.superclass.constructor.call(this,config);if(!this.paramNames.active_node){this.paramNames.active_node='anode';}
this.addEvents('beforeexpandnode','expandnode','expandnodefailed','beforecollapsenode','collapsenode','beforeactivenodechange','activenodechange');},remove:function(record)
{if(record===this.active_node){this.setActiveNode(null);}
this.removeNodeDescendants(record);Ext.ux.maximgb.tg.AbstractTreeStore.superclass.remove.call(this,record);},removeNodeDescendants:function(rc)
{var i,len,children=this.getNodeChildren(rc);for(i=0,len=children.length;i<len;i++){this.remove(children[i]);}},load:function(options)
{if(options){if(options.params){if(options.params[this.paramNames.active_node]===undefined){options.params[this.paramNames.active_node]=this.active_node?this.active_node.id:null;}}
else{options.params={};options.params[this.paramNames.active_node]=this.active_node?this.active_node.id:null;}}
else{options={params:{}};options.params[this.paramNames.active_node]=this.active_node?this.active_node.id:null;}
if(options.params[this.paramNames.active_node]!==null){options.add=true;}
return Ext.ux.maximgb.tg.AbstractTreeStore.superclass.load.call(this,options);},loadRecords:function(o,options,success)
{if(!o||success===false){if(success!==false){this.fireEvent("load",this,[],options);}
if(options.callback){options.callback.call(options.scope||this,[],options,false);}
return;}
var r=o.records,t=o.totalRecords||r.length,page_offset=this.getPageOffsetFromOptions(options),loaded_node_id=this.getLoadedNodeIdFromOptions(options),loaded_node,i,len,record,idx,updated,self=this;if(!options||options.add!==true){if(this.pruneModifiedRecords){this.modified=[];}
for(var i=0,len=r.length;i<len;i++){r[i].join(this);}
if(this.snapshot){this.data=this.snapshot;delete this.snapshot;}
this.data.clear();this.data.addAll(r);this.page_offset=page_offset;this.totalLength=t;this.applySort();this.fireEvent("datachanged",this);}
else{if(loaded_node_id){loaded_node=this.getById(loaded_node_id);}
if(loaded_node){this.setNodeChildrenOffset(loaded_node,page_offset);this.setNodeChildrenTotalCount(loaded_node,Math.max(t,r.length));this.removeNodeDescendants(loaded_node);}
this.suspendEvents();updated={};for(i=0,len=r.length;i<len;i++){record=r[i];idx=this.indexOfId(record.id);if(idx==-1){updated[record.id]=false;}
else{updated[record.id]=true;this.setNodeExpanded(record,this.isExpandedNode(this.getAt(idx)));}
this.add(record);}
this.applySort();this.resumeEvents();r.sort(function(r1,r2){var idx1=self.data.indexOf(r1),idx2=self.data.indexOf(r2),r;if(idx1>idx2){r=1;}
else{r=-1;}
return r;});for(i=0,len=r.length;i<len;i++){record=r[i];if(updated[record.id]==true){this.fireEvent('update',this,record,Ext.data.Record.COMMIT);}
else{this.fireEvent("add",this,[record],this.data.indexOf(record));}}}
this.fireEvent("load",this,r,options);if(options.callback){options.callback.call(options.scope||this,r,options,true);}},sort:function(fieldName,dir)
{if(this.remoteSort){this.setActiveNode(null);if(this.lastOptions){this.lastOptions.add=false;if(this.lastOptions.params){this.lastOptions.params[this.paramNames.active_node]=null;}}}
return Ext.ux.maximgb.tg.AbstractTreeStore.superclass.sort.call(this,fieldName,dir);},applySort:function()
{if(this.sortInfo&&!this.remoteSort){var s=this.sortInfo,f=s.field;this.sortData(f,s.direction);}
else{this.applyTreeSort();}},sortData:function(f,direction)
{direction=direction||'ASC';var st=this.fields.get(f).sortType;var fn=function(r1,r2){var v1=st(r1.data[f]),v2=st(r2.data[f]);return v1>v2?1:(v1<v2?-1:0);};this.data.sort(direction,fn);if(this.snapshot&&this.snapshot!=this.data){this.snapshot.sort(direction,fn);}
this.applyTreeSort();},applyTreeSort:function()
{var i,len,temp,rec,records=[],roots=this.getRootNodes();for(i=0,len=roots.length;i<len;i++){rec=roots[i];records.push(rec);this.collectNodeChildrenTreeSorted(records,rec);}
if(records.length>0){this.data.clear();this.data.addAll(records);}
if(this.snapshot&&this.snapshot!==this.data){temp=this.data;this.data=this.snapshot;this.snapshot=null;this.applyTreeSort();this.snapshot=this.data;this.data=temp;}},collectNodeChildrenTreeSorted:function(records,rec)
{var i,len,child,children=this.getNodeChildren(rec);for(i=0,len=children.length;i<len;i++){child=children[i];records.push(child);this.collectNodeChildrenTreeSorted(records,child);}},getActiveNode:function()
{return this.active_node;},setActiveNode:function(rc)
{if(this.active_node!==rc){if(rc){if(this.data.indexOf(rc)!=-1){if(this.fireEvent('beforeactivenodechange',this,this.active_node,rc)!==false){this.active_node=rc;this.fireEvent('activenodechange',this,this.active_node,rc);}}
else{throw"Given record is not from the store.";}}
else{if(this.fireEvent('beforeactivenodechange',this,this.active_node,rc)!==false){this.active_node=rc;this.fireEvent('activenodechange',this,this.active_node,rc);}}}},isExpandedNode:function(rc)
{return rc.ux_maximgb_tg_expanded===true;},setNodeExpanded:function(rc,value)
{rc.ux_maximgb_tg_expanded=value;},isVisibleNode:function(rc)
{var i,len,ancestors=this.getNodeAncestors(rc),result=true;for(i=0,len=ancestors.length;i<len;i++){result=result&&this.isExpandedNode(ancestors[i]);if(!result){break;}}
return result;},isLeafNode:function(rc)
{return rc.get(this.leaf_field_name)==true;},isLoadedNode:function(rc)
{var result;if(rc.ux_maximgb_tg_loaded!==undefined){result=rc.ux_maximgb_tg_loaded;}
else if(this.isLeafNode(rc)||this.hasChildNodes(rc)){result=true;}
else{result=false;}
return result;},setNodeLoaded:function(rc,value)
{rc.ux_maximgb_tg_loaded=value;},getNodeChildrenOffset:function(rc)
{return rc.ux_maximgb_tg_offset||0;},setNodeChildrenOffset:function(rc,value)
{rc.ux_maximgb_tg_offset=value;},getNodeChildrenTotalCount:function(rc)
{return rc.ux_maximgb_tg_total||0;},setNodeChildrenTotalCount:function(rc,value)
{rc.ux_maximgb_tg_total=value;},collapseNode:function(rc)
{if(this.isExpandedNode(rc)&&this.fireEvent('beforecollapsenode',this,rc)!==false){this.setNodeExpanded(rc,false);this.fireEvent('collapsenode',this,rc);}},expandNode:function(rc)
{var params;if(!this.isExpandedNode(rc)&&this.fireEvent('beforeexpandnode',this,rc)!==false){if(this.isLoadedNode(rc)){this.setNodeExpanded(rc,true);this.fireEvent('expandnode',this,rc);}
else{params={};params[this.paramNames.active_node]=rc.id;this.load({add:true,params:params,callback:this.expandNodeCallback,scope:this});}}},expandNodeCallback:function(r,options,success)
{var rc=this.getById(options.params[this.paramNames.active_node]);if(success&&rc){this.setNodeLoaded(rc,true);this.setNodeExpanded(rc,true);this.fireEvent('expandnode',this,rc);}
else{this.fireEvent('expandnodefailed',this,options.params[this.paramNames.active_node],rc);}},expandAll:function()
{var r,i,len,records=this.data.getRange();this.suspendEvents();for(i=0,len=records.length;i<len;i++){r=records[i];if(!this.isExpandedNode(r)){this.expandNode(r);}}
this.resumeEvents();this.fireEvent('datachanged',this);},collapseAll:function()
{var r,i,len,records=this.data.getRange();this.suspendEvents();for(i=0,len=records.length;i<len;i++){r=records[i];if(this.isExpandedNode(r)){this.collapseNode(r);}}
this.resumeEvents();this.fireEvent('datachanged',this);},getLoadedNodeIdFromOptions:function(options)
{var result=null;if(options&&options.params&&options.params[this.paramNames.active_node]){result=options.params[this.paramNames.active_node];}
return result;},getPageOffsetFromOptions:function(options)
{var result=0;if(options&&options.params&&options.params[this.paramNames.start]){result=parseInt(options.params[this.paramNames.start],10);if(isNaN(result)){result=0;}}
return result;},hasNextSiblingNode:function(rc)
{return this.getNodeNextSibling(rc)!==null;},hasPrevSiblingNode:function(rc)
{return this.getNodePrevSibling(rc)!==null;},hasChildNodes:function(rc)
{return this.getNodeChildrenCount(rc)>0;},getNodeAncestors:function(rc)
{var ancestors=[],parent;parent=this.getNodeParent(rc);while(parent){ancestors.push(parent);parent=this.getNodeParent(parent);}
return ancestors;},getNodeChildrenCount:function(rc)
{return this.getNodeChildren(rc).length;},getNodeNextSibling:function(rc)
{var siblings,parent,index,result=null;parent=this.getNodeParent(rc);if(parent){siblings=this.getNodeChildren(parent);}
else{siblings=this.getRootNodes();}
index=siblings.indexOf(rc);if(index<siblings.length-1){result=siblings[index+1];}
return result;},getNodePrevSibling:function(rc)
{var siblings,parent,index,result=null;parent=this.getNodeParent(rc);if(parent){siblings=this.getNodeChildren(parent);}
else{siblings=this.getRootNodes();}
index=siblings.indexOf(rc);if(index>0){result=siblings[index-1];}
return result;},getRootNodes:function()
{throw'Abstract method call';},getNodeDepth:function(rc)
{throw'Abstract method call';},getNodeParent:function(rc)
{throw'Abstract method call';},getNodeChildren:function(rc)
{throw'Abstract method call';},addToNode:function(parent,child)
{throw'Abstract method call';},removeFromNode:function(parent,child)
{throw'Abstract method call';},getPageOffset:function()
{return this.page_offset;},getActiveNodePageOffset:function()
{var result;if(this.active_node){result=this.getNodeChildrenOffset(this.active_node);}
else{result=this.getPageOffset();}
return result;},getActiveNodeCount:function()
{var result;if(this.active_node){result=this.getNodeChildrenCount(this.active_node);}
else{result=this.getRootNodes().length;}
return result;},getActiveNodeTotalCount:function()
{var result;if(this.active_node){result=this.getNodeChildrenTotalCount(this.active_node);}
else{result=this.getTotalCount();}
return result;}});Ext.ux.maximgb.tg.AdjacencyListStore=Ext.extend(Ext.ux.maximgb.tg.AbstractTreeStore,{parent_id_field_name:'_parent',getRootNodes:function()
{var i,len,result=[],records=this.data.getRange();for(i=0,len=records.length;i<len;i++){if(records[i].get(this.parent_id_field_name)==null){result.push(records[i]);}}
return result;},getNodeDepth:function(rc)
{return this.getNodeAncestors(rc).length;},getNodeParent:function(rc)
{return this.getById(rc.get(this.parent_id_field_name));},getNodeChildren:function(rc)
{var i,len,result=[],records=this.data.getRange();for(i=0,len=records.length;i<len;i++){if(records[i].get(this.parent_id_field_name)==rc.id){result.push(records[i]);}}
return result;},addToNode:function(parent,child)
{child.set(this.parent_id_field_name,parent.id);this.addSorted(child);},removeFromNode:function(parent,child)
{this.remove(child);}});Ext.reg('Ext.ux.maximgb.tg.AdjacencyListStore',Ext.ux.maximgb.tg.AdjacencyListStore);Ext.ux.maximgb.tg.NestedSetStore=Ext.extend(Ext.ux.maximgb.tg.AbstractTreeStore,{left_field_name:'_lft',right_field_name:'_rgt',level_field_name:'_level',root_node_level:1,getRootNodes:function()
{var i,len,result=[],records=this.data.getRange();for(i=0,len=records.length;i<len;i++){if(records[i].get(this.level_field_name)==this.root_node_level){result.push(records[i]);}}
return result;},getNodeDepth:function(rc)
{return rc.get(this.level_field_name)-this.root_node_level;},getNodeParent:function(rc)
{var result=null,rec,records=this.data.getRange(),i,len,lft,r_lft,rgt,r_rgt,level,r_level;lft=rc.get(this.left_field_name);rgt=rc.get(this.right_field_name);level=rc.get(this.level_field_name);for(i=0,len=records.length;i<len;i++){rec=records[i];r_lft=rec.get(this.left_field_name);r_rgt=rec.get(this.right_field_name);r_level=rec.get(this.level_field_name);if(r_level==level-1&&r_lft<lft&&r_rgt>rgt){result=rec;break;}}
return result;},getNodeChildren:function(rc)
{var lft,r_lft,rgt,r_rgt,level,r_level,records,rec,result=[];records=this.data.getRange();lft=rc.get(this.left_field_name);rgt=rc.get(this.right_field_name);level=rc.get(this.level_field_name);for(i=0,len=records.length;i<len;i++){rec=records[i];r_lft=rec.get(this.left_field_name);r_rgt=rec.get(this.right_field_name);r_level=rec.get(this.level_field_name);if(r_level==level+1&&r_lft>lft&&r_rgt<rgt){result.push(rec);}}
return result;}});Ext.ux.maximgb.tg.GridView=Ext.extend(Ext.grid.GridView,{expanded_icon_class:'ux-maximgb-tg-elbow-minus',last_expanded_icon_class:'ux-maximgb-tg-elbow-end-minus',collapsed_icon_class:'ux-maximgb-tg-elbow-plus',last_collapsed_icon_class:'ux-maximgb-tg-elbow-end-plus',skip_width_update_class:'ux-maximgb-tg-skip-width-update',initTemplates:function()
{var ts=this.templates||{};if(!ts.row){ts.row=new Ext.Template('<div class="x-grid3-row ux-maximgb-tg-level-{level} {alt}" style="{tstyle} {display_style}">','<table class="x-grid3-row-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">','<tbody>','<tr>{cells}</tr>',(this.enableRowBody?'<tr class="x-grid3-row-body-tr" style="{bodyStyle}">'+'<td colspan="{cols}" class="x-grid3-body-cell" tabIndex="0" hidefocus="on">'+'<div class="x-grid3-row-body">{body}</div>'+'</td>'+'</tr>':''),'</tbody>','</table>','</div>');}
if(!ts.mastercell){ts.mastercell=new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} {css}" style="{style}" tabIndex="0" {cellAttr}>','<div class="ux-maximgb-tg-mastercell-wrap">','{treeui}','<div class="x-grid3-cell-inner x-grid3-col-{id}" unselectable="on" {attr}>{value}</div>','</div>','</td>');}
if(!ts.treeui){ts.treeui=new Ext.Template('<div class="ux-maximgb-tg-uiwrap" style="width: {wrap_width}px">','{elbow_line}','<div style="left: {left}px" class="{cls}">&#160;</div>','</div>');}
if(!ts.elbow_line){ts.elbow_line=new Ext.Template('<div style="left: {left}px" class="{cls}">&#160;</div>');}
this.templates=ts;Ext.ux.maximgb.tg.GridView.superclass.initTemplates.call(this);},doRender:function(cs,rs,ds,startRow,colCount,stripe)
{var ts=this.templates,ct=ts.cell,rt=ts.row,last=colCount-1;var tstyle='width:'+this.getTotalWidth()+';';var buf=[],cb,c,p={},rp={tstyle:tstyle},r;for(var j=0,len=rs.length;j<len;j++){r=rs[j];cb=[];var rowIndex=(j+startRow);var row_render_res=this.renderRow(r,rowIndex,colCount,ds,this.cm.getTotalWidth());if(row_render_res===false){for(var i=0;i<colCount;i++){c=cs[i];p.id=c.id;p.css=i==0?'x-grid3-cell-first ':(i==last?'x-grid3-cell-last ':'');p.attr=p.cellAttr="";p.value=c.renderer(r.data[c.name],p,r,rowIndex,i,ds);p.style=c.style;if(Ext.isEmpty(p.value)){p.value="&#160;";}
if(this.markDirty&&r.dirty&&typeof r.modified[c.name]!=='undefined'){p.css+=' x-grid3-dirty-cell';}
if(c.id==this.grid.master_column_id){p.treeui=this.renderCellTreeUI(r,ds);ct=ts.mastercell;}
else{ct=ts.cell;}
cb[cb.length]=ct.apply(p);}}
else{cb.push(row_render_res);}
var alt=[];if(stripe&&((rowIndex+1)%2==0)){alt[0]="x-grid3-row-alt";}
if(r.dirty){alt[1]=" x-grid3-dirty-row";}
rp.cols=colCount;if(this.getRowClass){alt[2]=this.getRowClass(r,rowIndex,rp,ds);}
rp.alt=alt.join(" ");rp.cells=cb.join("");if(!ds.isVisibleNode(r)){rp.display_style='display: none;';}
else{rp.display_style='';}
rp.level=ds.getNodeDepth(r);buf[buf.length]=rt.apply(rp);}
return buf.join("");},renderCellTreeUI:function(record,store)
{var tpl=this.templates.treeui,line_tpl=this.templates.elbow_line,tpl_data={},rec,parent,depth=level=store.getNodeDepth(record);tpl_data.wrap_width=(depth+1)*16;if(level>0){tpl_data.elbow_line='';rec=record;left=0;while(level--){parent=store.getNodeParent(rec);if(parent){if(store.hasNextSiblingNode(parent)){tpl_data.elbow_line=line_tpl.apply({left:level*16,cls:'ux-maximgb-tg-elbow-line'})+
tpl_data.elbow_line;}
else{tpl_data.elbow_line=line_tpl.apply({left:level*16,cls:'ux-maximgb-tg-elbow-empty'})+
tpl_data.elbow_line;}}
else{throw["Tree inconsistency can't get level ",level+1," node(id=",rec.id,") parent."].join("");}
rec=parent;}}
if(store.isLeafNode(record)){if(store.hasNextSiblingNode(record)){tpl_data.cls='ux-maximgb-tg-elbow';}
else{tpl_data.cls='ux-maximgb-tg-elbow-end';}}
else{tpl_data.cls='ux-maximgb-tg-elbow-active ';if(store.isExpandedNode(record)){if(store.hasNextSiblingNode(record)){tpl_data.cls+=this.expanded_icon_class;}
else{tpl_data.cls+=this.last_expanded_icon_class;}}
else{if(store.hasNextSiblingNode(record)){tpl_data.cls+=this.collapsed_icon_class;}
else{tpl_data.cls+=this.last_collapsed_icon_class;}}}
tpl_data.left=1+depth*16;return tpl.apply(tpl_data);},renderRow:function(record,index,col_count,ds,total_width)
{return false;},afterRender:function()
{Ext.ux.maximgb.tg.GridView.superclass.afterRender.call(this);this.updateAllColumnWidths();},updateAllColumnWidths:function()
{var tw=this.getTotalWidth(),clen=this.cm.getColumnCount(),ws=[],len,i;for(i=0;i<clen;i++){ws[i]=this.getColumnWidth(i);}
this.innerHd.firstChild.style.width=this.getOffsetWidth();this.innerHd.firstChild.firstChild.style.width=tw;this.mainBody.dom.style.width=tw;for(i=0;i<clen;i++){var hd=this.getHeaderCell(i);hd.style.width=ws[i];}
var ns=this.getRows(),row,trow;for(i=0,len=ns.length;i<len;i++){row=ns[i];row.style.width=tw;if(row.firstChild){row.firstChild.style.width=tw;trow=row.firstChild.rows[0];for(var j=0;j<clen&&j<trow.childNodes.length;j++){if(!Ext.fly(trow.childNodes[j]).hasClass(this.skip_width_update_class)){trow.childNodes[j].style.width=ws[j];}}}}
this.onAllColumnWidthsUpdated(ws,tw);},updateColumnWidth:function(col,width)
{var w=this.getColumnWidth(col);var tw=this.getTotalWidth();this.innerHd.firstChild.style.width=this.getOffsetWidth();this.innerHd.firstChild.firstChild.style.width=tw;this.mainBody.dom.style.width=tw;var hd=this.getHeaderCell(col);hd.style.width=w;var ns=this.getRows(),row;for(var i=0,len=ns.length;i<len;i++){row=ns[i];row.style.width=tw;if(row.firstChild){row.firstChild.style.width=tw;if(col<row.firstChild.rows[0].childNodes.length){if(!Ext.fly(row.firstChild.rows[0].childNodes[col]).hasClass(this.skip_width_update_class)){row.firstChild.rows[0].childNodes[col].style.width=w;}}}}
this.onColumnWidthUpdated(col,w,tw);},updateColumnHidden:function(col,hidden)
{var tw=this.getTotalWidth();this.innerHd.firstChild.style.width=this.getOffsetWidth();this.innerHd.firstChild.firstChild.style.width=tw;this.mainBody.dom.style.width=tw;var display=hidden?'none':'';var hd=this.getHeaderCell(col);hd.style.display=display;var ns=this.getRows(),row,cell;for(var i=0,len=ns.length;i<len;i++){row=ns[i];row.style.width=tw;if(row.firstChild){row.firstChild.style.width=tw;if(col<row.firstChild.rows[0].childNodes.length){if(!Ext.fly(row.firstChild.rows[0].childNodes[col]).hasClass(this.skip_width_update_class)){row.firstChild.rows[0].childNodes[col].style.display=display;}}}}
this.onColumnHiddenUpdated(col,hidden,tw);delete this.lastViewWidth;this.layout();},processRows:function(startRow,skipStripe)
{var processed_cnt=0;if(this.ds.getCount()<1){return;}
skipStripe=!this.grid.stripeRows;startRow=startRow||0;var rows=this.getRows();var processed_cnt=0;Ext.each(rows,function(row,idx){row.rowIndex=idx;row.className=row.className.replace(this.rowClsRe,' ');if(row.style.display!='none'){if(!skipStripe&&((processed_cnt+1)%2===0)){row.className+=' x-grid3-row-alt';}
processed_cnt++;}},this);Ext.fly(rows[0]).addClass(this.firstRowCls);Ext.fly(rows[rows.length-1]).addClass(this.lastRowCls);},ensureVisible:function(row,col,hscroll)
{var ancestors,record=this.ds.getAt(row);if(!this.ds.isVisibleNode(record)){ancestors=this.ds.getNodeAncestors(record);while(ancestors.length>0){record=ancestors.shift();if(!this.ds.isExpandedNode(record)){this.ds.expandNode(record);}}}
return Ext.ux.maximgb.tg.GridView.superclass.ensureVisible.call(this,row,col,hscroll);},expandRow:function(record,skip_process)
{var ds=this.ds,i,len,row,pmel,children,index,child_index;if(typeof record=='number'){index=record;record=ds.getAt(index);}
else{index=ds.indexOf(record);}
skip_process=skip_process||false;row=this.getRow(index);pmel=Ext.fly(row).child('.ux-maximgb-tg-elbow-active');if(pmel){if(ds.hasNextSiblingNode(record)){pmel.removeClass(this.collapsed_icon_class);pmel.removeClass(this.last_collapsed_icon_class);pmel.addClass(this.expanded_icon_class);}
else{pmel.removeClass(this.collapsed_icon_class);pmel.removeClass(this.last_collapsed_icon_class);pmel.addClass(this.last_expanded_icon_class);}}
if(ds.isVisibleNode(record)){children=ds.getNodeChildren(record);for(i=0,len=children.length;i<len;i++){child_index=ds.indexOf(children[i]);row=this.getRow(child_index);row.style.display='block';if(ds.isExpandedNode(children[i])){this.expandRow(child_index,true);}}}
if(!skip_process){this.processRows(0);}},collapseRow:function(record,skip_process)
{var ds=this.ds,i,len,children,row,index,child_index;if(typeof record=='number'){index=record;record=ds.getAt(index);}
else{index=ds.indexOf(record);}
skip_process=skip_process||false;row=this.getRow(index);pmel=Ext.fly(row).child('.ux-maximgb-tg-elbow-active');if(pmel){if(ds.hasNextSiblingNode(record)){pmel.removeClass(this.expanded_icon_class);pmel.removeClass(this.last_expanded_icon_class);pmel.addClass(this.collapsed_icon_class);}
else{pmel.removeClass(this.expanded_icon_class);pmel.removeClass(this.last_expanded_icon_class);pmel.addClass(this.last_collapsed_icon_class);}}
children=ds.getNodeChildren(record);for(i=0,len=children.length;i<len;i++){child_index=ds.indexOf(children[i]);row=this.getRow(child_index);if(row.style.display!='none'){row.style.display='none';this.collapseRow(child_index,true);}}
if(!skip_process){this.processRows(0);}},initData:function(ds,cm)
{Ext.ux.maximgb.tg.GridView.superclass.initData.call(this,ds,cm);if(this.ds){this.ds.un('expandnode',this.onStoreExpandNode,this);this.ds.un('collapsenode',this.onStoreCollapseNode,this);}
if(ds){ds.on('expandnode',this.onStoreExpandNode,this);ds.on('collapsenode',this.onStoreCollapseNode,this);}},onLoad:function(store,records,options)
{var ridx;if(options&&options.params&&(options.params[store.paramNames.active_node]===null||store.indexOfId(options.params[store.paramNames.active_node])==-1)){Ext.ux.maximgb.tg.GridView.superclass.onLoad.call(this,store,records,options);}},onAdd:function(ds,records,index)
{Ext.ux.maximgb.tg.GridView.superclass.onAdd.call(this,ds,records,index);if(this.mainWrap){this.processRows(0);}},onRemove:function(ds,record,index,isUpdate)
{Ext.ux.maximgb.tg.GridView.superclass.onRemove.call(this,ds,record,index,isUpdate);if(isUpdate!==true){if(this.mainWrap){this.processRows(0);}}},onUpdate:function(ds,record)
{Ext.ux.maximgb.tg.GridView.superclass.onUpdate.call(this,ds,record);if(this.mainWrap){this.processRows(0);}},onStoreExpandNode:function(store,rc)
{this.expandRow(rc);},onStoreCollapseNode:function(store,rc)
{this.collapseRow(rc);}});Ext.ux.maximgb.tg.GridPanel=Ext.extend(Ext.grid.GridPanel,{master_column_id:0,tg_cls:'ux-maximgb-tg-panel',initComponent:function()
{this.initComponentPreOverride();Ext.ux.maximgb.tg.GridPanel.superclass.initComponent.call(this);this.getSelectionModel().on('selectionchange',this.onTreeGridSelectionChange,this);this.initComponentPostOverride();},initComponentPreOverride:Ext.emptyFn,initComponentPostOverride:Ext.emptyFn,onRender:function(ct,position)
{Ext.ux.maximgb.tg.GridPanel.superclass.onRender.call(this,ct,position);this.el.addClass(this.tg_cls);},getView:function()
{if(!this.view){this.view=new Ext.ux.maximgb.tg.GridView(this.viewConfig);}
return this.view;},onClick:function(e)
{var target=e.getTarget(),view=this.getView(),row=view.findRowIndex(target),store=this.getStore(),sm=this.getSelectionModel(),record,record_id,do_default=true;if(row!==false){if(Ext.fly(target).hasClass('ux-maximgb-tg-elbow-active')){record=store.getAt(row);if(store.isExpandedNode(record)){store.collapseNode(record);}
else{store.expandNode(record);}
do_default=false;}}
if(do_default){Ext.ux.maximgb.tg.GridPanel.superclass.onClick.call(this,e);}},onMouseDown:function(e)
{var target=e.getTarget();if(!Ext.fly(target).hasClass('ux-maximgb-tg-elbow-active')){Ext.ux.maximgb.tg.GridPanel.superclass.onMouseDown.call(this,e);}},onTreeGridSelectionChange:function(sm,selection)
{var record,ancestors,store=this.getStore();if(sm.getSelected){record=sm.getSelected();store.setActiveNode(record);}
else if(sm.getSelectedCell&&selection){record=selection.record;store.setActiveNode(record);}
if(record){if(!store.isVisibleNode(record)){ancestors=store.getNodeAncestors(record);while(ancestors.length>0){store.expandNode(ancestors.pop());}}}}});Ext.ux.maximgb.tg.EditorGridPanel=Ext.extend(Ext.grid.EditorGridPanel,{master_column_id:0,initComponent:function()
{this.initComponentPreOverride();Ext.ux.maximgb.tg.EditorGridPanel.superclass.initComponent.call(this);this.getSelectionModel().on('selectionchange',this.onTreeGridSelectionChange,this);this.initComponentPostOverride();},initComponentPreOverride:Ext.emptyFn,initComponentPostOverride:Ext.emptyFn,onRender:function(ct,position)
{Ext.ux.maximgb.tg.EditorGridPanel.superclass.onRender.call(this,ct,position);this.el.addClass('ux-maximgb-tg-panel');},getView:function()
{if(!this.view){this.view=new Ext.ux.maximgb.tg.GridView(this.viewConfig);}
return this.view;},onClick:function(e)
{var target=e.getTarget(),view=this.getView(),row=view.findRowIndex(target),store=this.getStore(),sm=this.getSelectionModel(),record,record_id,do_default=true;if(row!==false){if(Ext.fly(target).hasClass('ux-maximgb-tg-elbow-active')){record=store.getAt(row);if(store.isExpandedNode(record)){store.collapseNode(record);}
else{store.expandNode(record);}
do_default=false;}}
if(do_default){Ext.ux.maximgb.tg.EditorGridPanel.superclass.onClick.call(this,e);}},onMouseDown:function(e)
{var target=e.getTarget();if(!Ext.fly(target).hasClass('ux-maximgb-tg-elbow-active')){Ext.ux.maximgb.tg.EditorGridPanel.superclass.onMouseDown.call(this,e);}},onTreeGridSelectionChange:function(sm,selection)
{var record,ancestors,store=this.getStore();if(sm.getSelected){record=sm.getSelected();store.setActiveNode(record);}
else if(sm.getSelectedCell&&selection){record=selection.record;store.setActiveNode(record);}
if(record){if(!store.isVisibleNode(record)){ancestors=store.getNodeAncestors(record);while(ancestors.length>0){store.expandNode(ancestors.pop());}}}}});Ext.ux.maximgb.tg.PagingToolbar=Ext.extend(Ext.PagingToolbar,{onRender:function(ct,position)
{Ext.ux.maximgb.tg.PagingToolbar.superclass.onRender.call(this,ct,position);this.updateUI();},getPageData:function()
{var total=0,cursor=0;if(this.store){cursor=this.store.getActiveNodePageOffset();total=this.store.getActiveNodeTotalCount();}
return{total:total,activePage:Math.ceil((cursor+this.pageSize)/this.pageSize),pages:total<this.pageSize?1:Math.ceil(total/this.pageSize)};},updateInfo:function()
{var count=0,cursor=0,total=0,msg;if(this.displayItem){if(this.store){cursor=this.store.getActiveNodePageOffset();count=this.store.getActiveNodeCount();total=this.store.getActiveNodeTotalCount();}
msg=count==0?this.emptyMsg:String.format(this.displayMsg,cursor+1,cursor+count,total);this.displayItem.setText(msg);}},updateUI:function()
{var d=this.getPageData(),ap=d.activePage,ps=d.pages;this.afterTextItem.setText(String.format(this.afterPageText,d.pages));this.inputItem.setValue(ap);this.first.setDisabled(ap==1);this.prev.setDisabled(ap==1);this.next.setDisabled(ap==ps);this.last.setDisabled(ap==ps);this.refresh.enable();this.updateInfo();},bindStore:function(store,initial)
{if(!initial&&this.store){this.store.un('activenodechange',this.onStoreActiveNodeChange,this);}
if(store){store.on('activenodechange',this.onStoreActiveNodeChange,this);}
Ext.ux.maximgb.tg.PagingToolbar.superclass.bindStore.call(this,store,initial);},beforeLoad:function(store,options)
{var paramNames=this.getParams();Ext.ux.maximgb.tg.PagingToolbar.superclass.beforeLoad.call(this,store,options);if(options&&options.params){if(options.params[paramNames.start]===undefined){options.params[paramNames.start]=0;}
if(options.params[paramNames.limit]===undefined){options.params[paramNames.limit]=this.pageSize;}}},moveFirst:function()
{this.doLoad(0);},movePrevious:function()
{var store=this.store,cursor=store?store.getActiveNodePageOffset():0;this.doLoad(Math.max(0,cursor-this.pageSize));},moveNext:function()
{var store=this.store,cursor=store?store.getActiveNodePageOffset():0;this.doLoad(cursor+this.pageSize);},moveLast:function()
{var store=this.store,cursor=store?store.getActiveNodePageOffset():0,total=store?store.getActiveNodeTotalCount():0,extra=total%this.pageSize;this.doLoad(extra?(total-extra):total-this.pageSize);},onStoreActiveNodeChange:function(store,old_rec,new_rec)
{if(this.rendered){this.updateUI();}}});Ext.reg('Ext.ux.maximgb.tg.GridPanel',Ext.ux.maximgb.tg.GridPanel);Ext.reg('Ext.ux.maximgb.tg.EditorGridPanel',Ext.ux.maximgb.tg.EditorGridPanel);Ext.reg('Ext.ux.maximgb.tg.PagingToolbar',Ext.ux.maximgb.tg.PagingToolbar);(function(){function $empty(){};function $extend(original,extended){for(var key in(extended||{}))original[key]=extended[key];return original;};function $lambda(value){return(typeof value=='function')?value:function(){return value;};};var $time=Date.now||function(){return+new Date;};function $splat(obj){var type=$type(obj);return(type)?((type!='array')?[obj]:obj):[];};var $type=function(elem){return $type.s.call(elem).match(/^\[object\s(.*)\]$/)[1].toLowerCase();};$type.s=Object.prototype.toString;function $each(iterable,fn){var type=$type(iterable);if(type=='object'){for(var key in iterable)fn(iterable[key],key);}else{for(var i=0;i<iterable.length;i++)fn(iterable[i],i);}};function $merge(){var mix={};for(var i=0,l=arguments.length;i<l;i++){var object=arguments[i];if($type(object)!='object')continue;for(var key in object){var op=object[key],mp=mix[key];mix[key]=(mp&&$type(op)=='object'&&$type(mp)=='object')?$merge(mp,op):$unlink(op);}}
return mix;};function $unlink(object){var unlinked;switch($type(object)){case'object':unlinked={};for(var p in object)unlinked[p]=$unlink(object[p]);break;case'array':unlinked=[];for(var i=0,l=object.length;i<l;i++)unlinked[i]=$unlink(object[i]);break;default:return object;}
return unlinked;};function $rgbToHex(srcArray,array){if(srcArray.length<3)return null;if(srcArray.length==4&&srcArray[3]==0&&!array)return'transparent';var hex=[];for(var i=0;i<3;i++){var bit=(srcArray[i]-0).toString(16);hex.push((bit.length==1)?'0'+bit:bit);}
return(array)?hex:'#'+hex.join('');};function $destroy(elem){$clean(elem);if(elem.parentNode)elem.parentNode.removeChild(elem);if(elem.clearAttributes)elem.clearAttributes();};function $clean(elem){for(var ch=elem.childNodes,i=0;i<ch.length;i++){$destroy(ch[i]);}};function $addEvent(obj,type,fn){if(obj.addEventListener)
obj.addEventListener(type,fn,false);else
obj.attachEvent('on'+type,fn);};function $hasClass(obj,klass){return(' '+obj.className+' ').indexOf(' '+klass+' ')>-1;};function $addClass(obj,klass){if(!$hasClass(obj,klass))obj.className=(obj.className+" "+klass);};function $removeClass(obj,klass){obj.className=obj.className.replace(new RegExp('(^|\\s)'+klass+'(?:\\s|$)'),'$1');};function $get(id){return document.getElementById(id);};var Class=function(properties){properties=properties||{};var klass=function(){this.constructor=klass;if(Class.prototyping)return this;var instance=(this.initialize)?this.initialize.apply(this,arguments):this;return instance;};for(var mutator in Class.Mutators){if(!properties[mutator])continue;properties=Class.Mutators[mutator](properties,properties[mutator]);delete properties[mutator];}
$extend(klass,this);klass.constructor=Class;klass.prototype=properties;return klass;};Class.Mutators={Extends:function(self,klass){Class.prototyping=klass.prototype;var subclass=new klass;delete subclass.parent;subclass=Class.inherit(subclass,self);delete Class.prototyping;return subclass;},Implements:function(self,klasses){$each($splat(klasses),function(klass){Class.prototying=klass;$extend(self,($type(klass)=='function')?new klass:klass);delete Class.prototyping;});return self;}};$extend(Class,{inherit:function(object,properties){var caller=arguments.callee.caller;for(var key in properties){var override=properties[key];var previous=object[key];var type=$type(override);if(previous&&type=='function'){if(override!=previous){if(caller){override.__parent=previous;object[key]=override;}else{Class.override(object,key,override);}}}else if(type=='object'){object[key]=$merge(previous,override);}else{object[key]=override;}}
if(caller)object.parent=function(){return arguments.callee.caller.__parent.apply(this,arguments);};return object;},override:function(object,name,method){var parent=Class.prototyping;if(parent&&object[name]!=parent[name])parent=null;var override=function(){var previous=this.parent;this.parent=parent?parent[name]:object[name];var value=method.apply(this,arguments);this.parent=previous;return value;};object[name]=override;}});Class.prototype.implement=function(){var proto=this.prototype;$each(Array.prototype.slice.call(arguments||[]),function(properties){Class.inherit(proto,properties);});return this;};this.TreeUtil={prune:function(tree,maxLevel){this.each(tree,function(elem,i){if(i==maxLevel&&elem.children){delete elem.children;elem.children=[];}});},getParent:function(tree,id){if(tree.id==id)return false;var ch=tree.children;if(ch&&ch.length>0){for(var i=0;i<ch.length;i++){if(ch[i].id==id)
return tree;else{var ans=this.getParent(ch[i],id);if(ans)return ans;}}}
return false;},getSubtree:function(tree,id){if(tree.id==id)return tree;for(var i=0,ch=tree.children;i<ch.length;i++){var t=this.getSubtree(ch[i],id);if(t!=null)return t;}
return null;},getLeaves:function(node,maxLevel){var leaves=[],levelsToShow=maxLevel||Number.MAX_VALUE;this.each(node,function(elem,i){if(i<levelsToShow&&(!elem.children||elem.children.length==0)){leaves.push({'node':elem,'level':levelsToShow-i});}});return leaves;},eachLevel:function(tree,initLevel,toLevel,action){if(initLevel<=toLevel){action(tree,initLevel);for(var i=0,ch=tree.children;i<ch.length;i++){this.eachLevel(ch[i],initLevel+1,toLevel,action);}}},each:function(tree,action){this.eachLevel(tree,0,Number.MAX_VALUE,action);},loadSubtrees:function(tree,controller){var maxLevel=controller.request&&controller.levelsToShow;var leaves=this.getLeaves(tree,maxLevel),len=leaves.length,selectedNode={};if(len==0)controller.onComplete();for(var i=0,counter=0;i<len;i++){var leaf=leaves[i],id=leaf.node.id;selectedNode[id]=leaf.node;controller.request(id,leaf.level,{onComplete:function(nodeId,tree){var ch=tree.children;selectedNode[nodeId].children=ch;if(++counter==len){controller.onComplete();}}});}}};this.Canvas=(function(){var config={'injectInto':'id','width':200,'height':200,'backgroundColor':'#333333','styles':{'fillStyle':'#000000','strokeStyle':'#000000'},'backgroundCanvas':false};function hasCanvas(){hasCanvas.t=hasCanvas.t||typeof(HTMLCanvasElement);return"function"==hasCanvas.t||"object"==hasCanvas.t;};function create(tag,prop,styles){var elem=document.createElement(tag);(function(obj,prop){if(prop){for(var p in prop){obj[p]=prop[p];}}
return arguments.callee;})(elem,prop)(elem.style,styles);if(tag=="canvas"&&!hasCanvas()&&G_vmlCanvasManager){elem=G_vmlCanvasManager.initElement(document.body.appendChild(elem));}
return elem;};function get(id){return document.getElementById(id);};function translateToCenter(canvas,ctx,w,h){var width=w?(canvas.width-w):canvas.width;var height=h?(canvas.height-h):canvas.height;ctx.translate(width/2,height/2);};return function(id,opt){var ctx,bkctx,mainContainer,labelContainer,canvas,bkcanvas;if(arguments.length<1)
throw"Arguments missing";var idLabel=id+"-label",idCanvas=id+"-canvas",idBCanvas=id+"-bkcanvas";opt=$merge(config,opt||{});var dim={'width':opt.width,'height':opt.height};mainContainer=create("div",{'id':id},$merge(dim,{'position':'relative'}));labelContainer=create("div",{'id':idLabel},{'overflow':'visible','position':'absolute','top':0,'left':0,'width':dim.width+'px','height':0});var dimPos={'position':'absolute','top':0,'left':0,'width':dim.width+'px','height':dim.height+'px'};canvas=create("canvas",$merge({'id':idCanvas},dim),dimPos);var bc=opt.backgroundCanvas;if(bc){bkcanvas=create("canvas",$merge({'id':idBCanvas},dim),dimPos);mainContainer.appendChild(bkcanvas);}
mainContainer.appendChild(canvas);mainContainer.appendChild(labelContainer);get(opt.injectInto).appendChild(mainContainer);ctx=canvas.getContext('2d');translateToCenter(canvas,ctx);var st=opt.styles;var s;for(s in st)
ctx[s]=st[s];if(bc){bkctx=bkcanvas.getContext('2d');st=bc.styles;for(s in st){bkctx[s]=st[s];}
translateToCenter(bkcanvas,bkctx);bc.impl.init(bkcanvas,bkctx);bc.impl.plot(bkcanvas,bkctx);}
return{'id':id,getCtx:function(){return ctx;},getElement:function(){return mainContainer;},resize:function(width,height){var pwidth=canvas.width,pheight=canvas.height;canvas.width=width;canvas.height=height;canvas.style.width=width+"px";canvas.style.height=height+"px";if(bc){bkcanvas.width=width;bkcanvas.height=height;bkcanvas.style.width=width+"px";bkcanvas.style.height=height+"px";}
if(!hasCanvas()){translateToCenter(canvas,ctx,pwidth,pheight);}else{translateToCenter(canvas,ctx);}
var st=opt.styles;var s;for(s in st){ctx[s]=st[s];}
if(bc){st=bc.styles;for(s in st)
bkctx[s]=st[s];if(!hasCanvas()){translateToCenter(bkcanvas,bkctx,pwidth,pheight);}else{translateToCenter(bkcanvas,bkctx);}
bc.impl.init(bkcanvas,bkctx);bc.impl.plot(bkcanvas,bkctx);}},getSize:function(){return{'width':canvas.width,'height':canvas.height};},path:function(type,action){ctx.beginPath();action(ctx);ctx[type]();ctx.closePath();},clear:function(){var size=this.getSize();ctx.clearRect(-size.width/2,-size.height/2,size.width,size.height);},clearRectangle:function(top,right,bottom,left){if(!hasCanvas()){var f0=ctx.fillStyle;ctx.fillStyle=opt.backgroundColor;ctx.fillRect(left,top,Math.abs(right-left),Math.abs(bottom-top));ctx.fillStyle=f0;}
else{ctx.clearRect(left,top,Math.abs(right-left),Math.abs(bottom-top));}}};};})();this.Polar=function(theta,rho){this.theta=theta;this.rho=rho;};Polar.prototype={getc:function(simple){return this.toComplex(simple);},getp:function(){return this;},set:function(v){v=v.getp();this.theta=v.theta;this.rho=v.rho;},setc:function(x,y){this.rho=Math.sqrt(x*x+y*y);this.theta=Math.atan2(y,x);if(this.theta<0)this.theta+=Math.PI*2;},setp:function(theta,rho){this.theta=theta;this.rho=rho;},clone:function(){return new Polar(this.theta,this.rho);},toComplex:function(simple){var x=Math.cos(this.theta)*this.rho;var y=Math.sin(this.theta)*this.rho;if(simple)return{'x':x,'y':y};return new Complex(x,y);},add:function(polar){return new Polar(this.theta+polar.theta,this.rho+polar.rho);},scale:function(number){return new Polar(this.theta,this.rho*number);},equals:function(c){return this.theta==c.theta&&this.rho==c.rho;},$add:function(polar){this.theta=this.theta+polar.theta;this.rho+=polar.rho;return this;},$madd:function(polar){this.theta=(this.theta+polar.theta)%(Math.PI*2);this.rho+=polar.rho;return this;},$scale:function(number){this.rho*=number;return this;},interpolate:function(elem,delta){var pi=Math.PI,pi2=pi*2;var ch=function(t){return(t<0)?(t%pi2)+pi2:t%pi2;};var tt=this.theta,et=elem.theta;var sum;if(Math.abs(tt-et)>pi){if(tt>et){sum=ch((et+((tt-pi2)-et)*delta));}else{sum=ch((et-pi2+(tt-(et-pi2))*delta));}}else{sum=ch((et+(tt-et)*delta));}
var r=(this.rho-elem.rho)*delta+elem.rho;return{'theta':sum,'rho':r};}};var $P=function(a,b){return new Polar(a,b);};Polar.KER=$P(0,0);this.Complex=function(x,y){this.x=x;this.y=y;};Complex.prototype={getc:function(){return this;},getp:function(simple){return this.toPolar(simple);},set:function(c){c=c.getc(true);this.x=c.x;this.y=c.y;},setc:function(x,y){this.x=x;this.y=y;},setp:function(theta,rho){this.x=Math.cos(theta)*rho;this.y=Math.sin(theta)*rho;},clone:function(){return new Complex(this.x,this.y);},toPolar:function(simple){var rho=this.norm();var atan=Math.atan2(this.y,this.x);if(atan<0)atan+=Math.PI*2;if(simple)return{'theta':atan,'rho':rho};return new Polar(atan,rho);},norm:function(){return Math.sqrt(this.squaredNorm());},squaredNorm:function(){return this.x*this.x+this.y*this.y;},add:function(pos){return new Complex(this.x+pos.x,this.y+pos.y);},prod:function(pos){return new Complex(this.x*pos.x-this.y*pos.y,this.y*pos.x+this.x*pos.y);},conjugate:function(){return new Complex(this.x,-this.y);},scale:function(factor){return new Complex(this.x*factor,this.y*factor);},equals:function(c){return this.x==c.x&&this.y==c.y;},$add:function(pos){this.x+=pos.x;this.y+=pos.y;return this;},$prod:function(pos){var x=this.x,y=this.y;this.x=x*pos.x-y*pos.y;this.y=y*pos.x+x*pos.y;return this;},$conjugate:function(){this.y=-this.y;return this;},$scale:function(factor){this.x*=factor;this.y*=factor;return this;},$div:function(pos){var x=this.x,y=this.y;var sq=pos.squaredNorm();this.x=x*pos.x+y*pos.y;this.y=y*pos.x-x*pos.y;return this.$scale(1/sq);}};var $C=function(a,b){return new Complex(a,b);};Complex.KER=$C(0,0);this.Graph=new Class({initialize:function(opt){var innerOptions={'complex':false,'Node':{}};this.opt=$merge(innerOptions,opt||{});this.nodes={};},getNode:function(id){if(this.hasNode(id))return this.nodes[id];return false;},getAdjacence:function(id,id2){var adjs=[];if(this.hasNode(id)&&this.hasNode(id2)&&this.nodes[id].adjacentTo({'id':id2})&&this.nodes[id2].adjacentTo({'id':id})){adjs.push(this.nodes[id].getAdjacency(id2));adjs.push(this.nodes[id2].getAdjacency(id));return adjs;}
return false;},addNode:function(obj){if(!this.nodes[obj.id]){this.nodes[obj.id]=new Graph.Node($extend({'id':obj.id,'name':obj.name,'data':obj.data},this.opt.Node),this.opt.complex);}
return this.nodes[obj.id];},addAdjacence:function(obj,obj2,data){var adjs=[];if(!this.hasNode(obj.id)){this.addNode(obj);}
if(!this.hasNode(obj2.id)){this.addNode(obj2);}
obj=this.nodes[obj.id];obj2=this.nodes[obj2.id];for(var i in this.nodes){if(this.nodes[i].id==obj.id){if(!this.nodes[i].adjacentTo(obj2)){adjs.push(this.nodes[i].addAdjacency(obj2,data));}}
if(this.nodes[i].id==obj2.id){if(!this.nodes[i].adjacentTo(obj)){adjs.push(this.nodes[i].addAdjacency(obj,data));}}}
return adjs;},removeNode:function(id){if(this.hasNode(id)){var node=this.nodes[id];for(var i=0 in node.adjacencies){var adj=node.adjacencies[i];this.removeAdjacence(id,adj.nodeTo.id);}
delete this.nodes[id];}},removeAdjacence:function(id1,id2){if(this.hasNode(id1))this.nodes[id1].removeAdjacency(id2);if(this.hasNode(id2))this.nodes[id2].removeAdjacency(id1);},hasNode:function(id){return id in this.nodes;}});Graph.Node=new Class({initialize:function(opt,complex){var innerOptions={'id':'','name':'','data':{},'adjacencies':{},'selected':false,'drawn':false,'exist':false,'angleSpan':{'begin':0,'end':0},'alpha':1,'startAlpha':1,'endAlpha':1,'pos':(complex&&$C(0,0))||$P(0,0),'startPos':(complex&&$C(0,0))||$P(0,0),'endPos':(complex&&$C(0,0))||$P(0,0)};$extend(this,$extend(innerOptions,opt));},adjacentTo:function(node){return node.id in this.adjacencies;},getAdjacency:function(id){return this.adjacencies[id];},addAdjacency:function(node,data){var adj=new Graph.Adjacence(this,node,data);return this.adjacencies[node.id]=adj;},removeAdjacency:function(id){delete this.adjacencies[id];}});Graph.Adjacence=function(nodeFrom,nodeTo,data){this.nodeFrom=nodeFrom;this.nodeTo=nodeTo;this.data=data||{};this.alpha=1;this.startAlpha=1;this.endAlpha=1;};Graph.Util={filter:function(param){if(!param||!($type(param)=='string'))return function(){return true;};var props=param.split(" ");return function(elem){for(var i=0;i<props.length;i++){if(elem[props[i]]){return false;}}
return true;};},getNode:function(graph,id){return graph.getNode(id);},eachNode:function(graph,action,flags){var filter=this.filter(flags);for(var i in graph.nodes){if(filter(graph.nodes[i]))action(graph.nodes[i]);}},eachAdjacency:function(node,action,flags){var adj=node.adjacencies,filter=this.filter(flags);for(var id in adj){if(filter(adj[id])){action(adj[id],id);}}},computeLevels:function(graph,id,startDepth,flags){startDepth=startDepth||0;var filter=this.filter(flags);this.eachNode(graph,function(elem){elem._flag=false;elem._depth=-1;},flags);var root=graph.getNode(id);root._depth=startDepth;var queue=[root];while(queue.length!=0){var node=queue.pop();node._flag=true;this.eachAdjacency(node,function(adj){var n=adj.nodeTo;if(n._flag==false&&filter(n)){if(n._depth<0)n._depth=node._depth+1+startDepth;queue.unshift(n);}},flags);}},eachBFS:function(graph,id,action,flags){var filter=this.filter(flags);this.clean(graph);var queue=[graph.getNode(id)];while(queue.length!=0){var node=queue.pop();node._flag=true;action(node,node._depth);this.eachAdjacency(node,function(adj){var n=adj.nodeTo;if(n._flag==false&&filter(n)){n._flag=true;queue.unshift(n);}},flags);}},eachLevel:function(node,levelBegin,levelEnd,action,flags){var d=node._depth,filter=this.filter(flags),that=this;levelEnd=levelEnd===false?Number.MAX_VALUE-d:levelEnd;(function loopLevel(node,levelBegin,levelEnd){var d=node._depth;if(d>=levelBegin&&d<=levelEnd&&filter(node))action(node,d);if(d<levelEnd){that.eachAdjacency(node,function(adj){var n=adj.nodeTo;if(n._depth>d)loopLevel(n,levelBegin,levelEnd);});}})(node,levelBegin+d,levelEnd+d);},eachSubgraph:function(node,action,flags){this.eachLevel(node,0,false,action,flags);},eachSubnode:function(node,action,flags){this.eachLevel(node,1,1,action,flags);},anySubnode:function(node,cond,flags){var flag=false;cond=cond||$lambda(true);var c=$type(cond)=='string'?function(n){return n[cond];}:cond;this.eachSubnode(node,function(elem){if(c(elem))flag=true;},flags);return flag;},getSubnodes:function(node,level,flags){var ans=[],that=this;level=level||0;var levelStart,levelEnd;if($type(level)=='array'){levelStart=level[0];levelEnd=level[1];}else{levelStart=level;levelEnd=Number.MAX_VALUE-node._depth;}
this.eachLevel(node,levelStart,levelEnd,function(n){ans.push(n);},flags);return ans;},getParents:function(node){var ans=[];this.eachAdjacency(node,function(adj){var n=adj.nodeTo;if(n._depth<node._depth)ans.push(n);});return ans;},isDescendantOf:function(node,id){if(node.id==id)return true;var pars=this.getParents(node),ans=false;for(var i=0;!ans&&i<pars.length;i++){ans=ans||this.isDescendantOf(pars[i],id);}
return ans;},clean:function(graph){this.eachNode(graph,function(elem){elem._flag=false;});}};Graph.Op={options:{type:'nothing',duration:2000,hideLabels:true,fps:30},removeNode:function(node,opt){var viz=this.viz;var options=$merge(this.options,viz.controller,opt);var n=$splat(node);var i,that,nodeObj;switch(options.type){case'nothing':for(i=0;i<n.length;i++)viz.graph.removeNode(n[i]);break;case'replot':this.removeNode(n,{type:'nothing'});viz.fx.clearLabels();viz.refresh(true);break;case'fade:seq':case'fade':that=this;for(i=0;i<n.length;i++){nodeObj=viz.graph.getNode(n[i]);nodeObj.endAlpha=0;}
viz.fx.animate($merge(options,{modes:['fade:nodes'],onComplete:function(){that.removeNode(n,{type:'nothing'});viz.fx.clearLabels();viz.reposition();viz.fx.animate($merge(options,{modes:['linear']}));}}));break;case'fade:con':that=this;for(i=0;i<n.length;i++){nodeObj=viz.graph.getNode(n[i]);nodeObj.endAlpha=0;nodeObj.ignore=true;}
viz.reposition();viz.fx.animate($merge(options,{modes:['fade:nodes','linear'],onComplete:function(){that.removeNode(n,{type:'nothing'});}}));break;case'iter':that=this;viz.fx.sequence({condition:function(){return n.length!=0;},step:function(){that.removeNode(n.shift(),{type:'nothing'});viz.fx.clearLabels();},onComplete:function(){options.onComplete();},duration:Math.ceil(options.duration/n.length)});break;default:this.doError();}},removeEdge:function(vertex,opt){var viz=this.viz;var options=$merge(this.options,viz.controller,opt);var v=($type(vertex[0])=='string')?[vertex]:vertex;var i,that,adjs;switch(options.type){case'nothing':for(i=0;i<v.length;i++)viz.graph.removeAdjacence(v[i][0],v[i][1]);break;case'replot':this.removeEdge(v,{type:'nothing'});viz.refresh(true);break;case'fade:seq':case'fade':that=this;for(i=0;i<v.length;i++){adjs=viz.graph.getAdjacence(v[i][0],v[i][1]);if(adjs){adjs[0].endAlpha=0;adjs[1].endAlpha=0;}}
viz.fx.animate($merge(options,{modes:['fade:vertex'],onComplete:function(){that.removeEdge(v,{type:'nothing'});viz.reposition();viz.fx.animate($merge(options,{modes:['linear']}));}}));break;case'fade:con':that=this;for(i=0;i<v.length;i++){adjs=viz.graph.getAdjacence(v[i][0],v[i][1]);if(adjs){adjs[0].endAlpha=0;adjs[0].ignore=true;adjs[1].endAlpha=0;adjs[1].ignore=true;}}
viz.reposition();viz.fx.animate($merge(options,{modes:['fade:vertex','linear'],onComplete:function(){that.removeEdge(v,{type:'nothing'});}}));break;case'iter':that=this;viz.fx.sequence({condition:function(){return v.length!=0;},step:function(){that.removeEdge(v.shift(),{type:'nothing'});viz.fx.clearLabels();},onComplete:function(){options.onComplete();},duration:Math.ceil(options.duration/v.length)});break;default:this.doError();}},sum:function(json,opt){var viz=this.viz;var options=$merge(this.options,viz.controller,opt),root=viz.root;var GUtil,graph;viz.root=opt.id||viz.root;switch(options.type){case'nothing':graph=viz.construct(json);GUtil=Graph.Util;GUtil.eachNode(graph,function(elem){GUtil.eachAdjacency(elem,function(adj){viz.graph.addAdjacence(adj.nodeFrom,adj.nodeTo,adj.data);});});break;case'replot':viz.refresh(true);this.sum(json,{type:'nothing'});viz.refresh(true);break;case'fade:seq':case'fade':case'fade:con':GUtil=Graph.Util;that=this;graph=viz.construct(json);var fadeEdges=this.preprocessSum(graph);var modes=!fadeEdges?['fade:nodes']:['fade:nodes','fade:vertex'];viz.reposition();if(options.type!='fade:con'){viz.fx.animate($merge(options,{modes:['linear'],onComplete:function(){viz.fx.animate($merge(options,{modes:modes,onComplete:function(){options.onComplete();}}));}}));}else{GUtil.eachNode(viz.graph,function(elem){if(elem.id!=root&&elem.pos.getp().equals(Polar.KER)){elem.pos.set(elem.endPos);elem.startPos.set(elem.endPos);}});viz.fx.animate($merge(options,{modes:['linear'].concat(modes)}));}
break;default:this.doError();}},morph:function(json,opt){var viz=this.viz;var options=$merge(this.options,viz.controller,opt),root=viz.root;var GUtil,graph;viz.root=opt.id||viz.root;switch(options.type){case'nothing':graph=viz.construct(json);GUtil=Graph.Util;GUtil.eachNode(graph,function(elem){GUtil.eachAdjacency(elem,function(adj){viz.graph.addAdjacence(adj.nodeFrom,adj.nodeTo,adj.data);});});GUtil.eachNode(viz.graph,function(elem){GUtil.eachAdjacency(elem,function(adj){if(!graph.getAdjacence(adj.nodeFrom.id,adj.nodeTo.id)){viz.graph.removeAdjacence(adj.nodeFrom.id,adj.nodeTo.id);}});if(!graph.hasNode(elem.id))viz.graph.removeNode(elem.id);});break;case'replot':viz.fx.clearLabels(true);this.morph(json,{type:'nothing'});viz.refresh(true);viz.refresh(true);break;case'fade:seq':case'fade':case'fade:con':GUtil=Graph.Util;that=this;graph=viz.construct(json);var fadeEdges=this.preprocessSum(graph);GUtil.eachNode(viz.graph,function(elem){if(!graph.hasNode(elem.id)){elem.alpha=1;elem.startAlpha=1;elem.endAlpha=0;elem.ignore=true;}});GUtil.eachNode(viz.graph,function(elem){if(elem.ignore)return;GUtil.eachAdjacency(elem,function(adj){if(adj.nodeFrom.ignore||adj.nodeTo.ignore)return;var nodeFrom=graph.getNode(adj.nodeFrom.id);var nodeTo=graph.getNode(adj.nodeTo.id);if(!nodeFrom.adjacentTo(nodeTo)){var adjs=viz.graph.getAdjacence(nodeFrom.id,nodeTo.id);fadeEdges=true;adjs[0].alpha=1;adjs[0].startAlpha=1;adjs[0].endAlpha=0;adjs[0].ignore=true;adjs[1].alpha=1;adjs[1].startAlpha=1;adjs[1].endAlpha=0;adjs[1].ignore=true;}});});var modes=!fadeEdges?['fade:nodes']:['fade:nodes','fade:vertex'];viz.reposition();GUtil.eachNode(viz.graph,function(elem){if(elem.id!=root&&elem.pos.getp().equals(Polar.KER)){elem.pos.set(elem.endPos);elem.startPos.set(elem.endPos);}});viz.fx.animate($merge(options,{modes:['polar'].concat(modes),onComplete:function(){GUtil.eachNode(viz.graph,function(elem){if(elem.ignore)viz.graph.removeNode(elem.id);});GUtil.eachNode(viz.graph,function(elem){GUtil.eachAdjacency(elem,function(adj){if(adj.ignore)viz.graph.removeAdjacence(adj.nodeFrom.id,adj.nodeTo.id);});});options.onComplete();}}));break;default:this.doError();}},preprocessSum:function(graph){var viz=this.viz;var GUtil=Graph.Util;GUtil.eachNode(graph,function(elem){if(!viz.graph.hasNode(elem.id)){viz.graph.addNode(elem);var n=viz.graph.getNode(elem.id);n.alpha=0;n.startAlpha=0;n.endAlpha=1;}});var fadeEdges=false;GUtil.eachNode(graph,function(elem){GUtil.eachAdjacency(elem,function(adj){var nodeFrom=viz.graph.getNode(adj.nodeFrom.id);var nodeTo=viz.graph.getNode(adj.nodeTo.id);if(!nodeFrom.adjacentTo(nodeTo)){var adjs=viz.graph.addAdjacence(nodeFrom,nodeTo,adj.data);if(nodeFrom.startAlpha==nodeFrom.endAlpha&&nodeTo.startAlpha==nodeTo.endAlpha){fadeEdges=true;adjs[0].alpha=0;adjs[0].startAlpha=0;adjs[0].endAlpha=1;adjs[1].alpha=0;adjs[1].startAlpha=0;adjs[1].endAlpha=1;}}});});return fadeEdges;}};Graph.Plot={Interpolator:{'moebius':function(elem,delta,vector){if(delta<=1||vector.norm()<=1){var x=vector.x,y=vector.y;var ans=elem.startPos.getc().moebiusTransformation(vector);elem.pos.setc(ans.x,ans.y);vector.x=x;vector.y=y;}},'linear':function(elem,delta){var from=elem.startPos.getc(true);var to=elem.endPos.getc(true);elem.pos.setc((to.x-from.x)*delta+from.x,(to.y-from.y)*delta+from.y);},'fade:nodes':function(elem,delta){if(delta<=1&&(elem.endAlpha!=elem.alpha)){var from=elem.startAlpha;var to=elem.endAlpha;elem.alpha=from+(to-from)*delta;}},'fade:vertex':function(elem,delta){var adjs=elem.adjacencies;for(var id in adjs)this['fade:nodes'](adjs[id],delta);},'polar':function(elem,delta){var from=elem.startPos.getp(true);var to=elem.endPos.getp();var ans=to.interpolate(from,delta);elem.pos.setp(ans.theta,ans.rho);}},labelsHidden:false,labelContainer:false,labels:{},getLabelContainer:function(){return this.labelContainer?this.labelContainer:this.labelContainer=document.getElementById(this.viz.config.labelContainer);},getLabel:function(id){return(id in this.labels&&this.labels[id]!=null)?this.labels[id]:this.labels[id]=document.getElementById(id);},hideLabels:function(hide){var container=this.getLabelContainer();if(hide)container.style.display='none';else container.style.display='';this.labelsHidden=hide;},clearLabels:function(force){for(var id in this.labels){if(force||!this.viz.graph.hasNode(id)){this.disposeLabel(id);delete this.labels[id];}}},disposeLabel:function(id){var elem=this.getLabel(id);if(elem&&elem.parentNode){elem.parentNode.removeChild(elem);}},hideLabel:function(node,flag){node=$splat(node);var st=flag?"":"none",lab,that=this;$each(node,function(n){var lab=that.getLabel(n.id);if(lab){lab.style.display=st;}});},sequence:function(options){var that=this;options=$merge({condition:$lambda(false),step:$empty,onComplete:$empty,duration:200},options||{});var interval=setInterval(function(){if(options.condition()){options.step();}else{clearInterval(interval);options.onComplete();}
that.viz.refresh(true);},options.duration);},animate:function(opt,versor){var that=this,viz=this.viz,graph=viz.graph,GUtil=Graph.Util;opt=$merge(viz.controller,opt||{});if(opt.hideLabels)this.hideLabels(true);this.animation.setOptions($merge(opt,{$animating:false,compute:function(delta){var vector=versor?versor.scale(-delta):null;GUtil.eachNode(graph,function(node){for(var i=0;i<opt.modes.length;i++){that.Interpolator[opt.modes[i]](node,delta,vector);}});that.plot(opt,this.$animating);this.$animating=true;},complete:function(){GUtil.eachNode(graph,function(node){node.startPos.set(node.pos);node.startAlpha=node.alpha;});if(opt.hideLabels)that.hideLabels(false);that.plot(opt);opt.onComplete();opt.onAfterCompute();}})).start();},plot:function(opt,animating){var viz=this.viz,aGraph=viz.graph,canvas=viz.canvas,id=viz.root,that=this,ctx=canvas.getCtx(),GUtil=Graph.Util;opt=opt||this.viz.controller;opt.clearCanvas&&canvas.clear();var T=!!aGraph.getNode(id).visited;GUtil.eachNode(aGraph,function(node){GUtil.eachAdjacency(node,function(adj){var nodeTo=adj.nodeTo;if(!!nodeTo.visited===T&&node.drawn&&nodeTo.drawn){!animating&&opt.onBeforePlotLine(adj);ctx.save();ctx.globalAlpha=Math.min(Math.min(node.alpha,nodeTo.alpha),adj.alpha);that.plotLine(adj,canvas,animating);ctx.restore();!animating&&opt.onAfterPlotLine(adj);}});ctx.save();if(node.drawn){ctx.globalAlpha=node.alpha;!animating&&opt.onBeforePlotNode(node);that.plotNode(node,canvas,animating);!animating&&opt.onAfterPlotNode(node);}
if(!that.labelsHidden&&opt.withLabels){if(node.drawn&&ctx.globalAlpha>=0.95){that.plotLabel(canvas,node,opt);}else{that.hideLabel(node,false);}}
ctx.restore();node.visited=!T;});},plotLabel:function(canvas,node,controller){var id=node.id,tag=this.getLabel(id);if(!tag&&!(tag=document.getElementById(id))){tag=document.createElement('div');var container=this.getLabelContainer();container.appendChild(tag);tag.id=id;tag.className='node';tag.style.position='absolute';controller.onCreateLabel(tag,node);this.labels[node.id]=tag;}
this.placeLabel(tag,node,controller);},plotNode:function(node,canvas,animating){var nconfig=this.node,data=node.data;var cond=nconfig.overridable&&data;var width=cond&&data.$lineWidth||nconfig.lineWidth;var color=cond&&data.$color||nconfig.color;var ctx=canvas.getCtx();ctx.lineWidth=width;ctx.fillStyle=color;ctx.strokeStyle=color;var f=node.data&&node.data.$type||nconfig.type;this.nodeTypes[f].call(this,node,canvas,animating);},plotLine:function(adj,canvas,animating){var econfig=this.edge,data=adj.data;var cond=econfig.overridable&&data;var width=cond&&data.$lineWidth||econfig.lineWidth;var color=cond&&data.$color||econfig.color;var ctx=canvas.getCtx();ctx.lineWidth=width;ctx.fillStyle=color;ctx.strokeStyle=color;var f=adj.data&&adj.data.$type||econfig.type;this.edgeTypes[f].call(this,adj,canvas,animating);},fitsInCanvas:function(pos,canvas){var size=canvas.getSize();if(pos.x>=size.width||pos.x<0||pos.y>=size.height||pos.y<0)return false;return true;}};var Loader={construct:function(json){var isGraph=($type(json)=='array');var ans=new Graph(this.graphOptions);if(!isGraph)
(function(ans,json){ans.addNode(json);for(var i=0,ch=json.children;i<ch.length;i++){ans.addAdjacence(json,ch[i]);arguments.callee(ans,ch[i]);}})(ans,json);else
(function(ans,json){var getNode=function(id){for(var w=0;w<json.length;w++){if(json[w].id==id){return json[w];}}
return undefined;};for(var i=0;i<json.length;i++){ans.addNode(json[i]);for(var j=0,adj=json[i].adjacencies;j<adj.length;j++){var node=adj[j],data;if(typeof adj[j]!='string'){data=node.data;node=node.nodeTo;}
ans.addAdjacence(json[i],getNode(node),data);}}})(ans,json);return ans;},loadJSON:function(json,i){this.json=json;this.graph=this.construct(json);if($type(json)!='array'){this.root=json.id;}else{this.root=json[i?i:0].id;}}};this.Trans={linear:function(p){return p;}};(function(){var makeTrans=function(transition,params){params=$splat(params);return $extend(transition,{easeIn:function(pos){return transition(pos,params);},easeOut:function(pos){return 1-transition(1-pos,params);},easeInOut:function(pos){return(pos<=0.5)?transition(2*pos,params)/2:(2-transition(2*(1-pos),params))/2;}});};var transitions={Pow:function(p,x){return Math.pow(p,x[0]||6);},Expo:function(p){return Math.pow(2,8*(p-1));},Circ:function(p){return 1-Math.sin(Math.acos(p));},Sine:function(p){return 1-Math.sin((1-p)*Math.PI/2);},Back:function(p,x){x=x[0]||1.618;return Math.pow(p,2)*((x+1)*p-x);},Bounce:function(p){var value;for(var a=0,b=1;1;a+=b,b/=2){if(p>=(7-4*a)/11){value=b*b-Math.pow((11-6*a-11*p)/4,2);break;}}
return value;},Elastic:function(p,x){return Math.pow(2,10*--p)*Math.cos(20*p*Math.PI*(x[0]||1)/3);}};$each(transitions,function(val,key){Trans[key]=makeTrans(val);});$each(['Quad','Cubic','Quart','Quint'],function(elem,i){Trans[elem]=makeTrans(function(p){return Math.pow(p,[i+2]);});});})();var Animation=new Class({initalize:function(options){this.setOptions(options);},setOptions:function(options){var opt={duration:2500,fps:40,transition:Trans.Quart.easeInOut,compute:$empty,complete:$empty};this.opt=$merge(opt,options||{});return this;},getTime:function(){return $time();},step:function(){var time=this.getTime(),opt=this.opt;if(time<this.time+opt.duration){var delta=opt.transition((time-this.time)/opt.duration);opt.compute(delta);}else{this.timer=clearInterval(this.timer);opt.compute(1);opt.complete();}},start:function(){this.time=0;this.startTimer();return this;},startTimer:function(){var that=this,opt=this.opt;if(this.timer)return false;this.time=this.getTime()-this.time;this.timer=setInterval((function(){that.step();}),Math.round(1000/opt.fps));return true;}});(function(){var slice=Array.prototype.slice;function getBoundaries(graph,config,level,orn){var dim=config.Node,GUtil=Graph.Util;var multitree=config.multitree;if(dim.overridable){var w=-1,h=-1;GUtil.eachNode(graph,function(n){if(n._depth==level&&(!multitree||('$orn'in n.data)&&n.data.$orn==orn)){var dw=n.data.$width||dim.width;var dh=n.data.$height||dim.height;w=(w<dw)?dw:w;h=(h<dh)?dh:h;}});return{'width':w<0?dim.width:w,'height':h<0?dim.height:h};}else{return dim;}};function movetree(node,prop,val,orn){var p=(orn=="left"||orn=="right")?"y":"x";node[prop][p]+=val;};function moveextent(extent,val){var ans=[];$each(extent,function(elem){elem=slice.call(elem);elem[0]+=val;elem[1]+=val;ans.push(elem);});return ans;};function merge(ps,qs){if(ps.length==0)return qs;if(qs.length==0)return ps;var p=ps.shift(),q=qs.shift();return[[p[0],q[1]]].concat(merge(ps,qs));};function mergelist(ls,def){def=def||[];if(ls.length==0)return def;var ps=ls.pop();return mergelist(ls,merge(ps,def));};function fit(ext1,ext2,subtreeOffset,siblingOffset,i){if(ext1.length<=i||ext2.length<=i)return 0;var p=ext1[i][1],q=ext2[i][0];return Math.max(fit(ext1,ext2,subtreeOffset,siblingOffset,++i)
+subtreeOffset,p-q+siblingOffset);};function fitlistl(es,subtreeOffset,siblingOffset){function $fitlistl(acc,es,i){if(es.length<=i)return[];var e=es[i],ans=fit(acc,e,subtreeOffset,siblingOffset,0);return[ans].concat($fitlistl(merge(acc,moveextent(e,ans)),es,++i));};return $fitlistl([],es,0);};function fitlistr(es,subtreeOffset,siblingOffset){function $fitlistr(acc,es,i){if(es.length<=i)return[];var e=es[i],ans=-fit(e,acc,subtreeOffset,siblingOffset,0);return[ans].concat($fitlistr(merge(moveextent(e,ans),acc),es,++i));};es=slice.call(es);var ans=$fitlistr([],es.reverse(),0);return ans.reverse();};function fitlist(es,subtreeOffset,siblingOffset,align){var esl=fitlistl(es,subtreeOffset,siblingOffset),esr=fitlistr(es,subtreeOffset,siblingOffset);if(align=="left")
esr=esl;else if(align=="right")
esl=esr;for(var i=0,ans=[];i<esl.length;i++){ans[i]=(esl[i]+esr[i])/2;}
return ans;};function design(graph,node,prop,config,orn){var multitree=config.multitree;var auxp=['x','y'],auxs=['width','height'];var ind=+(orn=="left"||orn=="right");var p=auxp[ind],notp=auxp[1-ind];var cnode=config.Node;var s=auxs[ind],nots=auxs[1-ind];var siblingOffset=config.siblingOffset;var subtreeOffset=config.subtreeOffset;var align=config.align;var GUtil=Graph.Util;function $design(node,maxsize,acum){var sval=(cnode.overridable&&node.data["$"+s])||cnode[s];var notsval=maxsize||((cnode.overridable&&node.data["$"+nots])||cnode[nots]);var trees=[],extents=[],chmaxsize=false;var chacum=notsval+config.levelDistance;GUtil.eachSubnode(node,function(n){if(n.exist&&(!multitree||('$orn'in n.data)&&n.data.$orn==orn)){if(!chmaxsize)
chmaxsize=getBoundaries(graph,config,n._depth,orn);var s=$design(n,chmaxsize[nots],acum+chacum);trees.push(s.tree);extents.push(s.extent);}});var positions=fitlist(extents,subtreeOffset,siblingOffset,align);for(var i=0,ptrees=[],pextents=[];i<trees.length;i++){movetree(trees[i],prop,positions[i],orn);pextents.push(moveextent(extents[i],positions[i]));}
var resultextent=[[-sval/2,sval/2]].concat(mergelist(pextents));node[prop][p]=0;if(orn=="top"||orn=="left"){node[prop][notp]=acum;}else{node[prop][notp]=-acum;}
return{tree:node,extent:resultextent};};$design(node,false,0);};this.ST=(function(){var nodesInPath=[];function getNodesToHide(node){node=node||this.clickedNode;var Geom=this.geom,GUtil=Graph.Util;var graph=this.graph;var canvas=this.canvas;var level=node._depth,nodeArray=[];GUtil.eachNode(graph,function(n){if(n.exist&&!n.selected){if(GUtil.isDescendantOf(n,node.id)){if(n._depth<=level)nodeArray.push(n);}else{nodeArray.push(n);}}});var leafLevel=Geom.getRightLevelToShow(node,canvas);GUtil.eachLevel(node,leafLevel,leafLevel,function(n){if(n.exist&&!n.selected)nodeArray.push(n);});for(var i=0;i<nodesInPath.length;i++){var n=this.graph.getNode(nodesInPath[i]);if(!GUtil.isDescendantOf(n,node.id)){nodeArray.push(n);}}
return nodeArray;};function getNodesToShow(node){var nodeArray=[],GUtil=Graph.Util,config=this.config;node=node||this.clickedNode;GUtil.eachLevel(this.clickedNode,0,config.levelsToShow,function(n){if(config.multitree&&!('$orn'in n.data)&&GUtil.anySubnode(n,function(ch){return ch.exist&&!ch.drawn;})){nodeArray.push(n);}else if(n.drawn&&!GUtil.anySubnode(n,"drawn")){nodeArray.push(n);}});return nodeArray;};return new Class({Implements:Loader,initialize:function(canvas,controller){var innerController={onBeforeCompute:$empty,onAfterCompute:$empty,onCreateLabel:$empty,onPlaceLabel:$empty,onComplete:$empty,onBeforePlotNode:$empty,onAfterPlotNode:$empty,onBeforePlotLine:$empty,onAfterPlotLine:$empty,request:false};var config={orientation:"left",labelContainer:canvas.id+'-label',levelsToShow:2,subtreeOffset:8,siblingOffset:5,levelDistance:30,withLabels:true,clearCanvas:true,align:"center",indent:10,multitree:false,constrained:true,Node:{overridable:false,type:'rectangle',color:'#ccb',lineWidth:1,height:20,width:90,dim:15,align:"center"},Edge:{overridable:false,type:'line',color:'#ccc',dim:15,lineWidth:1},duration:700,fps:25,transition:Trans.Quart.easeInOut};this.controller=this.config=$merge(config,innerController,controller);this.canvas=canvas;this.graphOptions={'complex':true};this.graph=new Graph(this.graphOptions);this.fx=new ST.Plot(this);this.op=new ST.Op(this);this.group=new ST.Group(this);this.geom=new ST.Geom(this);this.clickedNode=null;},plot:function(){this.fx.plot(this.controller);},switchPosition:function(pos,method,onComplete){var Geom=this.geom,Plot=this.fx,that=this;if(!Plot.busy){Plot.busy=true;this.contract({onComplete:function(){Geom.switchOrientation(pos);that.compute('endPos',false);Plot.busy=false;if(method=='animate'){that.onClick(that.clickedNode.id,onComplete);}else if(method=='replot'){that.select(that.clickedNode.id,onComplete);}}},pos);}},switchAlignment:function(align,method,onComplete){this.config.align=align;if(method=='animate'){this.select(this.clickedNode.id,onComplete);}else if(method=='replot'){this.onClick(this.clickedNode.id,onComplete);}},addNodeInPath:function(id){nodesInPath.push(id);this.select((this.clickedNode&&this.clickedNode.id)||this.root);},clearNodesInPath:function(id){nodesInPath.length=0;this.select((this.clickedNode&&this.clickedNode.id)||this.root);},refresh:function(){this.reposition();this.select((this.clickedNode&&this.clickedNode.id)||this.root);},reposition:function(){Graph.Util.computeLevels(this.graph,this.root,0,"ignore");this.geom.setRightLevelToShow(this.clickedNode,this.canvas);Graph.Util.eachNode(this.graph,function(n){if(n.exist)n.drawn=true;});this.compute('endPos');},compute:function(property,computeLevels){var prop=property||'startPos';var node=this.graph.getNode(this.root);$extend(node,{'drawn':true,'exist':true,'selected':true});if(!!computeLevels||!("_depth"in node))
Graph.Util.computeLevels(this.graph,this.root,0,"ignore");this.computePositions(node,prop);},computePositions:function(node,prop){var config=this.config;var multitree=config.multitree;var align=config.align;var indent=align!=='center'&&config.indent;var orn=config.orientation;var orns=multitree?['top','right','bottom','left']:[orn];var that=this;$each(orns,function(orn){design(that.graph,node,prop,that.config,orn);var i=['x','y'][+(orn=="left"||orn=="right")];(function red(node){Graph.Util.eachSubnode(node,function(n){if(n.exist&&(!multitree||('$orn'in n.data)&&n.data.$orn==orn)){n[prop][i]+=node[prop][i];if(indent){n[prop][i]+=align=='left'?indent:-indent;}
red(n);}});})(node);});},requestNodes:function(node,onComplete){var handler=$merge(this.controller,onComplete),lev=this.config.levelsToShow,GUtil=Graph.Util;if(handler.request){var leaves=[],d=node._depth;GUtil.eachLevel(node,0,lev,function(n){if(n.drawn&&!GUtil.anySubnode(n)){leaves.push(n);n._level=lev-(n._depth-d);}});this.group.requestNodes(leaves,handler);}
else
handler.onComplete();},contract:function(onComplete,switched){var orn=this.config.orientation;var Geom=this.geom,Group=this.group;if(switched)Geom.switchOrientation(switched);var nodes=getNodesToHide.call(this);if(switched)Geom.switchOrientation(orn);Group.contract(nodes,$merge(this.controller,onComplete));},move:function(node,onComplete){this.compute('endPos',false);var move=onComplete.Move,offset={'x':move.offsetX,'y':move.offsetY};if(move.enable){this.geom.translate(node.endPos.add(offset).$scale(-1),"endPos");}
this.fx.animate($merge(this.controller,{modes:['linear']},onComplete));},expand:function(node,onComplete){var nodeArray=getNodesToShow.call(this,node);this.group.expand(nodeArray,$merge(this.controller,onComplete));},selectPath:function(node){var GUtil=Graph.Util,that=this;GUtil.eachNode(this.graph,function(n){n.selected=false;});function path(node){if(node==null||node.selected)return;node.selected=true;$each(that.group.getSiblings([node])[node.id],function(n){n.exist=true;n.drawn=true;});var parents=GUtil.getParents(node);parents=(parents.length>0)?parents[0]:null;path(parents);};for(var i=0,ns=[node.id].concat(nodesInPath);i<ns.length;i++){path(this.graph.getNode(ns[i]));}},setRoot:function(id,method,onComplete){var that=this,canvas=this.canvas;var rootNode=this.graph.getNode(this.root);var clickedNode=this.graph.getNode(id);function $setRoot(){if(this.config.multitree&&clickedNode.data.$orn){var orn=clickedNode.data.$orn;var opp={'left':'right','right':'left','top':'bottom','bottom':'top'}[orn];rootNode.data.$orn=opp;(function tag(rootNode){Graph.Util.eachSubnode(rootNode,function(n){if(n.id!=id){n.data.$orn=opp;tag(n);}});})(rootNode);delete clickedNode.data.$orn;}
this.root=id;this.clickedNode=clickedNode;Graph.Util.computeLevels(this.graph,this.root,0,"ignore");}
delete rootNode.data.$orns;if(method=='animate'){this.onClick(id,{onBeforeMove:function(){$setRoot.call(that);that.selectPath(clickedNode);}});}else if(method=='replot'){$setRoot.call(this);this.select(this.root);}},addSubtree:function(subtree,method,onComplete){if(method=='replot'){this.op.sum(subtree,$extend({type:'replot'},onComplete||{}));}else if(method=='animate'){this.op.sum(subtree,$extend({type:'fade:seq'},onComplete||{}));}},removeSubtree:function(id,removeRoot,method,onComplete){var node=this.graph.getNode(id),subids=[];Graph.Util.eachLevel(node,+!removeRoot,false,function(n){subids.push(n.id);});if(method=='replot'){this.op.removeNode(subids,$extend({type:'replot'},onComplete||{}));}else if(method=='animate'){this.op.removeNode(subids,$extend({type:'fade:seq'},onComplete||{}));}},select:function(id,onComplete){var group=this.group,geom=this.geom;var node=this.graph.getNode(id),canvas=this.canvas;var root=this.graph.getNode(this.root);var complete=$merge(this.controller,onComplete);var that=this;complete.onBeforeCompute(node);this.selectPath(node);this.clickedNode=node;this.requestNodes(node,{onComplete:function(){group.hide(group.prepare(getNodesToHide.call(that)),complete);geom.setRightLevelToShow(node,canvas);that.compute("pos");Graph.Util.eachNode(that.graph,function(n){var pos=n.pos.getc(true);n.startPos.setc(pos.x,pos.y);n.endPos.setc(pos.x,pos.y);n.visited=false;});that.geom.translate(node.endPos.scale(-1),["pos","startPos","endPos"]);group.show(getNodesToShow.call(that));that.plot();complete.onAfterCompute(that.clickedNode);complete.onComplete();}});},onClick:function(id,options){var canvas=this.canvas,that=this,Fx=this.fx,Util=Graph.Util,Geom=this.geom;var innerController={Move:{enable:true,offsetX:0,offsetY:0},onBeforeRequest:$empty,onBeforeContract:$empty,onBeforeMove:$empty,onBeforeExpand:$empty};var complete=$merge(this.controller,innerController,options);if(!this.busy){this.busy=true;var node=this.graph.getNode(id);this.selectPath(node,this.clickedNode);this.clickedNode=node;complete.onBeforeCompute(node);complete.onBeforeRequest(node);this.requestNodes(node,{onComplete:function(){complete.onBeforeContract(node);that.contract({onComplete:function(){Geom.setRightLevelToShow(node,canvas);complete.onBeforeMove(node);that.move(node,{Move:complete.Move,onComplete:function(){complete.onBeforeExpand(node);that.expand(node,{onComplete:function(){that.busy=false;complete.onAfterCompute(id);complete.onComplete();}});}});}});}});}}});})();ST.Op=new Class({Implements:Graph.Op,initialize:function(viz){this.viz=viz;}});ST.Group=new Class({initialize:function(viz){this.viz=viz;this.canvas=viz.canvas;this.config=viz.config;this.animation=new Animation;this.nodes=null;},requestNodes:function(nodes,controller){var counter=0,len=nodes.length,nodeSelected={};var complete=function(){controller.onComplete();};var viz=this.viz;if(len==0)complete();for(var i=0;i<len;i++){nodeSelected[nodes[i].id]=nodes[i];controller.request(nodes[i].id,nodes[i]._level,{onComplete:function(nodeId,data){if(data&&data.children){data.id=nodeId;viz.op.sum(data,{type:'nothing'});}
if(++counter==len){Graph.Util.computeLevels(viz.graph,viz.root,0);complete();}}});}},contract:function(nodes,controller){var GUtil=Graph.Util;var viz=this.viz;var that=this;nodes=this.prepare(nodes);this.animation.setOptions($merge(controller,{$animating:false,compute:function(delta){if(delta==1)delta=0.99;that.plotStep(1-delta,controller,this.$animating);this.$animating='contract';},complete:function(){that.hide(nodes,controller);}})).start();},hide:function(nodes,controller){var GUtil=Graph.Util,viz=this.viz;for(var i=0;i<nodes.length;i++){if(true||!controller||!controller.request){GUtil.eachLevel(nodes[i],1,false,function(elem){if(elem.exist){$extend(elem,{'drawn':false,'exist':false});}});}else{var ids=[];GUtil.eachLevel(nodes[i],1,false,function(n){ids.push(n.id);});viz.op.removeNode(ids,{'type':'nothing'});viz.fx.clearLabels();}}
controller.onComplete();},expand:function(nodes,controller){var that=this,GUtil=Graph.Util;this.show(nodes);this.animation.setOptions($merge(controller,{$animating:false,compute:function(delta){that.plotStep(delta,controller,this.$animating);this.$animating='expand';},complete:function(){that.plotStep(undefined,controller,false);controller.onComplete();}})).start();},show:function(nodes){var GUtil=Graph.Util,config=this.config;this.prepare(nodes);$each(nodes,function(n){if(config.multitree&&!('$orn'in n.data)){delete n.data.$orns;var orns=' ';GUtil.eachSubnode(n,function(ch){if(('$orn'in ch.data)&&orns.indexOf(ch.data.$orn)<0&&ch.exist&&!ch.drawn){orns+=ch.data.$orn+' ';}});n.data.$orns=orns;}
GUtil.eachLevel(n,0,config.levelsToShow,function(n){if(n.exist)n.drawn=true;});});},prepare:function(nodes){this.nodes=this.getNodesWithChildren(nodes);return this.nodes;},getNodesWithChildren:function(nodes){var ans=[],GUtil=Graph.Util,config=this.config,root=this.viz.root;nodes.sort(function(a,b){return(a._depth<=b._depth)-(a._depth>=b._depth);});for(var i=0;i<nodes.length;i++){if(GUtil.anySubnode(nodes[i],"exist")){for(var j=i+1,desc=false;!desc&&j<nodes.length;j++){if(!config.multitree||'$orn'in nodes[j].data){desc=desc||GUtil.isDescendantOf(nodes[i],nodes[j].id);}}
if(!desc)ans.push(nodes[i]);}}
return ans;},plotStep:function(delta,controller,animating){var viz=this.viz,config=this.config,canvas=viz.canvas,ctx=canvas.getCtx(),nodes=this.nodes,GUtil=Graph.Util;var i,node;var nds={};for(i=0;i<nodes.length;i++){node=nodes[i];nds[node.id]=[];var root=config.multitree&&!('$orn'in node.data);var orns=root&&node.data.$orns;GUtil.eachSubgraph(node,function(n){if(root&&orns&&orns.indexOf(n.data.$orn)>0&&n.drawn){n.drawn=false;nds[node.id].push(n);}else if((!root||!orns)&&n.drawn){n.drawn=false;nds[node.id].push(n);}});node.drawn=true;}
if(nodes.length>0)viz.fx.plot();for(i in nds){$each(nds[i],function(n){n.drawn=true;});}
for(i=0;i<nodes.length;i++){node=nodes[i];ctx.save();viz.fx.plotSubtree(node,controller,delta,animating);ctx.restore();}},getSiblings:function(nodes){var siblings={},GUtil=Graph.Util;$each(nodes,function(n){var par=GUtil.getParents(n);if(par.length==0){siblings[n.id]=[n];}else{var ans=[];GUtil.eachSubnode(par[0],function(sn){ans.push(sn);});siblings[n.id]=ans;}});return siblings;}});ST.Geom=new Class({initialize:function(viz){this.viz=viz;this.config=viz.config;this.node=viz.config.Node;this.edge=viz.config.Edge;},translate:function(pos,prop){prop=$splat(prop);Graph.Util.eachNode(this.viz.graph,function(elem){$each(prop,function(p){elem[p].$add(pos);});});},switchOrientation:function(orn){this.config.orientation=orn;},dispatch:function(){var args=Array.prototype.slice.call(arguments);var s=args.shift(),len=args.length;var val=function(a){return typeof a=='function'?a():a;};if(len==2){return(s=="top"||s=="bottom")?val(args[0]):val(args[1]);}else if(len==4){switch(s){case"top":return val(args[0]);case"right":return val(args[1]);case"bottom":return val(args[2]);case"left":return val(args[3]);}}
return undefined;},getSize:function(n,invert){var node=this.node,data=n.data,config=this.config;var cond=node.overridable,siblingOffset=config.siblingOffset;var s=(this.config.multitree&&('$orn'in n.data)&&n.data.$orn)||this.config.orientation;var w=(cond&&data.$width||node.width)+siblingOffset;var h=(cond&&data.$height||node.height)+siblingOffset;if(!invert)
return this.dispatch(s,h,w);else
return this.dispatch(s,w,h);},getTreeBaseSize:function(node,level,leaf){var size=this.getSize(node,true),baseHeight=0,that=this;if(leaf(level,node))return size;if(level===0)return 0;Graph.Util.eachSubnode(node,function(elem){baseHeight+=that.getTreeBaseSize(elem,level-1,leaf);});return(size>baseHeight?size:baseHeight)+this.config.subtreeOffset;},getEdge:function(node,type,s){var $C=function(a,b){return function(){return node.pos.add(new Complex(a,b));};};var dim=this.node;var cond=this.node.overridable,data=node.data;var w=cond&&data.$width||dim.width;var h=cond&&data.$height||dim.height;if(type=='begin'){if(dim.align=="center"){return this.dispatch(s,$C(0,h/2),$C(-w/2,0),$C(0,-h/2),$C(w/2,0));}else if(dim.align=="left"){return this.dispatch(s,$C(0,h),$C(0,0),$C(0,0),$C(w,0));}else if(dim.align=="right"){return this.dispatch(s,$C(0,0),$C(-w,0),$C(0,-h),$C(0,0));}else throw"align: not implemented";}else if(type=='end'){if(dim.align=="center"){return this.dispatch(s,$C(0,-h/2),$C(w/2,0),$C(0,h/2),$C(-w/2,0));}else if(dim.align=="left"){return this.dispatch(s,$C(0,0),$C(w,0),$C(0,h),$C(0,0));}else if(dim.align=="right"){return this.dispatch(s,$C(0,-h),$C(0,0),$C(0,0),$C(-w,0));}else throw"align: not implemented";}},getScaledTreePosition:function(node,scale){var dim=this.node;var cond=this.node.overridable,data=node.data;var w=(cond&&data.$width||dim.width);var h=(cond&&data.$height||dim.height);var s=(this.config.multitree&&('$orn'in node.data)&&node.data.$orn)||this.config.orientation;var $C=function(a,b){return function(){return node.pos.add(new Complex(a,b)).$scale(1-scale);};};if(dim.align=="left"){return this.dispatch(s,$C(0,h),$C(0,0),$C(0,0),$C(w,0));}else if(dim.align=="center"){return this.dispatch(s,$C(0,h/2),$C(-w/2,0),$C(0,-h/2),$C(w/2,0));}else if(dim.align=="right"){return this.dispatch(s,$C(0,0),$C(-w,0),$C(0,-h),$C(0,0));}else throw"align: not implemented";},treeFitsInCanvas:function(node,canvas,level){var csize=canvas.getSize(node);var s=(this.config.multitree&&('$orn'in node.data)&&node.data.$orn)||this.config.orientation;var size=this.dispatch(s,csize.width,csize.height);var baseSize=this.getTreeBaseSize(node,level,function(level,node){return level===0||!Graph.Util.anySubnode(node);});return(baseSize<size);},setRightLevelToShow:function(node,canvas){var level=this.getRightLevelToShow(node,canvas),fx=this.viz.fx;Graph.Util.eachLevel(node,0,this.config.levelsToShow,function(n){var d=n._depth-node._depth;if(d>level){n.drawn=false;n.exist=false;fx.hideLabel(n,false);}else{n.exist=true;}});node.drawn=true;},getRightLevelToShow:function(node,canvas){var config=this.config;var level=config.levelsToShow;var constrained=config.constrained;if(!constrained)return level;while(!this.treeFitsInCanvas(node,canvas,level)&&level>1){level--;}
return level;}});ST.Plot=new Class({Implements:Graph.Plot,initialize:function(viz){this.viz=viz;this.config=viz.config;this.node=this.config.Node;this.edge=this.config.Edge;this.animation=new Animation;this.nodeTypes=new ST.Plot.NodeTypes;this.edgeTypes=new ST.Plot.EdgeTypes;},plotSubtree:function(node,opt,scale,animating){var viz=this.viz,canvas=viz.canvas;scale=Math.min(Math.max(0.001,scale),1);if(scale>=0){node.drawn=false;var ctx=canvas.getCtx();var diff=viz.geom.getScaledTreePosition(node,scale);ctx.translate(diff.x,diff.y);ctx.scale(scale,scale);}
this.plotTree(node,!scale,opt,animating);if(scale>=0)node.drawn=true;},plotTree:function(node,plotLabel,opt,animating){var that=this,viz=this.viz,canvas=viz.canvas,config=this.config,ctx=canvas.getCtx();var root=config.multitree&&!('$orn'in node.data);var orns=root&&node.data.$orns;Graph.Util.eachSubnode(node,function(elem){if((!root||orns.indexOf(elem.data.$orn)>0)&&elem.exist&&elem.drawn){var adj=node.getAdjacency(elem.id);!animating&&opt.onBeforePlotLine(adj);ctx.globalAlpha=Math.min(node.alpha,elem.alpha);that.plotLine(adj,canvas,animating);!animating&&opt.onAfterPlotLine(adj);that.plotTree(elem,plotLabel,opt,animating);}});if(node.drawn){ctx.globalAlpha=node.alpha;!animating&&opt.onBeforePlotNode(node);this.plotNode(node,canvas,animating);!animating&&opt.onAfterPlotNode(node);if(plotLabel&&ctx.globalAlpha>=0.95)
this.plotLabel(canvas,node,opt);else
this.hideLabel(node,false);}else{this.hideLabel(node,true);}},placeLabel:function(tag,node,controller){var pos=node.pos.getc(true),dim=this.node,canvas=this.viz.canvas;var w=dim.overridable&&node.data.$width||dim.width;var h=dim.overridable&&node.data.$height||dim.height;var radius=canvas.getSize();var labelPos,orn;if(dim.align=="center"){labelPos={x:Math.round(pos.x-w/2+radius.width/2),y:Math.round(pos.y-h/2+radius.height/2)};}else if(dim.align=="left"){orn=this.config.orientation;if(orn=="bottom"||orn=="top"){labelPos={x:Math.round(pos.x-w/2+radius.width/2),y:Math.round(pos.y+radius.height/2)};}else{labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y-h/2+radius.height/2)};}}else if(dim.align=="right"){orn=this.config.orientation;if(orn=="bottom"||orn=="top"){labelPos={x:Math.round(pos.x-w/2+radius.width/2),y:Math.round(pos.y-h+radius.height/2)};}else{labelPos={x:Math.round(pos.x-w+radius.width/2),y:Math.round(pos.y-h/2+radius.height/2)};}}else throw"align: not implemented";var style=tag.style;style.left=labelPos.x+'px';style.top=labelPos.y+'px';style.display=this.fitsInCanvas(labelPos,canvas)?'':'none';controller.onPlaceLabel(tag,node);},getAlignedPos:function(pos,width,height){var nconfig=this.node;var square,orn;if(nconfig.align=="center"){square={x:pos.x-width/2,y:pos.y-height/2};}else if(nconfig.align=="left"){orn=this.config.orientation;if(orn=="bottom"||orn=="top"){square={x:pos.x-width/2,y:pos.y};}else{square={x:pos.x,y:pos.y-height/2};}}else if(nconfig.align=="right"){orn=this.config.orientation;if(orn=="bottom"||orn=="top"){square={x:pos.x-width/2,y:pos.y-height};}else{square={x:pos.x-width,y:pos.y-height/2};}}else throw"align: not implemented";return square;},getOrientation:function(adj){var config=this.config;var orn=config.orientation;if(config.multitree){var nodeFrom=adj.nodeFrom;var nodeTo=adj.nodeTo;orn=(('$orn'in nodeFrom.data)&&nodeFrom.data.$orn)||(('$orn'in nodeTo.data)&&nodeTo.data.$orn);}
return orn;}});ST.Plot.NodeTypes=new Class({'none':function(){},'circle':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var cond=nconfig.overridable&&data;var dim=cond&&data.$dim||nconfig.dim;var algnPos=this.getAlignedPos(pos,dim*2,dim*2);canvas.path('fill',function(context){context.arc(algnPos.x+dim,algnPos.y+dim,dim,0,Math.PI*2,true);});},'square':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var cond=nconfig.overridable&&data;var dim=cond&&data.$dim||nconfig.dim;var algnPos=this.getAlignedPos(pos,dim,dim);canvas.getCtx().fillRect(algnPos.x,algnPos.y,dim,dim);},'ellipse':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var cond=nconfig.overridable&&data;var width=(cond&&data.$width||nconfig.width)/2;var height=(cond&&data.$height||nconfig.height)/2;var algnPos=this.getAlignedPos(pos,width*2,height*2);var ctx=canvas.getCtx();ctx.save();ctx.scale(width/height,height/width);canvas.path('fill',function(context){context.arc((algnPos.x+width)*(height/width),(algnPos.y+height)*(width/height),height,0,Math.PI*2,true);});ctx.restore();},'rectangle':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var cond=nconfig.overridable&&data;var width=cond&&data.$width||nconfig.width;var height=cond&&data.$height||nconfig.height;var algnPos=this.getAlignedPos(pos,width,height);canvas.getCtx().fillRect(algnPos.x,algnPos.y,width,height);}});ST.Plot.EdgeTypes=new Class({'none':function(){},'line':function(adj,canvas){var orn=this.getOrientation(adj);var nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo;var begin=this.viz.geom.getEdge(nodeFrom._depth<nodeTo._depth?nodeFrom:nodeTo,'begin',orn);var end=this.viz.geom.getEdge(nodeFrom._depth<nodeTo._depth?nodeTo:nodeFrom,'end',orn);canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.lineTo(end.x,end.y);});},'quadratic:begin':function(adj,canvas){var orn=this.getOrientation(adj);var data=adj.data,econfig=this.edge;var nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo;var begin=this.viz.geom.getEdge(nodeFrom._depth<nodeTo._depth?nodeFrom:nodeTo,'begin',orn);var end=this.viz.geom.getEdge(nodeFrom._depth<nodeTo._depth?nodeTo:nodeFrom,'end',orn);var cond=econfig.overridable&&data;var dim=cond&&data.$dim||econfig.dim;switch(orn){case"left":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.quadraticCurveTo(begin.x+dim,begin.y,end.x,end.y);});break;case"right":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.quadraticCurveTo(begin.x-dim,begin.y,end.x,end.y);});break;case"top":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.quadraticCurveTo(begin.x,begin.y+dim,end.x,end.y);});break;case"bottom":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.quadraticCurveTo(begin.x,begin.y-dim,end.x,end.y);});break;}},'quadratic:end':function(adj,canvas){var orn=this.getOrientation(adj);var data=adj.data,econfig=this.edge;var nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo;var begin=this.viz.geom.getEdge(nodeFrom._depth<nodeTo._depth?nodeFrom:nodeTo,'begin',orn);var end=this.viz.geom.getEdge(nodeFrom._depth<nodeTo._depth?nodeTo:nodeFrom,'end',orn);var cond=econfig.overridable&&data;var dim=cond&&data.$dim||econfig.dim;switch(orn){case"left":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.quadraticCurveTo(end.x-dim,end.y,end.x,end.y);});break;case"right":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.quadraticCurveTo(end.x+dim,end.y,end.x,end.y);});break;case"top":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.quadraticCurveTo(end.x,end.y-dim,end.x,end.y);});break;case"bottom":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.quadraticCurveTo(end.x,end.y+dim,end.x,end.y);});break;}},'bezier':function(adj,canvas){var data=adj.data,econfig=this.edge;var orn=this.getOrientation(adj);var nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo;var begin=this.viz.geom.getEdge(nodeFrom._depth<nodeTo._depth?nodeFrom:nodeTo,'begin',orn);var end=this.viz.geom.getEdge(nodeFrom._depth<nodeTo._depth?nodeTo:nodeFrom,'end',orn);var cond=econfig.overridable&&data;var dim=cond&&data.$dim||econfig.dim;switch(orn){case"left":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.bezierCurveTo(begin.x+dim,begin.y,end.x-dim,end.y,end.x,end.y);});break;case"right":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.bezierCurveTo(begin.x-dim,begin.y,end.x+dim,end.y,end.x,end.y);});break;case"top":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.bezierCurveTo(begin.x,begin.y+dim,end.x,end.y-dim,end.x,end.y);});break;case"bottom":canvas.path('stroke',function(ctx){ctx.moveTo(begin.x,begin.y);ctx.bezierCurveTo(begin.x,begin.y-dim,end.x,end.y+dim,end.x,end.y);});break;}},'arrow':function(adj,canvas){var orn=this.getOrientation(adj);var node=adj.nodeFrom,child=adj.nodeTo;var data=adj.data,econfig=this.edge;var cond=econfig.overridable&&data;var edgeDim=cond&&data.$dim||econfig.dim;if(cond&&data.$direction&&data.$direction.length>1){var nodeHash={};nodeHash[node.id]=node;nodeHash[child.id]=child;var sense=data.$direction;node=nodeHash[sense[0]];child=nodeHash[sense[1]];}
var posFrom=this.viz.geom.getEdge(node,'begin',orn);var posTo=this.viz.geom.getEdge(child,'end',orn);var vect=new Complex(posTo.x-posFrom.x,posTo.y-posFrom.y);vect.$scale(edgeDim/vect.norm());var intermediatePoint=new Complex(posTo.x-vect.x,posTo.y-vect.y);var normal=new Complex(-vect.y/2,vect.x/2);var v1=intermediatePoint.add(normal),v2=intermediatePoint.$add(normal.$scale(-1));canvas.path('stroke',function(context){context.moveTo(posFrom.x,posFrom.y);context.lineTo(posTo.x,posTo.y);});canvas.path('fill',function(context){context.moveTo(v1.x,v1.y);context.lineTo(v2.x,v2.y);context.lineTo(posTo.x,posTo.y);});}});})();var AngularWidth={setAngularWidthForNodes:function(){var config=this.config.Node;var overridable=config.overridable;var dim=config.dim;Graph.Util.eachBFS(this.graph,this.root,function(elem,i){var diamValue=(overridable&&elem.data&&elem.data.$aw)||dim;elem._angularWidth=diamValue/i;},"ignore");},setSubtreesAngularWidth:function(){var that=this;Graph.Util.eachNode(this.graph,function(elem){that.setSubtreeAngularWidth(elem);},"ignore");},setSubtreeAngularWidth:function(elem){var that=this,nodeAW=elem._angularWidth,sumAW=0;Graph.Util.eachSubnode(elem,function(child){that.setSubtreeAngularWidth(child);sumAW+=child._treeAngularWidth;},"ignore");elem._treeAngularWidth=Math.max(nodeAW,sumAW);},computeAngularWidths:function(){this.setAngularWidthForNodes();this.setSubtreesAngularWidth();}};this.RGraph=new Class({Implements:[Loader,AngularWidth],initialize:function(canvas,controller){var config={labelContainer:canvas.id+'-label',interpolation:'linear',levelDistance:100,withLabels:true,Node:{overridable:false,type:'circle',dim:3,color:'#ccb',width:5,height:5,lineWidth:1},Edge:{overridable:false,type:'line',color:'#ccb',lineWidth:1},fps:40,duration:2500,transition:Trans.Quart.easeInOut,clearCanvas:true};var innerController={onBeforeCompute:$empty,onAfterCompute:$empty,onCreateLabel:$empty,onPlaceLabel:$empty,onComplete:$empty,onBeforePlotLine:$empty,onAfterPlotLine:$empty,onBeforePlotNode:$empty,onAfterPlotNode:$empty};this.controller=this.config=$merge(config,innerController,controller);this.graphOptions={'complex':false,'Node':{'selected':false,'exist':true,'drawn':true}};this.graph=new Graph(this.graphOptions);this.fx=new RGraph.Plot(this);this.op=new RGraph.Op(this);this.json=null;this.canvas=canvas;this.root=null;this.busy=false;this.parent=false;},refresh:function(){this.compute();this.plot();},reposition:function(){this.compute('endPos');},plot:function(){this.fx.plot();},compute:function(property){var prop=property||['pos','startPos','endPos'];var node=this.graph.getNode(this.root);node._depth=0;Graph.Util.computeLevels(this.graph,this.root,0,"ignore");this.computeAngularWidths();this.computePositions(prop);},computePositions:function(property){var propArray=$splat(property);var aGraph=this.graph;var GUtil=Graph.Util;var root=this.graph.getNode(this.root);var parent=this.parent;var config=this.config;for(var i=0;i<propArray.length;i++)
root[propArray[i]]=$P(0,0);root.angleSpan={begin:0,end:2*Math.PI};root._rel=1;GUtil.eachBFS(this.graph,this.root,function(elem){var angleSpan=elem.angleSpan.end-elem.angleSpan.begin;var rho=(elem._depth+1)*config.levelDistance;var angleInit=elem.angleSpan.begin;var totalAngularWidths=0,subnodes=[];GUtil.eachSubnode(elem,function(sib){totalAngularWidths+=sib._treeAngularWidth;subnodes.push(sib);},"ignore");if(parent&&parent.id==elem.id&&subnodes.length>0&&subnodes[0].dist){subnodes.sort(function(a,b){return(a.dist>=b.dist)-(a.dist<=b.dist);});}
for(var k=0;k<subnodes.length;k++){var child=subnodes[k];if(!child._flag){child._rel=child._treeAngularWidth/totalAngularWidths;var angleProportion=child._rel*angleSpan;var theta=angleInit+angleProportion/2;for(var i=0;i<propArray.length;i++)
child[propArray[i]]=$P(theta,rho);child.angleSpan={begin:angleInit,end:angleInit+angleProportion};angleInit+=angleProportion;}}},"ignore");},getNodeAndParentAngle:function(id){var theta=false;var n=this.graph.getNode(id);var ps=Graph.Util.getParents(n);var p=(ps.length>0)?ps[0]:false;if(p){var posParent=p.pos.getc(),posChild=n.pos.getc();var newPos=posParent.add(posChild.scale(-1));theta=Math.atan2(newPos.y,newPos.x);if(theta<0)theta+=2*Math.PI;}
return{parent:p,theta:theta};},tagChildren:function(par,id){if(par.angleSpan){var adjs=[];Graph.Util.eachAdjacency(par,function(elem){adjs.push(elem.nodeTo);},"ignore");var len=adjs.length;for(var i=0;i<len&&id!=adjs[i].id;i++);for(var j=(i+1)%len,k=0;id!=adjs[j].id;j=(j+1)%len){adjs[j].dist=k++;}}},onClick:function(id,opt){if(this.root!=id&&!this.busy){this.busy=true;this.root=id;that=this;this.controller.onBeforeCompute(this.graph.getNode(id));var obj=this.getNodeAndParentAngle(id);this.tagChildren(obj.parent,id);this.parent=obj.parent;this.compute('endPos');var thetaDiff=obj.theta-obj.parent.endPos.theta;Graph.Util.eachNode(this.graph,function(elem){elem.endPos.set(elem.endPos.getp().add($P(thetaDiff,0)));});var mode=this.config.interpolation;opt=$merge({onComplete:$empty},opt||{});this.fx.animate($merge({hideLabels:true,modes:[mode]},opt,{onComplete:function(){that.busy=false;opt.onComplete();}}));}}});RGraph.Op=new Class({Implements:Graph.Op,initialize:function(viz){this.viz=viz;}});RGraph.Plot=new Class({Implements:Graph.Plot,initialize:function(viz){this.viz=viz;this.config=viz.config;this.node=viz.config.Node;this.edge=viz.config.Edge;this.animation=new Animation;this.nodeTypes=new RGraph.Plot.NodeTypes;this.edgeTypes=new RGraph.Plot.EdgeTypes;},placeLabel:function(tag,node,controller){var pos=node.pos.getc(true),canvas=this.viz.canvas;var radius=canvas.getSize();var labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y+radius.height/2)};var style=tag.style;style.left=labelPos.x+'px';style.top=labelPos.y+'px';style.display=this.fitsInCanvas(labelPos,canvas)?'':'none';controller.onPlaceLabel(tag,node);}});RGraph.Plot.NodeTypes=new Class({'none':function(){},'circle':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;canvas.path('fill',function(context){context.arc(pos.x,pos.y,nodeDim,0,Math.PI*2,true);});},'square':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;var nodeDim2=2*nodeDim;canvas.getCtx().fillRect(pos.x-nodeDim,pos.y-nodeDim,nodeDim2,nodeDim2);},'rectangle':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var width=nconfig.overridable&&data&&data.$width||nconfig.width;var height=nconfig.overridable&&data&&data.$height||nconfig.height;canvas.getCtx().fillRect(pos.x-width/2,pos.y-height/2,width,height);},'triangle':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;var c1x=pos.x,c1y=pos.y-nodeDim,c2x=c1x-nodeDim,c2y=pos.y+nodeDim,c3x=c1x+nodeDim,c3y=c2y;canvas.path('fill',function(ctx){ctx.moveTo(c1x,c1y);ctx.lineTo(c2x,c2y);ctx.lineTo(c3x,c3y);});},'star':function(node,canvas){var pos=node.pos.getc(true),nconfig=this.node,data=node.data;var nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;var ctx=canvas.getCtx(),pi5=Math.PI/5;ctx.save();ctx.translate(pos.x,pos.y);ctx.beginPath();ctx.moveTo(nodeDim,0);for(var i=0;i<9;i++){ctx.rotate(pi5);if(i%2==0){ctx.lineTo((nodeDim/0.525731)*0.200811,0);}else{ctx.lineTo(nodeDim,0);}}
ctx.closePath();ctx.fill();ctx.restore();}});RGraph.Plot.EdgeTypes=new Class({'none':function(){},'line':function(adj,canvas){var pos=adj.nodeFrom.pos.getc(true);var posChild=adj.nodeTo.pos.getc(true);canvas.path('stroke',function(context){context.moveTo(pos.x,pos.y);context.lineTo(posChild.x,posChild.y);});},'arrow':function(adj,canvas){var node=adj.nodeFrom,child=adj.nodeTo;var data=adj.data,econfig=this.edge;var cond=econfig.overridable&&data;var edgeDim=cond&&data.$dim||14;if(cond&&data.$direction&&data.$direction.length>1){var nodeHash={};nodeHash[node.id]=node;nodeHash[child.id]=child;var sense=data.$direction;node=nodeHash[sense[0]];child=nodeHash[sense[1]];}
var posFrom=node.pos.getc(true),posTo=child.pos.getc(true);var vect=new Complex(posTo.x-posFrom.x,posTo.y-posFrom.y);vect.$scale(edgeDim/vect.norm());var intermediatePoint=new Complex(posTo.x-vect.x,posTo.y-vect.y);var normal=new Complex(-vect.y/2,vect.x/2);var v1=intermediatePoint.add(normal),v2=intermediatePoint.$add(normal.$scale(-1));canvas.path('stroke',function(context){context.moveTo(posFrom.x,posFrom.y);context.lineTo(posTo.x,posTo.y);});canvas.path('fill',function(context){context.moveTo(v1.x,v1.y);context.lineTo(v2.x,v2.y);context.lineTo(posTo.x,posTo.y);});}});Complex.prototype.moebiusTransformation=function(c){var num=this.add(c);var den=c.$conjugate().$prod(this);den.x++;return num.$div(den);};Graph.Util.getClosestNodeToOrigin=function(graph,prop,flags){return this.getClosestNodeToPos(graph,Polar.KER,prop,flags);};Graph.Util.getClosestNodeToPos=function(graph,pos,prop,flags){var node=null;prop=prop||'pos';pos=pos&&pos.getc(true)||Complex.KER;var distance=function(a,b){var d1=a.x-b.x,d2=a.y-b.y;return d1*d1+d2*d2;};this.eachNode(graph,function(elem){node=(node==null||distance(elem[prop].getc(true),pos)<distance(node[prop].getc(true),pos))?elem:node;},flags);return node;};Graph.Util.moebiusTransformation=function(graph,pos,prop,startPos,flags){this.eachNode(graph,function(elem){for(var i=0;i<prop.length;i++){var p=pos[i].scale(-1),property=startPos?startPos:prop[i];elem[prop[i]].set(elem[property].getc().moebiusTransformation(p));}},flags);};this.Hypertree=new Class({Implements:[Loader,AngularWidth],initialize:function(canvas,controller){var config={labelContainer:canvas.id+'-label',withLabels:true,Node:{overridable:false,type:'circle',dim:7,color:'#ccb',width:5,height:5,lineWidth:1,transform:true},Edge:{overridable:false,type:'hyperline',color:'#ccb',lineWidth:1},clearCanvas:true,fps:40,duration:1500,transition:Trans.Quart.easeInOut};var innerController={onBeforeCompute:$empty,onAfterCompute:$empty,onCreateLabel:$empty,onPlaceLabel:$empty,onComplete:$empty,onBeforePlotLine:$empty,onAfterPlotLine:$empty,onBeforePlotNode:$empty,onAfterPlotNode:$empty};this.controller=this.config=$merge(config,innerController,controller);this.graphOptions={'complex':false,'Node':{'selected':false,'exist':true,'drawn':true}};this.graph=new Graph(this.graphOptions);this.fx=new Hypertree.Plot(this);this.op=new Hypertree.Op(this);this.json=null;this.canvas=canvas;this.root=null;this.busy=false;},refresh:function(reposition){if(reposition){this.reposition();Graph.Util.eachNode(this.graph,function(node){node.startPos.rho=node.pos.rho=node.endPos.rho;node.startPos.theta=node.pos.theta=node.endPos.theta;});}else{this.compute();}
this.plot();},reposition:function(){this.compute('endPos');var vector=this.graph.getNode(this.root).pos.getc().scale(-1);Graph.Util.moebiusTransformation(this.graph,[vector],['endPos'],'endPos',"ignore");Graph.Util.eachNode(this.graph,function(node){if(node.ignore){node.endPos.rho=node.pos.rho;node.endPos.theta=node.pos.theta;}});},plot:function(){this.fx.plot();},compute:function(property){var prop=property||['pos','startPos'];var node=this.graph.getNode(this.root);node._depth=0;Graph.Util.computeLevels(this.graph,this.root,0,"ignore");this.computeAngularWidths();this.computePositions(prop);},computePositions:function(property){var propArray=$splat(property);var aGraph=this.graph,GUtil=Graph.Util;var root=this.graph.getNode(this.root),that=this,config=this.config;var size=this.canvas.getSize();var scale=Math.min(size.width,size.height)/2;for(var i=0;i<propArray.length;i++)
root[propArray[i]]=$P(0,0);root.angleSpan={begin:0,end:2*Math.PI};root._rel=1;var edgeLength=(function(){var depth=0;GUtil.eachNode(aGraph,function(node){depth=(node._depth>depth)?node._depth:depth;node._scale=scale;},"ignore");for(var i=0.51;i<=1;i+=0.01){var valSeries=(function(a,n){return(1-Math.pow(a,n))/(1-a);})(i,depth+1);if(valSeries>=2)return i-0.01;}
return 0.5;})();GUtil.eachBFS(this.graph,this.root,function(elem){var angleSpan=elem.angleSpan.end-elem.angleSpan.begin;var angleInit=elem.angleSpan.begin;var totalAngularWidths=(function(element){var total=0;GUtil.eachSubnode(element,function(sib){total+=sib._treeAngularWidth;},"ignore");return total;})(elem);for(var i=1,rho=0,lenAcum=edgeLength,depth=elem._depth;i<=depth+1;i++){rho+=lenAcum;lenAcum*=edgeLength;}
GUtil.eachSubnode(elem,function(child){if(!child._flag){child._rel=child._treeAngularWidth/totalAngularWidths;var angleProportion=child._rel*angleSpan;var theta=angleInit+angleProportion/2;for(var i=0;i<propArray.length;i++)
child[propArray[i]]=$P(theta,rho);child.angleSpan={begin:angleInit,end:angleInit+angleProportion};angleInit+=angleProportion;}},"ignore");},"ignore");},onClick:function(id,opt){var pos=this.graph.getNode(id).pos.getc(true);this.move(pos,opt);},move:function(pos,opt){var versor=$C(pos.x,pos.y);if(this.busy===false&&versor.norm()<1){var GUtil=Graph.Util;this.busy=true;var root=GUtil.getClosestNodeToPos(this.graph,versor),that=this;GUtil.computeLevels(this.graph,root.id,0);this.controller.onBeforeCompute(root);if(versor.norm()<1){opt=$merge({onComplete:$empty},opt||{});this.fx.animate($merge({modes:['moebius'],hideLabels:true},opt,{onComplete:function(){that.busy=false;opt.onComplete();}}),versor);}}}});Hypertree.Op=new Class({Implements:Graph.Op,initialize:function(viz){this.viz=viz;}});Hypertree.Plot=new Class({Implements:Graph.Plot,initialize:function(viz){this.viz=viz;this.config=viz.config;this.node=this.config.Node;this.edge=this.config.Edge;this.animation=new Animation;this.nodeTypes=new Hypertree.Plot.NodeTypes;this.edgeTypes=new Hypertree.Plot.EdgeTypes;},hyperline:function(adj,canvas){var node=adj.nodeFrom,child=adj.nodeTo,data=adj.data;var pos=node.pos.getc(),posChild=child.pos.getc();var centerOfCircle=this.computeArcThroughTwoPoints(pos,posChild);var size=canvas.getSize();var scale=Math.min(size.width,size.height)/2;if(centerOfCircle.a>1000||centerOfCircle.b>1000||centerOfCircle.ratio>1000){canvas.path('stroke',function(ctx){ctx.moveTo(pos.x*scale,pos.y*scale);ctx.lineTo(posChild.x*scale,posChild.y*scale);});}else{var angleBegin=Math.atan2(posChild.y-centerOfCircle.y,posChild.x-centerOfCircle.x);var angleEnd=Math.atan2(pos.y-centerOfCircle.y,pos.x-centerOfCircle.x);var sense=this.sense(angleBegin,angleEnd);var context=canvas.getCtx();canvas.path('stroke',function(ctx){ctx.arc(centerOfCircle.x*scale,centerOfCircle.y*scale,centerOfCircle.ratio*scale,angleBegin,angleEnd,sense);});}},computeArcThroughTwoPoints:function(p1,p2){var aDen=(p1.x*p2.y-p1.y*p2.x),bDen=aDen;var sq1=p1.squaredNorm(),sq2=p2.squaredNorm();if(aDen==0)return{x:0,y:0,ratio:1001};var a=(p1.y*sq2-p2.y*sq1+p1.y-p2.y)/aDen;var b=(p2.x*sq1-p1.x*sq2+p2.x-p1.x)/bDen;var x=-a/2;var y=-b/2;var squaredRatio=(a*a+b*b)/4-1;if(squaredRatio<0)return{x:0,y:0,ratio:1001};var ratio=Math.sqrt(squaredRatio);var out={x:x,y:y,ratio:ratio,a:a,b:b};return out;},sense:function(angleBegin,angleEnd){return(angleBegin<angleEnd)?((angleBegin+Math.PI>angleEnd)?false:true):((angleEnd+Math.PI>angleBegin)?true:false);},placeLabel:function(tag,node,controller){var pos=node.pos.getc(true),canvas=this.viz.canvas;var radius=canvas.getSize();var scale=node._scale;var labelPos={x:Math.round(pos.x*scale+radius.width/2),y:Math.round(pos.y*scale+radius.height/2)};var style=tag.style;style.left=labelPos.x+'px';style.top=labelPos.y+'px';style.display='';controller.onPlaceLabel(tag,node);}});Hypertree.Plot.NodeTypes=new Class({'none':function(){},'circle':function(node,canvas){var nconfig=this.node,data=node.data;var nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;var p=node.pos.getc(),pos=p.scale(node._scale);var prod=nconfig.transform?nodeDim*(1-p.squaredNorm()):nodeDim;if(prod>=nodeDim/4){canvas.path('fill',function(context){context.arc(pos.x,pos.y,prod,0,Math.PI*2,true);});}},'square':function(node,canvas){var nconfig=this.node,data=node.data;var nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;var p=node.pos.getc(),pos=p.scale(node._scale);var prod=nconfig.transform?nodeDim*(1-p.squaredNorm()):nodeDim;var nodeDim2=2*prod;if(prod>=nodeDim/4){canvas.getCtx().fillRect(pos.x-prod,pos.y-prod,nodeDim2,nodeDim2);}},'rectangle':function(node,canvas){var nconfig=this.node,data=node.data;var width=nconfig.overridable&&data&&data.$width||nconfig.width;var height=nconfig.overridable&&data&&data.$height||nconfig.height;var p=node.pos.getc(),pos=p.scale(node._scale);var prod=1-p.squaredNorm();width=nconfig.transform?width*prod:width;height=nconfig.transform?height*prod:height;if(prod>=0.25){canvas.getCtx().fillRect(pos.x-width/2,pos.y-height/2,width,height);}},'triangle':function(node,canvas){var nconfig=this.node,data=node.data;var nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;var p=node.pos.getc(),pos=p.scale(node._scale);var prod=nconfig.transform?nodeDim*(1-p.squaredNorm()):nodeDim;if(prod>=nodeDim/4){var c1x=pos.x,c1y=pos.y-prod,c2x=c1x-prod,c2y=pos.y+prod,c3x=c1x+prod,c3y=c2y;canvas.path('fill',function(ctx){ctx.moveTo(c1x,c1y);ctx.lineTo(c2x,c2y);ctx.lineTo(c3x,c3y);});}},'star':function(node,canvas){var nconfig=this.node,data=node.data;var nodeDim=nconfig.overridable&&data&&data.$dim||nconfig.dim;var p=node.pos.getc(),pos=p.scale(node._scale);var prod=nconfig.transform?nodeDim*(1-p.squaredNorm()):nodeDim;if(prod>=nodeDim/4){var ctx=canvas.getCtx(),pi5=Math.PI/5;ctx.save();ctx.translate(pos.x,pos.y);ctx.beginPath();ctx.moveTo(nodeDim,0);for(var i=0;i<9;i++){ctx.rotate(pi5);if(i%2==0){ctx.lineTo((prod/0.525731)*0.200811,0);}
else{ctx.lineTo(prod,0);}}
ctx.closePath();ctx.fill();ctx.restore();}}});Hypertree.Plot.EdgeTypes=new Class({'none':function(){},'line':function(adj,canvas){var s=adj.nodeFrom._scale;var pos=adj.nodeFrom.pos.getc(true);var posChild=adj.nodeTo.pos.getc(true);canvas.path('stroke',function(context){context.moveTo(pos.x*s,pos.y*s);context.lineTo(posChild.x*s,posChild.y*s);});},'hyperline':function(adj,canvas){this.hyperline(adj,canvas);}});this.TM={layout:{orientation:"h",vertical:function(){return this.orientation=="v";},horizontal:function(){return this.orientation=="h";},change:function(){this.orientation=this.vertical()?"h":"v";}},innerController:{onBeforeCompute:$empty,onAfterCompute:$empty,onComplete:$empty,onCreateElement:$empty,onDestroyElement:$empty,request:false},config:{orientation:"h",titleHeight:13,rootId:'infovis',offset:4,levelsToShow:3,addLeftClickHandler:false,addRightClickHandler:false,selectPathOnHover:false,Color:{allow:false,minValue:-100,maxValue:100,minColorValue:[255,0,50],maxColorValue:[0,255,50]},Tips:{allow:false,offsetX:20,offsetY:20,onShow:$empty}},initialize:function(controller){this.tree=null;this.shownTree=null;this.controller=this.config=$merge(this.config,this.innerController,controller);this.rootId=this.config.rootId;this.layout.orientation=this.config.orientation;if(this.config.Tips.allow&&document.body){var tip=document.getElementById('_tooltip')||document.createElement('div');tip.id='_tooltip';tip.className='tip';var style=tip.style;style.position='absolute';style.display='none';style.zIndex=13000;document.body.appendChild(tip);this.tip=tip;}
var that=this;var fn=function(){that.empty();if(window.CollectGarbage)window.CollectGarbage();delete fn;};if(window.addEventListener){window.addEventListener('unload',fn,false);}else{window.attachEvent('onunload',fn);}},each:function(f){(function rec(elem){if(!elem)return;var ch=elem.childNodes,len=ch.length;if(len>0){f.apply(this,[elem,len===1,ch[0],ch[1]]);}
if(len>1){for(var chi=ch[1].childNodes,i=0;i<chi.length;i++){rec(chi[i]);}}})($get(this.rootId).firstChild);},toStyle:function(obj){var ans="";for(var s in obj)ans+=s+":"+obj[s]+";";return ans;},leaf:function(tree){return tree.children==0;},createBox:function(json,coord,html){var box;if(!this.leaf(json)){box=this.headBox(json,coord)+this.bodyBox(html,coord);}else{box=this.leafBox(json,coord);}
return this.contentBox(json,coord,box);},plot:function(json){var coord=json.coord,html="";if(this.leaf(json))
return this.createBox(json,coord,null);for(var i=0,ch=json.children;i<ch.length;i++){var chi=ch[i],chcoord=chi.coord;if(chcoord.width*chcoord.height>1){html+=this.plot(chi);}}
return this.createBox(json,coord,html);},headBox:function(json,coord){var config=this.config,offst=config.offset;var c={'height':config.titleHeight+"px",'width':(coord.width-offst)+"px",'left':offst/2+"px"};return"<div class=\"head\" style=\""+this.toStyle(c)+"\">"
+json.name+"</div>";},bodyBox:function(html,coord){var config=this.config,th=config.titleHeight,offst=config.offset;var c={'width':(coord.width-offst)+"px",'height':(coord.height-offst-th)+"px",'top':(th+offst/2)+"px",'left':(offst/2)+"px"};return"<div class=\"body\" style=\""
+this.toStyle(c)+"\">"+html+"</div>";},contentBox:function(json,coord,html){var c={};for(var i in coord)c[i]=coord[i]+"px";return"<div class=\"content\" style=\""+this.toStyle(c)
+"\" id=\""+json.id+"\">"+html+"</div>";},leafBox:function(json,coord){var config=this.config;var backgroundColor=config.Color.allow&&this.setColor(json),offst=config.offset,width=coord.width-offst,height=coord.height-offst;var c={'top':(offst/2)+"px",'height':height+"px",'width':width+"px",'left':(offst/2)+"px"};if(backgroundColor)c['background-color']=backgroundColor;return"<div class=\"leaf\" style=\""+this.toStyle(c)+"\">"
+json.name+"</div>";},setColor:function(json){var c=this.config.Color,maxcv=c.maxColorValue,mincv=c.minColorValue,maxv=c.maxValue,minv=c.minValue,diff=maxv-minv,x=(json.data.$color-0);var comp=function(i,x){return Math.round((((maxcv[i]-mincv[i])/diff)*(x-minv)+mincv[i]));};return $rgbToHex([comp(0,x),comp(1,x),comp(2,x)]);},enter:function(elem){this.view(elem.parentNode.id);},onLeftClick:function(elem){this.enter(elem);},out:function(){var parent=TreeUtil.getParent(this.tree,this.shownTree.id);if(parent){if(this.controller.request)
TreeUtil.prune(parent,this.config.levelsToShow);this.view(parent.id);}},onRightClick:function(){this.out();},view:function(id){var config=this.config,that=this;var post={onComplete:function(){that.loadTree(id);$get(config.rootId).focus();}};if(this.controller.request){var TUtil=TreeUtil;TUtil.loadSubtrees(TUtil.getSubtree(this.tree,id),$merge(this.controller,post));}else{post.onComplete();}},resetPath:function(tree){var root=this.rootId,previous=this.resetPath.previous;this.resetPath.previous=tree||false;function getParent(c){var p=c.parentNode;return p&&(p.id!=root)&&p;};function toggleInPath(elem,remove){if(elem){var container=$get(elem.id);if(container){var parent=getParent(container);while(parent){elem=parent.childNodes[0];if($hasClass(elem,'in-path')){if(remove==undefined||!!remove)$removeClass(elem,'in-path');}else{if(!remove)$addClass(elem,'in-path');}
parent=getParent(parent);}}}};toggleInPath(previous,true);toggleInPath(tree,false);},initializeElements:function(){var cont=this.controller,that=this;var ff=$lambda(false),tipsAllow=cont.Tips.allow;this.each(function(content,isLeaf,elem1,elem2){var tree=TreeUtil.getSubtree(that.tree,content.id);cont.onCreateElement(content,tree,isLeaf,elem1,elem2);if(cont.addRightClickHandler)elem1.oncontextmenu=ff;if(cont.addLeftClickHandler||cont.addRightClickHandler){$addEvent(elem1,'mouseup',function(e){var rightClick=(e.which==3||e.button==2);if(rightClick){if(cont.addRightClickHandler)that.onRightClick();}
else{if(cont.addLeftClickHandler)that.onLeftClick(elem1);}
if(e.preventDefault)
e.preventDefault();else
e.returnValue=false;});}
if(cont.selectPathOnHover||tipsAllow){$addEvent(elem1,'mouseover',function(e){if(cont.selectPathOnHover){if(isLeaf){$addClass(elem1,'over-leaf');}
else{$addClass(elem1,'over-head');$addClass(content,'over-content');}
if(content.id)
that.resetPath(tree);}
if(tipsAllow)
cont.Tips.onShow(that.tip,tree,isLeaf,elem1);});$addEvent(elem1,'mouseout',function(e){if(cont.selectPathOnHover){if(isLeaf){$removeClass(elem1,'over-leaf');}
else{$removeClass(elem1,'over-head');$removeClass(content,'over-content');}
that.resetPath();}
if(tipsAllow)
that.tip.style.display='none';});if(tipsAllow){$addEvent(elem1,'mousemove',function(e,win){var tip=that.tip;win=win||window;e=e||win.event;var doc=win.document;doc=doc.html||doc.body;var page={x:e.pageX||e.clientX+doc.scrollLeft,y:e.pageY||e.clientY+doc.scrollTop};tip.style.display='';win={'height':document.body.clientHeight,'width':document.body.clientWidth};var obj={'width':tip.offsetWidth,'height':tip.offsetHeight};var style=tip.style,x=cont.Tips.offsetX,y=cont.Tips.offsetY;style.top=((page.y+y+obj.height>win.height)?(page.y-obj.height-y):page.y+y)+'px';style.left=((page.x+obj.width+x>win.width)?(page.x-obj.width-x):page.x+x)+'px';});}}});},destroyElements:function(){if(this.controller.onDestroyElement!=$empty){var cont=this.controller,that=this;this.each(function(content,isLeaf,elem1,elem2){cont.onDestroyElement(content,TreeUtil.getSubtree(that.tree,content.id),isLeaf,elem1,elem2);});}},empty:function(){this.destroyElements();$clean($get(this.rootId));},loadTree:function(id){this.empty();this.loadJSON(TreeUtil.getSubtree(this.tree,id));}};TM.SliceAndDice=new Class({Implements:TM,loadJSON:function(json){this.controller.onBeforeCompute(json);var container=$get(this.rootId),config=this.config,width=container.offsetWidth,height=container.offsetHeight;var p={'coord':{'top':0,'left':0,'width':width,'height':height+config.titleHeight+config.offset}};if(this.tree==null)this.tree=json;this.shownTree=json;this.compute(p,json,this.layout.orientation);container.innerHTML=this.plot(json);this.initializeElements();this.controller.onAfterCompute(json);},compute:function(par,json,orientation){var config=this.config,coord=par.coord,offst=config.offset,width=coord.width-offst,height=coord.height-offst-config.titleHeight,pdata=par.data,fact=(pdata&&("$area"in pdata))?json.data.$area/pdata.$area:1;var otherSize,size,dim,pos,pos2;var horizontal=(orientation=="h");if(horizontal){orientation='v';otherSize=height;size=Math.round(width*fact);dim='height';pos='top';pos2='left';}else{orientation='h';otherSize=Math.round(height*fact);size=width;dim='width';pos='left';pos2='top';}
json.coord={'width':size,'height':otherSize,'top':0,'left':0};var offsetSize=0,tm=this;$each(json.children,function(elem){tm.compute(json,elem,orientation);elem.coord[pos]=offsetSize;elem.coord[pos2]=0;offsetSize+=Math.floor(elem.coord[dim]);});}});TM.Area=new Class({loadJSON:function(json){this.controller.onBeforeCompute(json);var container=$get(this.rootId),width=container.offsetWidth,height=container.offsetHeight,offst=this.config.offset,offwdth=width-offst,offhght=height-offst-this.config.titleHeight;json.coord={'height':height,'width':width,'top':0,'left':0};var coord=$merge(json.coord,{'width':offwdth,'height':offhght});this.compute(json,coord);container.innerHTML=this.plot(json);if(this.tree==null)this.tree=json;this.shownTree=json;this.initializeElements();this.controller.onAfterCompute(json);},computeDim:function(tail,initElem,w,coord,comp){if(tail.length+initElem.length==1){var l=(tail.length==1)?tail:initElem;this.layoutLast(l,w,coord);return;}
if(tail.length>=2&&initElem.length==0){initElem=[tail[0]];tail=tail.slice(1);}
if(tail.length==0){if(initElem.length>0)this.layoutRow(initElem,w,coord);return;}
var c=tail[0];if(comp(initElem,w)>=comp([c].concat(initElem),w)){this.computeDim(tail.slice(1),initElem.concat([c]),w,coord,comp);}else{var newCoords=this.layoutRow(initElem,w,coord);this.computeDim(tail,[],newCoords.dim,newCoords,comp);}},worstAspectRatio:function(ch,w){if(!ch||ch.length==0)return Number.MAX_VALUE;var areaSum=0,maxArea=0,minArea=Number.MAX_VALUE;for(var i=0;i<ch.length;i++){var area=ch[i]._area;areaSum+=area;minArea=(minArea<area)?minArea:area;maxArea=(maxArea>area)?maxArea:area;}
var sqw=w*w,sqAreaSum=areaSum*areaSum;return Math.max(sqw*maxArea/sqAreaSum,sqAreaSum/(sqw*minArea));},avgAspectRatio:function(ch,w){if(!ch||ch.length==0)return Number.MAX_VALUE;var arSum=0;for(var i=0;i<ch.length;i++){var area=ch[i]._area;var h=area/w;arSum+=(w>h)?w/h:h/w;}
return arSum/ch.length;},layoutLast:function(ch,w,coord){ch[0].coord=coord;}});TM.Squarified=new Class({Implements:[TM,TM.Area],compute:function(json,coord){if(!(coord.width>=coord.height&&this.layout.horizontal()))
this.layout.change();var ch=json.children,config=this.config;if(ch.length>0){this.processChildrenLayout(json,ch,coord);for(var i=0;i<ch.length;i++){var chcoord=ch[i].coord,offst=config.offset,height=chcoord.height-(config.titleHeight+offst),width=chcoord.width-offst;coord={'width':width,'height':height,'top':0,'left':0};this.compute(ch[i],coord);}}},processChildrenLayout:function(par,ch,coord){var parentArea=coord.width*coord.height;var i,totalChArea=0,chArea=[];for(i=0;i<ch.length;i++){chArea[i]=parseFloat(ch[i].data.$area);totalChArea+=chArea[i];}
for(i=0;i<chArea.length;i++){ch[i]._area=parentArea*chArea[i]/totalChArea;}
var minimumSideValue=(this.layout.horizontal())?coord.height:coord.width;ch.sort(function(a,b){return(a._area<=b._area)-(a._area>=b._area);});var initElem=[ch[0]];var tail=ch.slice(1);this.squarify(tail,initElem,minimumSideValue,coord);},squarify:function(tail,initElem,w,coord){this.computeDim(tail,initElem,w,coord,this.worstAspectRatio);},layoutRow:function(ch,w,coord){if(this.layout.horizontal()){return this.layoutV(ch,w,coord);}else{return this.layoutH(ch,w,coord);}},layoutV:function(ch,w,coord){var totalArea=0,rnd=Math.round;$each(ch,function(elem){totalArea+=elem._area;});var width=rnd(totalArea/w),top=0;for(var i=0;i<ch.length;i++){var h=rnd(ch[i]._area/width);ch[i].coord={'height':h,'width':width,'top':coord.top+top,'left':coord.left};top+=h;}
var ans={'height':coord.height,'width':coord.width-width,'top':coord.top,'left':coord.left+width};ans.dim=Math.min(ans.width,ans.height);if(ans.dim!=ans.height)this.layout.change();return ans;},layoutH:function(ch,w,coord){var totalArea=0,rnd=Math.round;$each(ch,function(elem){totalArea+=elem._area;});var height=rnd(totalArea/w),top=coord.top,left=0;for(var i=0;i<ch.length;i++){ch[i].coord={'height':height,'width':rnd(ch[i]._area/height),'top':top,'left':coord.left+left};left+=ch[i].coord.width;}
var ans={'height':coord.height-height,'width':coord.width,'top':coord.top+height,'left':coord.left};ans.dim=Math.min(ans.width,ans.height);if(ans.dim!=ans.width)this.layout.change();return ans;}});TM.Strip=new Class({Implements:[TM,TM.Area],compute:function(json,coord){var ch=json.children,config=this.config;if(ch.length>0){this.processChildrenLayout(json,ch,coord);for(var i=0;i<ch.length;i++){var chcoord=ch[i].coord,offst=config.offset,height=chcoord.height-(config.titleHeight+offst),width=chcoord.width-offst;coord={'width':width,'height':height,'top':0,'left':0};this.compute(ch[i],coord);}}},processChildrenLayout:function(par,ch,coord){var area=coord.width*coord.height;var dataValue=parseFloat(par.data.$area);$each(ch,function(elem){elem._area=area*parseFloat(elem.data.$area)/dataValue;});var side=(this.layout.horizontal())?coord.width:coord.height;var initElem=[ch[0]];var tail=ch.slice(1);this.stripify(tail,initElem,side,coord);},stripify:function(tail,initElem,w,coord){this.computeDim(tail,initElem,w,coord,this.avgAspectRatio);},layoutRow:function(ch,w,coord){if(this.layout.horizontal()){return this.layoutH(ch,w,coord);}else{return this.layoutV(ch,w,coord);}},layoutV:function(ch,w,coord){var totalArea=0,rnd=function(x){return x;};$each(ch,function(elem){totalArea+=elem._area;});var width=rnd(totalArea/w),top=0;for(var i=0;i<ch.length;i++){var h=rnd(ch[i]._area/width);ch[i].coord={'height':h,'width':width,'top':coord.top+(w-h-top),'left':coord.left};top+=h;}
var ans={'height':coord.height,'width':coord.width-width,'top':coord.top,'left':coord.left+width,'dim':w};return ans;},layoutH:function(ch,w,coord){var totalArea=0,rnd=function(x){return x;};$each(ch,function(elem){totalArea+=elem._area;});var height=rnd(totalArea/w),top=coord.height-height,left=0;for(var i=0;i<ch.length;i++){ch[i].coord={'height':height,'width':rnd(ch[i]._area/height),'top':top,'left':coord.left+left};left+=ch[i].coord.width;}
var ans={'height':coord.height-height,'width':coord.width,'top':coord.top,'left':coord.left,'dim':w};return ans;}});})();var swfobject=function(){var D="undefined",r="object",S="Shockwave Flash",W="ShockwaveFlash.ShockwaveFlash",q="application/x-shockwave-flash",R="SWFObjectExprInst",x="onreadystatechange",O=window,j=document,t=navigator,T=false,U=[h],o=[],N=[],I=[],l,Q,E,B,J=false,a=false,n,G,m=true,M=function(){var aa=typeof j.getElementById!=D&&typeof j.getElementsByTagName!=D&&typeof j.createElement!=D,ah=t.userAgent.toLowerCase(),Y=t.platform.toLowerCase(),ae=Y?/win/.test(Y):/win/.test(ah),ac=Y?/mac/.test(Y):/mac/.test(ah),af=/webkit/.test(ah)?parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):false,X=!+"\v1",ag=[0,0,0],ab=null;if(typeof t.plugins!=D&&typeof t.plugins[S]==r){ab=t.plugins[S].description;if(ab&&!(typeof t.mimeTypes!=D&&t.mimeTypes[q]&&!t.mimeTypes[q].enabledPlugin)){T=true;X=false;ab=ab.replace(/^.*\s+(\S+\s+\S+$)/,"$1");ag[0]=parseInt(ab.replace(/^(.*)\..*$/,"$1"),10);ag[1]=parseInt(ab.replace(/^.*\.(.*)\s.*$/,"$1"),10);ag[2]=/[a-zA-Z]/.test(ab)?parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0}}else{if(typeof O.ActiveXObject!=D){try{var ad=new ActiveXObject(W);if(ad){ab=ad.GetVariable("$version");if(ab){X=true;ab=ab.split(" ")[1].split(",");ag=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}}catch(Z){}}}return{w3:aa,pv:ag,wk:af,ie:X,win:ae,mac:ac}}(),k=function(){if(!M.w3){return}if((typeof j.readyState!=D&&j.readyState=="complete")||(typeof j.readyState==D&&(j.getElementsByTagName("body")[0]||j.body))){f()}if(!J){if(typeof j.addEventListener!=D){j.addEventListener("DOMContentLoaded",f,false)}if(M.ie&&M.win){j.attachEvent(x,function(){if(j.readyState=="complete"){j.detachEvent(x,arguments.callee);f()}});if(O==top){(function(){if(J){return}try{j.documentElement.doScroll("left")}catch(X){setTimeout(arguments.callee,0);return}f()})()}}if(M.wk){(function(){if(J){return}if(!/loaded|complete/.test(j.readyState)){setTimeout(arguments.callee,0);return}f()})()}s(f)}}();function f(){if(J){return}try{var Z=j.getElementsByTagName("body")[0].appendChild(C("span"));Z.parentNode.removeChild(Z)}catch(aa){return}J=true;var X=U.length;for(var Y=0;Y<X;Y++){U[Y]()}}function K(X){if(J){X()}else{U[U.length]=X}}function s(Y){if(typeof O.addEventListener!=D){O.addEventListener("load",Y,false)}else{if(typeof j.addEventListener!=D){j.addEventListener("load",Y,false)}else{if(typeof O.attachEvent!=D){i(O,"onload",Y)}else{if(typeof O.onload=="function"){var X=O.onload;O.onload=function(){X();Y()}}else{O.onload=Y}}}}}function h(){if(T){V()}else{H()}}function V(){var X=j.getElementsByTagName("body")[0];var aa=C(r);aa.setAttribute("type",q);var Z=X.appendChild(aa);if(Z){var Y=0;(function(){if(typeof Z.GetVariable!=D){var ab=Z.GetVariable("$version");if(ab){ab=ab.split(" ")[1].split(",");M.pv=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}else{if(Y<10){Y++;setTimeout(arguments.callee,10);return}}X.removeChild(aa);Z=null;H()})()}else{H()}}function H(){var ag=o.length;if(ag>0){for(var af=0;af<ag;af++){var Y=o[af].id;var ab=o[af].callbackFn;var aa={success:false,id:Y};if(M.pv[0]>0){var ae=c(Y);if(ae){if(F(o[af].swfVersion)&&!(M.wk&&M.wk<312)){w(Y,true);if(ab){aa.success=true;aa.ref=z(Y);ab(aa)}}else{if(o[af].expressInstall&&A()){var ai={};ai.data=o[af].expressInstall;ai.width=ae.getAttribute("width")||"0";ai.height=ae.getAttribute("height")||"0";if(ae.getAttribute("class")){ai.styleclass=ae.getAttribute("class")}if(ae.getAttribute("align")){ai.align=ae.getAttribute("align")}var ah={};var X=ae.getElementsByTagName("param");var ac=X.length;for(var ad=0;ad<ac;ad++){if(X[ad].getAttribute("name").toLowerCase()!="movie"){ah[X[ad].getAttribute("name")]=X[ad].getAttribute("value")}}P(ai,ah,Y,ab)}else{p(ae);if(ab){ab(aa)}}}}}else{w(Y,true);if(ab){var Z=z(Y);if(Z&&typeof Z.SetVariable!=D){aa.success=true;aa.ref=Z}ab(aa)}}}}}function z(aa){var X=null;var Y=c(aa);if(Y&&Y.nodeName=="OBJECT"){if(typeof Y.SetVariable!=D){X=Y}else{var Z=Y.getElementsByTagName(r)[0];if(Z){X=Z}}}return X}function A(){return!a&&F("6.0.65")&&(M.win||M.mac)&&!(M.wk&&M.wk<312)}function P(aa,ab,X,Z){a=true;E=Z||null;B={success:false,id:X};var ae=c(X);if(ae){if(ae.nodeName=="OBJECT"){l=g(ae);Q=null}else{l=ae;Q=X}aa.id=R;if(typeof aa.width==D||(!/%$/.test(aa.width)&&parseInt(aa.width,10)<310)){aa.width="310"}if(typeof aa.height==D||(!/%$/.test(aa.height)&&parseInt(aa.height,10)<137)){aa.height="137"}j.title=j.title.slice(0,47)+" - Flash Player Installation";var ad=M.ie&&M.win?"ActiveX":"PlugIn",ac="MMredirectURL="+O.location.toString().replace(/&/g,"%26")+"&MMplayerType="+ad+"&MMdoctitle="+j.title;if(typeof ab.flashvars!=D){ab.flashvars+="&"+ac}else{ab.flashvars=ac}if(M.ie&&M.win&&ae.readyState!=4){var Y=C("div");X+="SWFObjectNew";Y.setAttribute("id",X);ae.parentNode.insertBefore(Y,ae);ae.style.display="none";(function(){if(ae.readyState==4){ae.parentNode.removeChild(ae)}else{setTimeout(arguments.callee,10)}})()}u(aa,ab,X)}}function p(Y){if(M.ie&&M.win&&Y.readyState!=4){var X=C("div");Y.parentNode.insertBefore(X,Y);X.parentNode.replaceChild(g(Y),X);Y.style.display="none";(function(){if(Y.readyState==4){Y.parentNode.removeChild(Y)}else{setTimeout(arguments.callee,10)}})()}else{Y.parentNode.replaceChild(g(Y),Y)}}function g(ab){var aa=C("div");if(M.win&&M.ie){aa.innerHTML=ab.innerHTML}else{var Y=ab.getElementsByTagName(r)[0];if(Y){var ad=Y.childNodes;if(ad){var X=ad.length;for(var Z=0;Z<X;Z++){if(!(ad[Z].nodeType==1&&ad[Z].nodeName=="PARAM")&&!(ad[Z].nodeType==8)){aa.appendChild(ad[Z].cloneNode(true))}}}}}return aa}function u(ai,ag,Y){var X,aa=c(Y);if(M.wk&&M.wk<312){return X}if(aa){if(typeof ai.id==D){ai.id=Y}if(M.ie&&M.win){var ah="";for(var ae in ai){if(ai[ae]!=Object.prototype[ae]){if(ae.toLowerCase()=="data"){ag.movie=ai[ae]}else{if(ae.toLowerCase()=="styleclass"){ah+=' class="'+ai[ae]+'"'}else{if(ae.toLowerCase()!="classid"){ah+=" "+ae+'="'+ai[ae]+'"'}}}}}var af="";for(var ad in ag){if(ag[ad]!=Object.prototype[ad]){af+='<param name="'+ad+'" value="'+ag[ad]+'" />'}}aa.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+ah+">"+af+"</object>";N[N.length]=ai.id;X=c(ai.id)}else{var Z=C(r);Z.setAttribute("type",q);for(var ac in ai){if(ai[ac]!=Object.prototype[ac]){if(ac.toLowerCase()=="styleclass"){Z.setAttribute("class",ai[ac])}else{if(ac.toLowerCase()!="classid"){Z.setAttribute(ac,ai[ac])}}}}for(var ab in ag){if(ag[ab]!=Object.prototype[ab]&&ab.toLowerCase()!="movie"){e(Z,ab,ag[ab])}}aa.parentNode.replaceChild(Z,aa);X=Z}}return X}function e(Z,X,Y){var aa=C("param");aa.setAttribute("name",X);aa.setAttribute("value",Y);Z.appendChild(aa)}function y(Y){var X=c(Y);if(X&&X.nodeName=="OBJECT"){if(M.ie&&M.win){X.style.display="none";(function(){if(X.readyState==4){b(Y)}else{setTimeout(arguments.callee,10)}})()}else{X.parentNode.removeChild(X)}}}function b(Z){var Y=c(Z);if(Y){for(var X in Y){if(typeof Y[X]=="function"){Y[X]=null}}Y.parentNode.removeChild(Y)}}function c(Z){var X=null;try{X=j.getElementById(Z)}catch(Y){}return X}function C(X){return j.createElement(X)}function i(Z,X,Y){Z.attachEvent(X,Y);I[I.length]=[Z,X,Y]}function F(Z){var Y=M.pv,X=Z.split(".");X[0]=parseInt(X[0],10);X[1]=parseInt(X[1],10)||0;X[2]=parseInt(X[2],10)||0;return(Y[0]>X[0]||(Y[0]==X[0]&&Y[1]>X[1])||(Y[0]==X[0]&&Y[1]==X[1]&&Y[2]>=X[2]))?true:false}function v(ac,Y,ad,ab){if(M.ie&&M.mac){return}var aa=j.getElementsByTagName("head")[0];if(!aa){return}var X=(ad&&typeof ad=="string")?ad:"screen";if(ab){n=null;G=null}if(!n||G!=X){var Z=C("style");Z.setAttribute("type","text/css");Z.setAttribute("media",X);n=aa.appendChild(Z);if(M.ie&&M.win&&typeof j.styleSheets!=D&&j.styleSheets.length>0){n=j.styleSheets[j.styleSheets.length-1]}G=X}if(M.ie&&M.win){if(n&&typeof n.addRule==r){n.addRule(ac,Y)}}else{if(n&&typeof j.createTextNode!=D){n.appendChild(j.createTextNode(ac+" {"+Y+"}"))}}}function w(Z,X){if(!m){return}var Y=X?"visible":"hidden";if(J&&c(Z)){c(Z).style.visibility=Y}else{v("#"+Z,"visibility:"+Y)}}function L(Y){var Z=/[\\\"<>\.;]/;var X=Z.exec(Y)!=null;return X&&typeof encodeURIComponent!=D?encodeURIComponent(Y):Y}var d=function(){if(M.ie&&M.win){window.attachEvent("onunload",function(){var ac=I.length;for(var ab=0;ab<ac;ab++){I[ab][0].detachEvent(I[ab][1],I[ab][2])}var Z=N.length;for(var aa=0;aa<Z;aa++){y(N[aa])}for(var Y in M){M[Y]=null}M=null;for(var X in swfobject){swfobject[X]=null}swfobject=null})}}();return{registerObject:function(ab,X,aa,Z){if(M.w3&&ab&&X){var Y={};Y.id=ab;Y.swfVersion=X;Y.expressInstall=aa;Y.callbackFn=Z;o[o.length]=Y;w(ab,false)}else{if(Z){Z({success:false,id:ab})}}},getObjectById:function(X){if(M.w3){return z(X)}},embedSWF:function(ab,ah,ae,ag,Y,aa,Z,ad,af,ac){var X={success:false,id:ah};if(M.w3&&!(M.wk&&M.wk<312)&&ab&&ah&&ae&&ag&&Y){w(ah,false);K(function(){ae+="";ag+="";var aj={};if(af&&typeof af===r){for(var al in af){aj[al]=af[al]}}aj.data=ab;aj.width=ae;aj.height=ag;var am={};if(ad&&typeof ad===r){for(var ak in ad){am[ak]=ad[ak]}}if(Z&&typeof Z===r){for(var ai in Z){if(typeof am.flashvars!=D){am.flashvars+="&"+ai+"="+Z[ai]}else{am.flashvars=ai+"="+Z[ai]}}}if(F(Y)){var an=u(aj,am,ah);if(aj.id==ah){w(ah,true)}X.success=true;X.ref=an}else{if(aa&&A()){aj.data=aa;P(aj,am,ah,ac);return}else{w(ah,true)}}if(ac){ac(X)}})}else{if(ac){ac(X)}}},switchOffAutoHideShow:function(){m=false},ua:M,getFlashPlayerVersion:function(){return{major:M.pv[0],minor:M.pv[1],release:M.pv[2]}},hasFlashPlayerVersion:F,createSWF:function(Z,Y,X){if(M.w3){return u(Z,Y,X)}else{return undefined}},showExpressInstall:function(Z,aa,X,Y){if(M.w3&&A()){P(Z,aa,X,Y)}},removeSWF:function(X){if(M.w3){y(X)}},createCSS:function(aa,Z,Y,X){if(M.w3){v(aa,Z,Y,X)}},addDomLoadEvent:K,addLoadEvent:s,getQueryParamValue:function(aa){var Z=j.location.search||j.location.hash;if(Z){if(/\?/.test(Z)){Z=Z.split("?")[1]}if(aa==null){return L(Z)}var Y=Z.split("&");for(var X=0;X<Y.length;X++){if(Y[X].substring(0,Y[X].indexOf("="))==aa){return L(Y[X].substring((Y[X].indexOf("=")+1)))}}}return""},expressInstallCallback:function(){if(a){var X=c(R);if(X&&l){X.parentNode.replaceChild(l,X);if(Q){w(Q,true);if(M.ie&&M.win){l.style.display="block"}}if(E){E(B)}}a=false}}}}();Ext.namespace("cwb");cwb.Cwb=function(){}
cwb.Cwb.prototype.processConfig=function(){document.title=cwb.Config.appTitle;}
cwb.Cwb.prototype.startApplication=function(){this.installErrorHandler();this.installOverrides();var params=location.search.split(/&/);var sid=null;for(var i=0;i<params.length;i++){var parts=params[i].split(/=/);if(parts[0]="sid"){sid=parts[1];break;}}
if(sid){cwb.Session.getInstance().init(sid);this.workbench=new cwb.ui.Workbench();}else{this.login=new cwb.ui.Login();}}
cwb.Cwb.prototype.startSession=function(sid,lang){cwb.Session.getInstance().init(sid,lang);this.login.destroy();this.defaultWorkbench=cwb.ui.Workbench.getInstance();this.viewport=this.defaultWorkbench;}
cwb.Cwb.prototype.reload=function(){this.viewport.destroy();cwb.persistency.Persistency.getInstance().logout(function(){window.location.reload();});}
cwb.Cwb.prototype.installErrorHandler=function(){return;var self=this;var originalAddListener=Ext.EventManager.addListener;Ext.EventManager.addListener=function(element,eventName,fn,scope,options){scope=scope||this;return originalAddListener(element,eventName,function(){try{fn.apply(scope||this,arguments);}catch(e){self.handleError(e);}},scope,options);}
Ext.EventManager.on=Ext.EventManager.addListener;window.onerror=function(message,uri,line){self.handleError(null,message,uri,line);}}
cwb.Cwb.prototype.handleError=function(e,message,uri,line){var data=new Object();data["file"]=uri?uri:e&&e.fileName?e.fileName:"unknown";data["line number"]=line?line:e&&e.lineNumber?e.lineNumber:"unknown";data["error name"]=e&&e.name?e.name:"unknown";data["error message"]=message?message:e&&e.message?e.message:"unknown";data["stack"]=e&&e.stack?e.stack:"unknown";var plainText="";for(var i in data){var val=data[i];if(!(val instanceof Function)){plainText+=i+": "+val+"\n";}}
cwb.persistency.Persistency.getInstance().log("error",plainText);var html="";for(var i in data){var val=data[i];if(!(val instanceof Function)){html+="<p><b>"+i+":</b> "+
(""+val).replace(/\n/g,"<br />")+"</p>";}}
if(cwb.Config.debug){cwb.Util.showMessage(cwb.Dict.translate("Error occured"),html,cwb.Util.messageType.ERROR);throw e;}else{var self=this;var window=new Ext.Window({id:cwb.Cwb.ERROR_WINDOW_ID,title:cwb.Dict.translate("Error occured"),layout:"fit",items:[new Ext.Panel({html:"<p class='cwb-errorDialogMessage'>"+
cwb.Dict.translate("An application error occured. Your data will be saved and the application will be restarted.")+"</p>"}),new Ext.Panel({id:cwb.Cwb.ERROR_DETAILS_ID,title:cwb.Dict.translate("Error details"),collapsed:true,collapsible:true,animCollapse:false,collapseFirst:true,html:"<div class='cwb-errorDialogDetails'>"+
html+"</div>",listeners:{"collapse":function(){window.center();},"expand":function(){window.center();}}})],buttons:[{text:cwb.Dict.translate("OK"),handler:function(){self.reload();}},{text:cwb.Dict.translate("Continue on your own risk"),handler:function(){window.destroy();}}]});window.show();}}
cwb.Cwb.prototype.installOverrides=function(){Ext.override(Ext.form.Field,{loadValue:function(value){this.setValue(value);this.originalValue=this.getValue();}});}
cwb.Cwb.getInstance=function(){if(!cwb.Cwb.instance){cwb.Cwb.instance=new cwb.Cwb();}
return cwb.Cwb.instance;}
cwb.Cwb.ERROR_WINDOW_ID="errorWindowId";cwb.Cwb.ERROR_DETAILS_ID="errorDetailsId";Ext.namespace("cwb.Constants");cwb.Constants.DD_GROUP="cwbDDGroup";cwb.Constants.SVN_REVISION="513";cwb.Constants.AJAX_TIMEOUT=7200000;Ext.namespace("cwb.Util");cwb.Util.getUwmClassNameFromOid=function(oid){var result=oid.match(/^[^:]+/)[0];if(oid.charAt(0)=="{"){result=oid.match(/:([^}]+)/)[1];}
return result;}
cwb.Util.getNumericFromOid=function(oid){return oid.match(/:([0-9]+)/)[1];}
cwb.Util.showMessage=function(title,message,messageType){var messageContainer=Ext.get("messageContainer");if(!messageContainer){messageContainer=Ext.DomHelper.insertFirst(document.body,{id:"messageContainer",style:"position: absolute"},true);}
messageContainer.alignTo(document,'t-t');var messageBox=Ext.DomHelper.append(messageContainer,{html:'<div>'+'<div class="x-box-tl"><div class="x-box-tr"><div class="x-box-tc"></div></div></div>'+'<div class="x-box-ml"><div class="x-box-mr"><div class="x-box-mc"><h3>'+title
+'</h3>'+message+'</div></div></div>'+'<div class="x-box-bl"><div class="x-box-br"><div class="x-box-bc"></div></div></div>'+'</div>'},true);messageBox.slideIn('t').pause(3).ghost("t",{remove:true});}
cwb.Util.messageType={INFO:1,WARNING:2,ERROR:3}
cwb.Util.setElementUnselectable=function(elem){if(elem){elem.style.MozUserSelect="none";elem.style.KhtmlUserSelect="none";elem.unselectable="on";}}
cwb.Util.emptyDiv=function(divId){var div=Ext.get(divId);if(div){div.dom.innerHTML="";div.dom.style.display="none";div.dom.setAttribute("data",null);div.dom.setAttribute("src",null);}}
cwb.Util.showDiv=function(divId){var div=Ext.get(divId);if(div){div.dom.style.display="block";}}
Ext.namespace("cwb");cwb.Session=function(){this.sid=null;this.jsonUrl=cwb.Config.jsonUrl;this.helpUrl="welcome/welcome.html";this.persistencyClass="cwb.persistency.Json";this.lang="en";}
cwb.Session.prototype.init=function(sid,lang){this.sid=sid;this.lang=lang;}
cwb.Session.prototype.getSid=function(){return this.sid;}
cwb.Session.prototype.getJsonUrl=function(){return this.jsonUrl;}
cwb.Session.prototype.getHelpUrl=function(){return this.helpUrl;}
cwb.Session.prototype.getPersistencyClass=function(){return this.persistencyClass;}
cwb.Session.prototype.getLang=function(){return this.lang;}
cwb.Session.getInstance=function(){if(!cwb.Session.instance){cwb.Session.instance=new cwb.Session();}
return cwb.Session.instance;}
Ext.namespace("cwb.Config");cwb.Config.jsonUrl="../application/main.php";cwb.Config.appTitle="Chronos Web Browser";cwb.Config.debug=true;cwb.Config.defaultLogin="admin";cwb.Config.defaultPassword="admin";cwb.Config.baseHref="";cwb.Cwb.getInstance().processConfig();Ext.namespace("cwb.Dict");cwb.Dict.voc={'Select a model...':{'de':"Modell auswhlen..."},'Package weight':{'de':"Paketgewicht"},'Package tree':{'de':"Paketbaum"},'Object information':{'de':"Objektinformationen"},'Error':{'de':"Fehler"},'Please select a model.':{'de':"Bitte whlen Sie ein Modell aus."},'Loading':{'de':"Ldt"},'Loading report...':{'de':"Ldt Report..."},'Content':{'de':"Inhalt"},'Left-click to enter a package or object, right-click to leave it.':{'de':"Linksklick auf ein Paket um es zu betrachten, Rechtsklick um es zu verlassen."},'Click on an object to see its children.':{'de':"Klick auf ein Objekt zeigt dessen Kinder."}}
cwb.Dict.translate=function(){strword=arguments[0];try{strresult=cwb.Dict.voc[strword][cwb.Session.getInstance().getLang()];if(!strresult){strresult=strword;}}catch(e){strresult=strword;}
return strresult;}
Ext.namespace("cwb");cwb.ObjectContainer=function(){this.models=[];this.objectsForTreemap=[];this.objectsForSpacetree=[];this.selectedModel=null;this.selectedModelName=null;this.objectsToLoad=0;this.modelLoaded=false;this.maxTreeContent=1;};cwb.ObjectContainer.prototype.loadModelList=function(dropdown){var self=this;cwb.persistency.Persistency.getInstance().loadChildren('root',function(options,data){self.handleLoadedModelList(options,data,dropdown);},function(){});};cwb.ObjectContainer.prototype.handleLoadedModelList=function(options,data,dropdown){for(i in data.objects){if(!(data.objects[i]instanceof Function)){var recordTemplate=[data.objects[i].oid,data.objects[i].text];this.models.push(recordTemplate);}}
dropdown.store.loadData(this.models);};cwb.ObjectContainer.prototype.loadModel=function(modelOid,useCache,callback){this.currModelOid=modelOid;var self=this;var longTaskRunner=new cwb.ui.LongTaskRunner({title:cwb.Dict.translate('Generating Data ...'),call:function(successHandler,errorHandler){cwb.persistency.Persistency.getInstance().loadAllStatisticsOverview(modelOid,useCache,successHandler,errorHandler);},successHandler:function(data){longTaskRunner.close();self.modelUmlGenerated(callback);},errorHandler:function(data){cwb.Util.showMessage(cwb.Dict.translate("Error while copying"),cwb.Dict.translate("The process was unsuccessful. Please try again."),cwb.Util.messageType.ERROR);},isReturningDocument:false}).show();};cwb.ObjectContainer.prototype.modelUmlGenerated=function(callback){this.modelLoaded=true;callback('generated');this.loadJitData(this.currModelOid,callback);};cwb.ObjectContainer.prototype.loadJitData=function(oid,callback){this.objectsForTreemap=[];this.objectsForTreemap[0]={id:oid,name:this.selectedModelName,data:{$area:0,$color:1},children:[],parentOid:'root',uwmClassName:'Model'};this.objectsForSpacetree=[];this.objectsForSpacetree[0]={id:oid,name:this.selectedModelName,data:{$area:0,$color:1},children:[],parentOid:'root',uwmClassName:'Model'};this.loadJitObject(oid,callback);};cwb.ObjectContainer.prototype.loadJitObject=function(oid,callback){var self=this;this.objectsToLoad++;cwb.persistency.Persistency.getInstance().loadChildren(oid,function(options,data){self.handleLoadedJitObject(options,data,oid,callback);});};cwb.ObjectContainer.prototype.handleLoadedJitObject=function(options,data,oid,callback){for(var i=0;i<data.objects.length;i++){if(!(data.objects[i]instanceof Function)){var childOid=data.objects[i].oid;var arrayPosition=this.objectsForTreemap.length;var uwmClass=cwb.Util.getUwmClassNameFromOid(childOid);this.objectsForTreemap[arrayPosition]={id:childOid,name:data.objects[i].text,data:{$area:0,$color:1},children:[],parentOid:oid,uwmClassName:uwmClass};this.objectsForSpacetree[arrayPosition]={id:childOid,name:data.objects[i].text,data:{$area:0,$color:1},children:[],parentOid:oid,uwmClassName:uwmClass};if(uwmClass=="Package"){this.loadJitObject(childOid,callback);}}}
this.objectsToLoad--;if(this.objectsToLoad==0){this.objectsForSpacetree=this.arrangeTree(this.objectsForSpacetree);this.objectsForTreemap=this.arrangeTree(this.objectsForTreemap);this.setAreaData(this.objectsForTreemap);this.setWeightColors(this.objectsForTreemap);callback('jit');}};cwb.ObjectContainer.prototype.arrangeTree=function(objects){var arrayPosition;for(var i=0;i<objects.length;i++){if(!(objects[i]instanceof Function)){var parentOid=objects[i].parentOid;if(!(parentOid=='root')){objects[this.getObjectPosition(parentOid,objects)].children.push(objects[i]);}
else{arrayPosition=i;}}}
return objects[arrayPosition];};cwb.ObjectContainer.prototype.setAreaData=function(objectList){var result=0;if(objectList.children.length==0){objectList.data.$area=1;result=1;}
else{for(var j=0;j<objectList.children.length;j++){if(!(objectList.children[j]instanceof Function)){result+=this.setAreaData(objectList.children[j]);}}
objectList.data.$area=result;}
return result;};cwb.ObjectContainer.prototype.setWeightColors=function(){this.maxTreeContent=0;this.getMaxContent(this.objectsForTreemap);this.setColor(this.objectsForTreemap);};cwb.ObjectContainer.prototype.getMaxContent=function(objectList){if(objectList.data.$area==objectList.children.length){if(objectList.children.length>this.maxTreeContent&&this.containsLeaves(objectList.children)){this.maxTreeContent=objectList.children.length;}}
else{for(var i=0;i<objectList.children.length;i++){if(!(objectList.children[i]instanceof Function)){this.getMaxContent(objectList.children[i]);}}}};cwb.ObjectContainer.prototype.containsLeaves=function(objectList){var result=true;for(var i=0;i<objectList.length;i++){if(!(objectList[i]instanceof Function)){if(objectList[i].children.length!=0){result=false;}}}
return result;};cwb.ObjectContainer.prototype.setColor=function(objectList,parentLength){var contentLength;if(objectList.children.length==0){contentLength=parentLength/this.maxTreeContent;}
else{contentLength=objectList.children.length/this.maxTreeContent;}
var colorValue=5;if(contentLength>0.9){colorValue=1;}
else
if(contentLength>0.7){colorValue=2;}
else
if(contentLength>0.5){colorValue=3;}
else
if(contentLength>0.3){colorValue=4;}
objectList.data.$color=colorValue;for(var j=0;j<objectList.children.length;j++){this.setColor(objectList.children[j],objectList.children.length);}};cwb.ObjectContainer.prototype.getObjectPosition=function(oid,objectList){for(var i=0;i<objectList.length;i++){if(!(objectList[i]instanceof Function)){if(objectList[i].id==oid){return i;}}}};cwb.ObjectContainer.prototype.getModels=function(){return this.models;};cwb.ObjectContainer.prototype.setModelOid=function(modelOid){this.selectedModel=modelOid;return true;};cwb.ObjectContainer.prototype.getCurrModelOid=function(){return this.currModelOid;};cwb.ObjectContainer.getInstance=function(){if(!cwb.ObjectContainer.instance){cwb.ObjectContainer.instance=new cwb.ObjectContainer();}
return cwb.ObjectContainer.instance;};Ext.namespace("cwb");cwb.ObjectsListGrid=function(config){var self=this;cwb.ObjectsListGrid.superclass.constructor.call(this,Ext.apply(this,{layout:"fit",viewConfig:{forceFit:true},sm:new Ext.grid.RowSelectionModel({singleSelect:true}),stripeRows:true,store:this.store,columns:[],loadMask:true,viewConfig:{forceFit:true,getRowClass:function(record,index){return'clickableRow';}}},config));};Ext.extend(cwb.ObjectsListGrid,Ext.grid.GridPanel);cwb.ObjectsListGrid.prototype.setColumns=function(columns){this.getColumnModel().setConfig(columns);};cwb.ObjectsListGrid.prototype.iconRenderer=function(uwmClassName){return"<img src='"+cwb.Config.baseHref+"img/icons/"+uwmClassName+".png' width='16' height='16' title='"+uwmClassName+"' />";};Ext.namespace("cwb");cwb.ObjectsListProxy=function(config){cwb.ObjectsListProxy.superclass.constructor.call(this,Ext.apply(this,{record:[],columns:[]}));this.grid=config.grid;this.objectList=config.objectList;this.iconRenderer=config.iconRenderer;};Ext.extend(cwb.ObjectsListProxy,Ext.data.DataProxy);cwb.ObjectsListProxy.prototype.loadResponse=function(options,data,callback,scope,arg){for(var currIndex in data.list){var currNode=data.list[currIndex];if(!(currNode instanceof Function)){if(currNode.type){var tempData=[];tempData.uwmClassName=currNode.type;tempData.oid=currNode.oid;for(var currValueIndex in currNode.values[1]){var currValue=currNode.values[1][currValueIndex];if(!(currValue instanceof Function)){tempData[currValueIndex]=currValue;var columnExists=false;for(var j=0;j<this.columns.length;j++){if(this.columns[j]==currValueIndex){columnExists=true;break;}}
if(!(columnExists)){this.columns.push(currValueIndex);}}}
this.record.push(new Ext.data.Record(tempData));}}}
var result={success:true,records:this.record};this.grid.setColumns(this.getColumns());this.fireEvent("load",this,options,arg);if(callback instanceof Function){callback.call(scope,result,arg,true);}};cwb.ObjectsListProxy.prototype.loadFailed=function(options,data,errorMsg,callback,scope,arg){this.fireEvent("loadexception",this,options,data);if(callback instanceof Function){callback.call(scope,null,arg,false);}};cwb.ObjectsListProxy.prototype.getColumns=function(){var result=[{header:'',width:16,dataIndex:'uwmClassName',renderer:this.iconRenderer,sortable:false,resizable:false,hidden:false},{header:'Name',width:100,dataIndex:'Name',hidden:false},{header:'Notes',width:300,dataIndex:'Notes',hidden:false},{header:'Alias',width:50,dataIndex:'Alias',hidden:true}];for(var i=0;i<this.columns.length;i++){if(this.columns[i]!='Name'&&this.columns[i]!='Notes'&&this.columns[i]!='Alias'&&this.columns[i]!='Author'&&this.columns[i]!='creator'&&this.columns[i]!='created'&&this.columns[i]!='last_editor'&&this.columns[i]!='modified'){result.push({header:this.columns[i],width:31,dataIndex:this.columns[i],hidden:true});}}
result.push({header:'Author',width:70,dataIndex:'Author',hidden:true});result.push({header:'Creator',width:70,dataIndex:'creator',hidden:true});result.push({header:'Created',width:60,dataIndex:'created',hidden:true});result.push({header:'Last editor',width:70,dataIndex:'last_editor',hidden:false});result.push({header:'Modified',width:60,dataIndex:'modified',hidden:false});return result;};Ext.namespace("cwb.persistency");cwb.persistency.Persistency=function(){};cwb.persistency.Persistency.getInstance=function(){if(!cwb.persistency.Persistency.instance){cwb.persistency.Persistency.instance=eval("new "+cwb.Session.getInstance().getPersistencyClass()+"()");}
return cwb.persistency.Persistency.instance;};cwb.persistency.Persistency.prototype.processSuccessHandler=function(successHandler,request,data){if(successHandler instanceof Function){successHandler(request,data);}};cwb.persistency.Persistency.prototype.processErrorHandler=function(errorHandler,request,data,errorMessage){if(errorHandler instanceof Function){errorHandler(request,data,errorMessage);}
else if(errorHandler instanceof String){cwb.Util.showMessage(cwb.Dict.translate('Persistency layer error'),errorHandler+errorMessage,cwb.Util.messageType.ERROR);}
else if(errorMessage){cwb.Util.showMessage(cwb.Dict.translate('Persistency layer error'),errorMessage,cwb.Util.messageType.ERROR);}else{cwb.Util.showMessage(cwb.Dict.translate('Persistency layer error'),cwb.Dict.translate('An unspecified error has occured in persistency layer.'),cwb.Util.messageType.ERROR);}};cwb.persistency.Persistency.prototype.doLogin=function(login,password,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.logout=function(successHandler,errorHandler){};cwb.persistency.Persistency.prototype.display=function(oid,depth,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.list=function(uwmClassName,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.loadChildren=function(oid,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.lock=function(oid,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.unlock=function(oid,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.log=function(logtype,msg,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.executeActionSet=function(actionSet){};cwb.persistency.Persistency.prototype.loadStatisticsOverview=function(modelOid,template,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.displayByAlias=function(aliasList,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.generateUml=function(modelOid,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.loadAllStatisticsOverview=function(modelOid,useCache,successHandler,errorHandler){};cwb.persistency.Persistency.prototype.lastEdited=function(successHandler,errorHandler){};cwb.persistency.Persistency.prototype.doContinue=function(controller,successHandler,errorHandler){};Ext.namespace("cwb.persistency");cwb.persistency.Json=function(){this.sid=cwb.Session.getInstance().getSid();this.jsonUrl=cwb.Session.getInstance().getJsonUrl();};cwb.persistency.Json.prototype=new cwb.persistency.Persistency;cwb.persistency.Json.prototype.jsonRequest=function(params,successHandler,errorHandler){params.sid=this.sid;params.response_format="JSON";var self=this;Ext.Ajax.request({url:this.jsonUrl,method:"post",params:params,timeout:cwb.Constants.AJAX_TIMEOUT,callback:function(options,success,response){if(success){var data=Ext.util.JSON.decode(response.responseText);if(!data.errorMsg){self.processSuccessHandler(successHandler,options,data);}else{self.processErrorHandler(errorHandler,options,data,data.errorMsg);}}else{self.processErrorHandler(errorHandler,options,data);}}});};cwb.persistency.Json.prototype.array2CommaList=function(array){var result=array;if(array instanceof Array){var first=true;result="";for(var i=0;i<array.length;i++){if(!first){result+=",";}else{first=false;}
result+=array[i];}}
return result;};cwb.persistency.Json.prototype.doLogin=function(login,password,successHandler,errorHandler){this.jsonRequest({usr_action:"dologin",login:login,password:password},successHandler,errorHandler);};cwb.persistency.Json.prototype.logout=function(successHandler,errorHandler){this.jsonRequest({usr_action:"logout"},successHandler,errorHandler);};cwb.persistency.Json.prototype.display=function(oid,depth,successHandler,errorHandler){this.jsonRequest({usr_action:"display",oid:oid,depth:depth,omitMetaData:true,translateValues:true},successHandler,errorHandler);};cwb.persistency.Json.prototype.list=function(uwmClassName,successHandler,errorHandler){this.jsonRequest({usr_action:"list",type:uwmClassName},successHandler,errorHandler);};cwb.persistency.Json.prototype.loadChildren=function(oid,successHandler,errorHandler){this.jsonRequest({controller:"TreeViewController",usr_action:"loadChildren",node:oid},successHandler,errorHandler);};cwb.persistency.Json.prototype.lock=function(oid,successHandler,errorHandler){this.jsonRequest({usr_action:"lock",oid:oid},successHandler,errorHandler);};cwb.persistency.Json.prototype.unlock=function(oid,successHandler,errorHandler){this.jsonRequest({usr_action:"unlock",oid:oid},successHandler,errorHandler);};cwb.persistency.Json.prototype.log=function(logtype,msg,successHandler,errorHandler){var self=this;this.jsonRequest({usr_action:"log",logtype:logtype,msg:msg},successHandler,function(request,data,errorMessage){if(errorMessage){self.processSuccessHandler(successHandler);}else{self.processErrorHandler(errorHandler,request,data);}});};cwb.persistency.Json.prototype.doContinue=function(controller,successHandler,errorHandler){this.jsonRequest({controller:controller,usr_action:'continue'},successHandler,errorHandler);};cwb.persistency.Json.prototype.executeActionSet=function(actionSet){var data={};var requests=actionSet.getRequests();for(var currActionName in requests){var currRequest=requests[currActionName];if(!(currRequest instanceof Function)){var jsonRequest={};jsonRequest.usr_action=currRequest.action;switch(currRequest.action){case"dologin":jsonRequest.login=currRequest.login;jsonRequest.password=currRequest.password;break;case"dologout":break;case"display":jsonRequest.oid=currRequest.oid;jsonRequest.depth=currRequest.depth;jsonRequest.omitMetaData=true;jsonRequest.translateValues=true;break;case"list":jsonRequest.type=currRequest.uwmClassName;break;case"loadChildren":jsonRequest.controller="TreeViewController";jsonRequest.node=currRequest.oid;break;case"lock":jsonRequest.oid=currRequest.oid;break;case"unlock":jsonRequest.oid=currRequest.oid;break;case"log":jsonRequest.logtype=currRequest.logtype;jsonRequest.msg=currRequest.msg;break;default:cwb.Util.showMessage("Programming Error","Unknown action in ActionSet: "+currRequest.action,cwb.Util.messageType.ERROR);}
data[currActionName]=jsonRequest;}}
this.jsonRequest({controller:"TerminateController",usr_action:"multipleAction",request_format:"JSON",data:Ext.encode(data),actionSet:actionSet},function(request,data){request.params.actionSet.successHandler(request,data);},function(request,data,errorMessage){request.params.actionSet.errorHandler(request,data,errorMessage);});};cwb.persistency.Json.prototype.loadStatisticsOverview=function(modelOid,template,successHandler,errorHandler){this.jsonRequest({usr_action:"loadStatisticsOverview",modelOid:modelOid,template:template},successHandler,errorHandler);};cwb.persistency.Json.prototype.displayByAlias=function(aliasList,successHandler,errorHandler){this.jsonRequest({usr_action:"displayByAlias",aliasList:this.array2CommaList(aliasList),translateValues:true},successHandler,errorHandler);};cwb.persistency.Json.prototype.generateUml=function(modelOid,successHandler,errorHandler){this.jsonRequest({usr_action:"generateUml",modelOid:modelOid},successHandler,errorHandler);};cwb.persistency.Json.prototype.loadAllStatisticsOverview=function(modelOid,useCache,successHandler,errorHandler){this.jsonRequest({usr_action:"loadAllStatisticsOverview",modelOid:modelOid,useCache:useCache},successHandler,errorHandler);};cwb.persistency.Json.prototype.lastEdited=function(successHandler,errorHandler){this.jsonRequest({usr_action:"lastEdited"},successHandler,errorHandler);};Ext.namespace("cwb.persistency");cwb.persistency.ActionSet=function(){this.requests={};this.currentId=0;};cwb.persistency.ActionSet.prototype.addLogin=function(login,password,successHandler,errorHandler,errorLevel){this.requests[this.getNextId()]={action:"dologin",login:login,password:password,successHandler:successHandler,errorHandler:errorHandler,errorLevel:errorLevel};};cwb.persistency.ActionSet.prototype.addLogout=function(successHandler,errorHandler,errorLevel){this.requests[this.getNextId()]={action:"dologout",successHandler:successHandler,errorHandler:errorHandler,errorLevel:errorLevel};};cwb.persistency.ActionSet.prototype.addDisplay=function(oid,depth,successHandler,errorHandler,errorLevel){this.requests[this.getNextId()]={action:"display",oid:oid,depth:depth,successHandler:successHandler,errorHandler:errorHandler,errorLevel:errorLevel};};cwb.persistency.ActionSet.prototype.addList=function(uwmClassName,successHandler,errorHandler,errorLevel){this.requests[this.getNextId()]={action:"list",uwmClassName:uwmClassName,successHandler:successHandler,errorHandler:errorHandler,errorLevel:errorLevel};};cwb.persistency.ActionSet.prototype.addLoadChildren=function(oid,successHandler,errorHandler,errorLevel){this.requests[this.getNextId()]={action:"loadChildren",oid:oid,successHandler:successHandler,errorHandler:errorHandler,errorLevel:errorLevel};};cwb.persistency.ActionSet.prototype.addLock=function(oid,successHandler,errorHandler,errorLevel){this.requests[this.getNextId()]={action:"lock",oid:oid,successHandler:successHandler,errorHandler:errorHandler,errorLevel:errorLevel};};cwb.persistency.ActionSet.prototype.addUnlock=function(oid,successHandler,errorHandler,errorLevel){this.requests[this.getNextId()]={action:"unlock",oid:oid,successHandler:successHandler,errorHandler:errorHandler,errorLevel:errorLevel};};cwb.persistency.ActionSet.prototype.addLog=function(logtype,msg,successHandler,errorHandler,errorLevel){this.requests[this.getNextId()]={action:"log",logtype:logtype,msg:msg,successHandler:successHandler,errorHandler:errorHandler,errorLevel:errorLevel};};cwb.persistency.ActionSet.prototype.commit=function(successHandler,errorHandler){for(var i in this.requests){var val=this.requests[i];if(!(val instanceof Function)){if(val.errorLevel){val.errorLevel=cwb.persistency.ActionSet.DEFAULT_ERROR_LEVEL;}}}
this.savedSuccessHandler=successHandler;this.savedErrorHandler=errorHandler;cwb.persistency.Persistency.getInstance().executeActionSet(this);};cwb.persistency.ActionSet.prototype.getNextId=function(){var result=cwb.persistency.ActionSet.ACTION_PREFIX+this.currentId;this.currentId++;return result;};cwb.persistency.ActionSet.prototype.getRequests=function(){return this.requests;};cwb.persistency.ActionSet.prototype.successHandler=function(request,data){var errorLevel=null;var persistency=cwb.persistency.Persistency.getInstance();for(var currActionName in this.requests){var currRequest=this.requests[currActionName];if(!(currRequest instanceof Function)){var currResponse=data.data[currActionName];if(currResponse.success==1){persistency.processSuccessHandler(currRequest.successHandler,currRequest,currResponse);}else{if(currRequest.errorLevel>errorLevel){errorLevel=currRequest.errorLevel;}
persistency.processErrorHandler(currRequest.errorHandler,currRequest,currResponse,currResponse.errorMsg);if(currRequest.errorLevel==cwb.persistency.ActionSet.errorLevels.ERROR){throw new Error(cwb.Dict.translate("Critical Persistency Error")
+": "+currResponse.errorMsg);}}}}
persistency.processSuccessHandler(this.savedSuccessHandler,request,data);};cwb.persistency.ActionSet.prototype.errorHandler=function(request,data,errorMessage){cwb.persistency.Persistency.getInstance().processErrorHandler(this.savedErrorHandler,request,data,errorMessage);};cwb.persistency.ActionSet.errorLevels={IGNORE:1,WARN:2,ERROR:3};cwb.persistency.ActionSet.DEFAULT_ERROR_LEVEL=cwb.persistency.ActionSet.errorLevels.WARN;cwb.persistency.ActionSet.ACTION_PREFIX="action";Ext.namespace("cwb.persistency");cwb.persistency.LongTask=function(call,iFrameId){this.call=call;this.iFrameId=iFrameId;this.processHandler=null;this.successHandler=null;this.errorHandler=null;};cwb.persistency.LongTask.prototype.run=function(processHandler,successHandler,errorHandler){this.processHandler=processHandler;this.successHandler=successHandler;this.errorHandler=errorHandler;if(this.call instanceof Function){this.call(this.jsonSuccess.createDelegate(this),this.jsonError.createDelegate(this));}};cwb.persistency.LongTask.prototype.jsonSuccess=function(options,data){var stepNumber=parseInt(data['stepNumber']);var numberOfSteps=parseInt(data['numberOfSteps']);var stepName=data['displayText'];var controller=data['controller'];if(stepNumber>numberOfSteps){if(this.successHandler instanceof Function){this.successHandler(data);}}
else if(stepNumber==numberOfSteps&&this.iFrameId!=null){if(this.processHandler instanceof Function){this.processHandler(stepName,stepNumber,numberOfSteps,data);}
var self=this;var iFrame=Ext.get(this.iFrameId);if(iFrame){iFrame.on("load",function(){self.onDownload.defer(10,self,[iFrame]);});iFrame.set({src:'../application/main.php?response_format=HTML&usr_action=continue&controller='+controller+'&sid='+cwb.Session.getInstance().getSid()});if(this.successHandler instanceof Function){this.successHandler(data);}}}
else{if(this.processHandler instanceof Function){this.processHandler(stepName,stepNumber,numberOfSteps,data);}
cwb.persistency.Persistency.getInstance().doContinue(controller,this.jsonSuccess.createDelegate(this),this.jsonError.createDelegate(this));}};cwb.persistency.LongTask.prototype.jsonError=function(options,data){if(this.errorHandler instanceof Function){this.errorHandler(data);}};cwb.persistency.LongTask.prototype.onDownload=function(iFrame){try{var result=Ext.util.JSON.decode(iFrame.dom.contentDocument.body.innerHTML);if(!result.success){if(this.errorHandler instanceof Function){this.errorHandler(data);}}}catch(e){}};Ext.namespace("cwb.ui");cwb.ui.ModelChooser=function(){};cwb.ui.ModelChooser=Ext.extend(Ext.Panel,{initComponent:function(){var self=this;this.selectModelBox=new Ext.form.ComboBox({x:2,y:105,width:163,store:new Ext.data.SimpleStore({fields:["oid","name"],data:[]}),displayField:"name",valueField:"oid",editable:false,mode:"local",triggerAction:'all',emptyText:cwb.Dict.translate('Select a model...'),selectOnFocus:true});cwb.ObjectContainer.getInstance().loadModelList(this.selectModelBox);this.loadModelButton=new Ext.Button({x:170,y:105,text:cwb.Dict.translate('Report'),type:'submit',handler:function(){self.loadModel();}});this.useCacheCheckbox=new Ext.form.Checkbox({x:2,y:132,boxLabel:cwb.Dict.translate('Use cached model'),checked:true});Ext.apply(this,{region:'north',layout:'absolute',height:155,bodyStyle:'background-color:#DFE8F6;',items:[{x:0,y:0,html:'<img src="'+cwb.Config.baseHref+'img/logo3.png">'},this.selectModelBox,this.loadModelButton,this.useCacheCheckbox]});cwb.ui.ModelChooser.superclass.initComponent.apply(this,arguments);}});cwb.ui.ModelChooser.prototype.loadModel=function(){var modelOid=this.selectModelBox.getValue();var useCache=this.useCacheCheckbox.getValue();var container=cwb.ObjectContainer.getInstance();if(modelOid){cwb.ui.Workbench.getInstance().showMask();cwb.statistics.Overview.getInstance().clear();cwb.ui.DiagramPanel.getInstance().clear();cwb.ui.StructureTabPanel.getInstance().clear();var self=this;container.loadModel(modelOid,useCache,function(state){self.handleLoadCallback(state);});}else{Ext.Msg.alert(cwb.Dict.translate("Error"),cwb.Dict.translate("Please select a model."));}};cwb.ui.ModelChooser.prototype.handleLoadCallback=function(state){switch(state){case'generated':cwb.ui.DiagramPanel.getInstance().showDiagrams();cwb.statistics.Overview.getInstance().loadData();Ext.Msg.updateProgress(0.5,cwb.Dict.translate("Loading diagrams and statistics"));break;case'jit':cwb.ui.StructureTabPanel.getInstance().showDiagrams();Ext.Msg.hide();break;}};Ext.namespace("cwb.ui");cwb.ui.DiagramPanel=function(){};cwb.ui.DiagramPanel=Ext.extend(Ext.Panel,{initComponent:function(){var self=this;this.piechartPanel=new Ext.Panel({columnWidth:0.5,layout:'fit',html:'<div id="'+cwb.ui.DiagramPanel.PIECHART_ID+'" class="cwb-flashDiv">'+'<div class="noSelectionNote">No model selected</div></div>'});this.barchartPanel=new Ext.Panel({columnWidth:0.5,layout:'fit',html:'<div id="'+cwb.ui.DiagramPanel.BARCHART_ID+'" class="cwb-flashDiv">'+'<div class="noSelectionNote">No model selected</div></div>'});Ext.apply(this,{region:'north',height:250,layout:'column',items:[this.piechartPanel,this.barchartPanel]});cwb.ui.DiagramPanel.superclass.initComponent.apply(this,arguments);this.on("render",this.adjustPanelSize);this.on("resize",this.adjustPanelSize);}});cwb.ui.DiagramPanel.prototype.adjustPanelSize=function(){var height=this.getSize().height;this.piechartPanel.setHeight(height);this.barchartPanel.setHeight(height);};cwb.ui.DiagramPanel.prototype.showDiagrams=function(){var modelOid=cwb.ObjectContainer.getInstance().getCurrModelOid();if(modelOid){this.showFlash(cwb.ui.DiagramPanel.PIECHART_ID,"pieData",modelOid);this.showFlash(cwb.ui.DiagramPanel.BARCHART_ID,"barData",modelOid);this.adjustPanelSize();}};cwb.ui.DiagramPanel.prototype.clear=function(){cwb.Util.emptyDiv(cwb.ui.DiagramPanel.PIECHART_ID);cwb.Util.emptyDiv(cwb.ui.DiagramPanel.BARCHART_ID);};cwb.ui.DiagramPanel.prototype.showFlash=function(divId,action,modelOid){var url=cwb.Config.jsonUrl+"?usr_action="+action+"%26response_format=JSON%26modelOid="+modelOid.replace(/:/,'_');swfobject.embedSWF(cwb.Config.baseHref+"lib/ofc/open-flash-chart.swf",divId,"100%","100%","9.0.0","expressInstall.swf",{"data-file":url},{"wmode":"transparent"});};cwb.ui.DiagramPanel.getInstance=function(){if(!cwb.ui.DiagramPanel.instance){cwb.ui.DiagramPanel.instance=new cwb.ui.DiagramPanel();}
return cwb.ui.DiagramPanel.instance;};cwb.ui.DiagramPanel.PIECHART_ID="cwb-piechart-id";cwb.ui.DiagramPanel.BARCHART_ID="cwb-barchart-id";Ext.namespace("cwb.statistics");cwb.ui.LastEditedGrid=function(config){var self=this;this.store=new Ext.data.Store({autoLoad:true,proxy:new cwb.ui.LastEditedProxy({grid:this,objectList:config.objectList,iconRenderer:this.iconRenderer})});cwb.ui.LastEditedGrid.superclass.constructor.call(this,Ext.apply(this,{title:cwb.Dict.translate('Most recently edited Objects')},config));this.on('rowclick',function(grid,rowIndex,e){var selectedItem=self.getStore().getAt(rowIndex);if(selectedItem){self.fireEvent('objectSelected',selectedItem.get('oid'));}});}
Ext.extend(cwb.ui.LastEditedGrid,cwb.ObjectsListGrid);Ext.namespace("cwb.statistics");cwb.ui.LastEditedProxy=function(config){cwb.ui.LastEditedProxy.superclass.constructor.call(this,Ext.apply(this,{},config));}
Ext.extend(cwb.ui.LastEditedProxy,cwb.ObjectsListProxy);cwb.ui.LastEditedProxy.prototype.load=function(params,reader,callback,scope,arg){if(this.fireEvent("beforeload",this,params)!==false){var self=this;cwb.persistency.Persistency.getInstance().lastEdited(function(options,data){self.loadResponse(options,data,callback,scope,arg);},function(options,data){self.loadFailed(options,data,callback,scope,arg);})}else{callback.call(scope||this,null,arg,false);}}
Ext.namespace("cwb.ui");cwb.ui.StructureTabPanel=function(){};cwb.ui.StructureTabPanel=Ext.extend(Ext.TabPanel,{initComponent:function(){var self=this;this.packageWeight=new cwb.ui.Treemap();this.weightPanel=new Ext.Panel({title:cwb.Dict.translate('Package weight'),tabTip:cwb.Dict.translate('Left-click to enter a package or object, right-click to leave it.'),html:'<div id="'+cwb.ui.StructureTabPanel.WEIGHT_ID+'">'+'<div class="noSelectionNote">No model selected</div></div>',listeners:{"resize":function(){self.showDiagrams();}}});this.treePanel=new Ext.Panel({title:cwb.Dict.translate('Package tree'),tabTip:cwb.Dict.translate('Click on an object to see its children.'),html:'<div id="'+cwb.ui.StructureTabPanel.PACKAGE_ID+'">'+'<div class="noSelectionNote">No model selected</div></div>',listeners:{"resize":function(){self.showDiagrams();}}});this.lastEditedPanel=new cwb.ui.LastEditedGrid({listeners:{'objectSelected':function(oid){self.onObjectSelected(oid);}}});Ext.apply(this,{region:'center',activeTab:0,deferredRender:false,items:[this.lastEditedPanel,this.weightPanel]});cwb.ui.StructureTabPanel.superclass.initComponent.apply(this,arguments);this.on("tabchange",function(tabPanel,tab){self.handleTabChange(tabPanel,tab);});this.on("remove",function(tabPanel,tab){self.removeHitsGrid(tab);});this.hitsGrids=new Ext.util.MixedCollection();}});cwb.ui.StructureTabPanel.prototype.handleTabChange=function(tabPanel,tab){this.showDiagrams();};cwb.ui.StructureTabPanel.prototype.clear=function(){var tabCount=this.items.getCount();for(var i=cwb.ui.StructureTabPanel.STATIC_TAB_COUNT;i<tabCount;i++){this.remove(this.items.itemAt(cwb.ui.StructureTabPanel.STATIC_TAB_COUNT));}
this.hitsGrids.clear();cwb.Util.emptyDiv(cwb.ui.StructureTabPanel.WEIGHT_ID);this.setActiveTab(0);};cwb.ui.StructureTabPanel.prototype.removeHitsGrid=function(hitsGrid){this.hitsGrids.remove(hitsGrid);};cwb.ui.StructureTabPanel.prototype.showDiagrams=function(){var modelOid=cwb.ObjectContainer.getInstance().getCurrModelOid();if(modelOid){cwb.Util.showDiv(cwb.ui.StructureTabPanel.WEIGHT_ID);this.packageWeight.show();}};cwb.ui.StructureTabPanel.prototype.createHitsGrid=function(id,tabTitle,tabContentOids){var tab=this.hitsGrids.get(id);var self=this;if(!tab){var tab=new cwb.statistics.HitsGrid({title:tabTitle,objectList:tabContentOids,listeners:{'objectSelected':function(oid){self.onObjectSelected(oid);}}});this.hitsGrids.add(id,tab);this.add(tab);}
tab.show();};cwb.ui.StructureTabPanel.prototype.onObjectSelected=function(oid){this.fireEvent('objectSelected',oid);};cwb.ui.StructureTabPanel.getInstance=function(){if(!(cwb.ui.StructureTabPanel.instance)){cwb.ui.StructureTabPanel.instance=new cwb.ui.StructureTabPanel();}
return cwb.ui.StructureTabPanel.instance;};cwb.ui.StructureTabPanel.WEIGHT_ID="cwb-weight-id";cwb.ui.StructureTabPanel.PACKAGE_ID="cwb-package-id";cwb.ui.StructureTabPanel.STATIC_TAB_COUNT=3;Ext.namespace("cwb.ui");TM.Squarified.implement({'setColor':function(json){var x=json.data.$color;var switchColors=function(dataValue){switch(dataValue){case 1:return'#e42217';break;case 2:return'#f87217';break;case 3:return'#fffa40';break;case 4:return'#b1fb17';break;case 5:default:return'#6cc217';break;}}
return switchColors(x);}});cwb.ui.Treemap=function(){};cwb.ui.Treemap.prototype.show=function(){var objContainer=cwb.ObjectContainer.getInstance();if(objContainer.modelLoaded){var json=objContainer.objectsForTreemap;var tm=new TM.Squarified({rootId:cwb.ui.StructureTabPanel.WEIGHT_ID,addLeftClickHandler:true,addRightClickHandler:true,selectPathOnHover:true,Color:{allow:true,minValue:0,maxValue:5,tips:true,maxColorValue:[0,255,50],minColorValue:[255,0,50]},Tips:{allow:true,offsetX:20,offsetY:20,onShow:function(tip,node,isLeaf,domElement){tip.innerHTML="<div class=\"tip-title\">"+node.name
+"</div>"+"<div class=\"tip-text\">"
+this.makeHTMLFromData(node.data)+"</div>";},makeHTMLFromData:function(data){var html='';html+=parent.cwb.Dict.translate('Content')+': '
+data.$area+'<br />';return html;}},onDestroyElement:function(content,tree,isLeaf,leaf){if(leaf.clearAttributes)
leaf.clearAttributes();}});tm.loadJSON(json);}};Ext.namespace("cwb.ui");cwb.ui.Spacetree=function(){this.spacetreeCounter=0;this.spacetreeCanvas=0;};cwb.ui.Spacetree.prototype.show=function(){var json=cwb.ObjectContainer.getInstance().objectsForSpacetree;if(json.data){var fStyle,sStyle,lineWidth;this.spacetreeCanvas=this.spacetreeCanvas||new Canvas('mycanvas',{'injectInto':cwb.ui.StructureTabPanel.PACKAGE_ID,'width':2000,'height':2000,'backgroundColor':'#fff','styles':{'fillStyle':'#eee','strokeStyle':'#111'},setColor:function(color){this.styles.fillStyle=color;}});Tree.Label.nodeHash={};cwb.Util.emptyDiv("mycanvas-label");cwb.Util.showDiv("mycanvas-label");var self=this;var st=new ST(this.spacetreeCanvas,{onCreateLabel:function(label,node){label.id=node.id;label.innerHTML="<div class='outer'><div class='inner'><img src='"+cwb.Config.baseHref+"img/icons/"+
node.uwmClassName+".png' />"+node.name+"</div></div>";label.onclick=function(){st.onClick(label.id);};},onBeforePlotNode:function(node){var ctx=self.spacetreeCanvas.getCtx();fStyle=ctx.fillStyle;sStyle=ctx.strokeStyle;if(node.selected){ctx.fillStyle="#eee";ctx.strokeStyle="#000";}},onAfterPlotNode:function(node){var ctx=self.spacetreeCanvas.getCtx();ctx.fillStyle=fStyle;ctx.stroleStyle=sStyle;},onBeforePlotLine:function(adj){var ctx=self.spacetreeCanvas.getCtx();lineWidth=ctx.lineWidth;sStyle=ctx.strokeStyle;if(adj.nodeFrom.selected&&adj.nodeTo.selected){ctx.strokeStyle="#000";ctx.lineWidth=3;}},onAfterPlotLine:function(adj){var ctx=self.spacetreeCanvas.getCtx();ctx.lineWidth=lineWidth;ctx.stroleStyle=sStyle;},request:function(nodeId,level,onComplete){var self=this;cwb.persistency.Persistency.getInstance().display(nodeId.indexOf("_")>0?nodeId.substring(0,nodeId.indexOf("_")):nodeId,2,function(options,data){var result=self.loadFromDisplay(data.node);onComplete.onComplete(nodeId,result);});},loadFromDisplay:function(currNode){var result={id:currNode.oid+"_"+this.spacetreeCounter,name:currNode.values[1].Name,data:[{key:'content',value:0},{key:'color',value:1}],children:[],uwmClassName:currNode.type};this.spacetreeCounter++;for(var currType in currNode){var currTypeData=currNode[currType];if(!(currTypeData instanceof Function)){switch(currType){case"values":case"oid":case"type":case"properties":break;default:for(var currNodeKey in currTypeData){var currChild=currTypeData[currNodeKey];if(!(currChild instanceof Function)){if(currChild.values&&currChild.values[1]&&currChild.values[1].Name){result.children.push(this.loadFromDisplay(currChild));}}}}}}
return result;}});st.loadJSON(json);st.compute();Tree.Geometry.translate(st.tree,new Complex(-200,0),"startPos");st.onClick(st.tree.id);}};Ext.namespace("cwb.ui");cwb.ui.Workbench=function(config){var self=this;this.modelChooser=new cwb.ui.ModelChooser();cwb.ui.Workbench.superclass.constructor.call(this,Ext.apply(this,{layout:"border",items:[{region:'west',width:307,layout:'border',items:[this.modelChooser,cwb.statistics.Overview.getInstance()]},{region:'center',layout:'border',items:[cwb.ui.DiagramPanel.getInstance(),cwb.ui.StructureTabPanel.getInstance()]}]}));};Ext.extend(cwb.ui.Workbench,Ext.Viewport);cwb.ui.Workbench.prototype.createInformationTab=function(id,objectList){var proxy=new InfoGridProxy(id,objectList);var store=new Ext.data.Store({proxy:proxy});proxy['store']=store;store.load();};cwb.ui.Workbench.prototype.addInformationTab=function(id,store,columnList){var newTab=new InfoGrid({title:id,store:store,columns:columnList,closable:true});var structureTabPanel=cwb.ui.StructureTabPanel.getInstance()
structureTabPanel.add(newTab);structureTabPanel.activate(newTab);this.doLayout();};cwb.ui.Workbench.prototype.showMask=function(){Ext.Msg.progress(cwb.Dict.translate("Loading"),cwb.Dict.translate("Loading report ..."),cwb.Dict.translate("Generating UML export"));};cwb.ui.Workbench.getInstance=function(){if(!(cwb.ui.Workbench.instance)){cwb.ui.Workbench.instance=new cwb.ui.Workbench();}
return cwb.ui.Workbench.instance;};Ext.namespace("cwb.ui");cwb.ui.Login=function(config){var self=this;this.form=new Ext.FormPanel({labelWidth:100,frame:true,title:'Login',bodyStyle:'padding:5px 5px 0',width:375,defaults:{width:230},keys:[{key:[10,13],handler:function(){self.initSession();}}],items:[new Ext.form.TextField({fieldLabel:cwb.Dict.translate('Login'),name:'login',allowBlank:false,value:cwb.Config.defaultLogin}),new Ext.form.TextField({fieldLabel:cwb.Dict.translate('Password'),name:'password',inputType:"password",allowBlank:false,value:cwb.Config.defaultPassword}),new Ext.form.ComboBox({fieldLabel:cwb.Dict.translate('Language'),forceSelection:'true',value:'en',name:'Language',store:new Ext.data.SimpleStore({fields:[{name:"key",mapping:"key"},{name:"val",mapping:"val"}],data:[{key:"en",val:"English"},{key:"de",val:"Deutsch"}]}),displayField:'val',valueField:'key',mode:"local",triggerAction:'all',editable:false,})],buttons:[{text:cwb.Dict.translate('Login'),type:'submit',handler:function(){self.initSession();}}]});if(!Ext.isGecko3){this.form.add(new Ext.Panel({cls:"cwb-browserWarning",html:"<div>"+"<p class='nonLast'><b>Attention:</b> You're using an unsupported browser. If you continue, the application may behave strangely or work not at all.</p>"+"<p>Currently, the supported browser is Firefox 3.</p>"+"</div>"}));}
cwb.ui.Login.superclass.constructor.call(this,Ext.apply(this,{id:"loginViewport",layout:"absolute",items:[this.form]},config));}
Ext.extend(cwb.ui.Login,Ext.Viewport);cwb.ui.Login.prototype.render=function(){cwb.ui.Login.superclass.render.apply(this,arguments);var viewportSize=this.getSize();var formSize=this.form.getSize();var x=viewportSize.width/2-formSize.width/2;var y=viewportSize.height/2-formSize.height/2;this.form.setPosition(x,y);this.form.getForm().findField("login").focus();}
cwb.ui.Login.prototype.initSession=function(){if(this.form.getForm().isValid()){var self=this;cwb.persistency.Persistency.getInstance().doLogin(this.form.getForm().findField("login").getValue(),this.form.getForm().findField("password").getValue(),function(options,data){self.handleLogin(options,data);},function(options,data,errorMsg){self.handleLoginFailure(options,data,errorMsg);});}}
cwb.ui.Login.prototype.handleLogin=function(options,data){cwb.Cwb.getInstance().startSession(data.sid,this.form.getForm().findField("Language").getValue());}
cwb.ui.Login.prototype.handleLoginFailure=function(options,data,errorMsg){cwb.Util.showMessage("Login Failed",data.errorMsg,cwb.Util.messageType.ERROR);var passwordField=this.form.getForm().findField("password");passwordField.setValue("");passwordField.focus();}
Ext.namespace("cwb.ui");cwb.ui.LongTaskRunner=function(config){var self=this;this.iFrameId=Ext.id();this.pbar=new Ext.ProgressBar({text:cwb.Dict.translate('Initializing ...'),id:'pbar',cls:'left-align',height:20,anchor:'100%'});this.okButton=new Ext.Button({text:cwb.Dict.translate("Cancel"),handler:function(){self.destroy();}});this.iFrame=new Ext.Panel({html:'<iframe id="'+this.iFrameId+'" src=""></iframe>',});this.iFrame.setVisible(false);cwb.ui.LongTaskRunner.superclass.constructor.call(this,Ext.apply(this,{layout:'anchor',width:320,height:87,items:[this.pbar,this.iFrame],buttons:[this.okButton],bodyBorder:false,border:false,closable:false,resizable:false,modal:true},config));this.on("render",function(){window.setTimeout(function(){self.pbar.reset();var iFrameId=null;if(self.isReturningDocument)
iFrameId=self.iFrameId;var task=new cwb.persistency.LongTask(self.call,iFrameId);task.run.defer(10,task,[function(text,i,total,data){self.pbar.updateProgress(i/total,text);if(self.progressHandler instanceof Function){self.progressHandler(data);}},function(data){self.pbar.updateText(cwb.Dict.translate("Finished"));self.okButton.setText(cwb.Dict.translate("Close"));if(data.summaryText&&data.summaryText!=""){self.add(new Ext.Panel({html:"<div class='cwb-errorDialogDetails'>"+
data.summaryText.replace(/\n/g,"<br>")+"</div>",autoScroll:true,height:100,anchor:'100%'}));self.setHeight(100+self.height);self.doLayout();}
if(self.successHandler instanceof Function){self.successHandler(data);}},function(data){self.okButton.setText(cwb.Dict.translate("Close"));if(self.errorHandler instanceof Function){self.errorHandler(data);}}]);},250);});}
cwb.ui.LongTaskRunner.prototype.close=function(){this.destroy();}
Ext.extend(cwb.ui.LongTaskRunner,Ext.Window);Ext.namespace("cwb.statistics");cwb.statistics.OverviewProxy=function(config){cwb.statistics.OverviewProxy.superclass.constructor.call(this,Ext.apply(this,{},config));};Ext.extend(cwb.statistics.OverviewProxy,Ext.data.DataProxy);cwb.statistics.OverviewProxy.prototype.load=function(params,reader,callback,scope,arg){if(this.fireEvent("beforeload",this,params)!==false){var self=this;cwb.persistency.Persistency.getInstance().loadStatisticsOverview(arg.modelOid,'statistics',function(options,data){self.loadResponse(options,data,callback,scope,arg);},function(options,data,errorMsg){self.loadFailed(options,data,errorMsg,callback,scope,arg);});}else{callback.call(scope||this,null,arg,false);}};cwb.statistics.OverviewProxy.prototype.loadResponse=function(options,data,callback,scope,arg){var records=[];for(var i in data.statistics){var val=data.statistics[i];if(!(val instanceof Function)&&val._id){var record=new Ext.data.Record(val,val._id);if(record.get('_parent')==""){record.set('_parent',null);}
records.push(record);}}
var result={success:true,records:records,totalRecords:records.length};this.fireEvent("load",this,options,arg);callback.call(scope,result,arg,true);};cwb.statistics.OverviewProxy.prototype.loadFailed=function(options,data,errorMsg,callback,scope,arg){this.fireEvent("loadexception",this,options,data);callback.call(scope,null,arg,false);};Ext.namespace("cwb.statistics");cwb.statistics.Overview=function(){};cwb.statistics.Overview=Ext.extend(Ext.ux.maximgb.tg.EditorGridPanel,{initComponent:function(){var self=this;this.store=new Ext.ux.maximgb.tg.AdjacencyListStore({autoLoad:false,proxy:new cwb.statistics.OverviewProxy()});this.store.add([new Ext.data.Record({_id:0,_parent:null,_is_leaf:true,object:'<div class="noSelectionNote">No model selected</div>',status:-1},0)]);Ext.apply(this,{region:'center',title:cwb.Dict.translate('Statistical Data'),store:this.store,master_column_id:'object',columns:[{id:'object',header:"Object",width:170,sortable:false,dataIndex:'object',renderer:function(value,metadata,record,rowIndex,colIndex,store){metadata.attr='ext:qtip="'+record.get('toolTip')+'"';return value;}},{header:"Quantity",width:50,sortable:false,dataIndex:'quantity'},{header:"",width:21,sortable:false,dataIndex:'status',renderer:self.statusRenderer}],viewConfig:{forceFit:true,getRowClass:function(record,index){var objectList=record.get('objectList');if(objectList instanceof Array&&objectList.length>0){return'clickableRow';}}},sm:new Ext.grid.RowSelectionModel({singleSelect:true}),stripeRows:true});cwb.statistics.Overview.superclass.initComponent.apply(this,arguments);this.on('rowclick',function(grid,rowIndex,e){var record=self.getStore().getAt(rowIndex);var objectList=record.get('objectList');if(objectList instanceof Array&&objectList.length>0){cwb.ui.StructureTabPanel.getInstance().createHitsGrid(record.get('id'),record.get('object'),record.get('objectList'));}});}});cwb.statistics.Overview.prototype.statusRenderer=function(value){var result="";if(value!==null&&value!==''&&value!==-1){result="<img src='"+cwb.Config.baseHref+"img/signal"+value+".png' />";}
return result;};cwb.statistics.Overview.prototype.loadData=function(){this.clear();this.reload(cwb.ObjectContainer.getInstance().getCurrModelOid());};cwb.statistics.Overview.prototype.clear=function(){this.store.removeAll();};cwb.statistics.Overview.prototype.reload=function(modelOid){this.store.load({modelOid:modelOid});};cwb.statistics.Overview.getInstance=function(){if(!cwb.statistics.Overview.instance){cwb.statistics.Overview.instance=new cwb.statistics.Overview();}
return cwb.statistics.Overview.instance;};Ext.namespace("cwb.statistics");cwb.statistics.HitsGrid=function(config){var self=this;this.store=new Ext.data.Store({autoLoad:true,proxy:new cwb.statistics.HitsProxy({grid:self,objectList:config.objectList,iconRenderer:this.iconRenderer})});cwb.statistics.HitsGrid.superclass.constructor.call(this,Ext.apply(this,{closable:true},config));this.on('rowclick',function(grid,rowIndex,e){var selectedItem=self.getStore().getAt(rowIndex);if(selectedItem){self.fireEvent('objectSelected',selectedItem.get('oid'));}});};Ext.extend(cwb.statistics.HitsGrid,cwb.ObjectsListGrid);Ext.namespace("cwb.statistics");cwb.statistics.HitsProxy=function(config){cwb.statistics.HitsProxy.superclass.constructor.call(this,Ext.apply(this,{},config));};Ext.extend(cwb.statistics.HitsProxy,cwb.ObjectsListProxy);cwb.statistics.HitsProxy.prototype.load=function(params,reader,callback,scope,arg){if(this.fireEvent("beforeload",this,params)!==false){var self=this;cwb.persistency.Persistency.getInstance().displayByAlias(this.objectList,function(options,data){self.loadResponse(options,data,callback,scope,arg);},function(options,data){self.loadFailed(options,data,callback,scope,arg);})}else{callback.call(scope||this,null,arg,false);}};