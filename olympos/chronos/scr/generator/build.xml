<project name="wCMF Generator" default="redist" basedir=".">

	<property file="build.properties"/>

	<path id="lib.path">
		<fileset dir="${lib.dir}">
			<include name="**/*.jar"/>
		</fileset>
	</path>

	<target name="clean">
		<delete includeemptydirs="true" verbose="false" failonerror="false">
			<fileset dir="${build.dir}" includes="**/*" />
			<fileset dir="${redist.dir}" includes="**/*" />
		</delete>
	</target>

	<target name="build-diagram-exporter" depends="clean">
		<ant antfile="${imageexporter.build.file}" target="redist"
			dir="${imageexporter.dir}" inheritAll="false">
  			<property file="${imageexporter.build.properties}"/>
		</ant>
	</target>
	
	<target name="compile" depends="build-diagram-exporter">
		<tstamp/>
		<mkdir dir="${build.dir}"/>
		<javac encoding="utf-8" srcdir="${source.dir}" destdir="${build.dir}" debug="${debug}" excludesfile="compile-excludes">
			<classpath>
				<path refid="lib.path"/>
				<fileset dir="${imageexporter.redist.dir}"/>
			</classpath>
		</javac>
	</target>

	<target name="buildinfo" depends="compile">
		<propertyfile file="${build.info}"
		 comment="Build Information File - DO NOT MODIFY">
		    <entry key="version"
		     value="${version}"/>
		    <entry key="build"
		     type="int" default="0000"
		     operation="+" pattern="0000"/>
		</propertyfile>		
	    <property file="${build.info}"/>
	</target>

	<target name="redist" depends="buildinfo">
		<mkdir dir="${redist.dir}"/>

		<!-- copy all libs ... -->
		<copy todir="${redist.libdir}" verbose="false">
			<fileset dir="${lib.dir}">
				<include name="**/*.*"/>
			</fileset>
			<fileset dir="${imageexporter.redist.dir}/">
				<include name="*.jar"/>
			</fileset>
			<fileset dir="${imageexporter.redist.libdir}/">
				<include name="**/*.jar"/>
			</fileset>
		</copy>

		<manifestclasspath property="lib.list" jarfile="${redist.dir}/${jar.file}">
			<classpath>
				<fileset dir="${redist.libdir}"/>
			</classpath>
		</manifestclasspath>
		
		<jar jarfile="${redist.dir}/${jar.file}">
			<fileset dir="${build.dir}"/>
			<manifest>
				<attribute name="Main-Class" value="net.sourceforge.olympos.oaw.Generator"/>
				<attribute name="wCMFGenerator-Version" value="${version}.${build}"/>
				<attribute name="Class-Path" value=". ${lib.list}"/>
		   </manifest>
		</jar>

		<!-- copy all files ... -->
		<copy todir="${redist.dir}/" verbose="false">
			<fileset dir="${source.dir}">
				<include name="cartridge/**/*.*"/>
				<include name="common/**/*.*"/>
				<include name="metamodel/**/*.*"/>
				<include name="workflow/**/*.*"/>
				<include name="**/*.properties"/>
			</fileset>
			<fileset dir=".">
				<include name="${build.info}"/>
				<include name="wcmf/**/*.*"/>
			</fileset>
			<fileset file="${res.dir}/run.bat" />
		</copy>

		<!-- copy imageexporter resources ... -->
		<copy todir="${imageexporter.cartridge}/" verbose="false">
			<fileset dir="${imageexporter.redist.dir}/">
				<include name="Images/**/*.*"/>
			</fileset>
		</copy>

		<zip destfile="${zip.dir}/ChronosGenerator-${version}.zip" basedir="${redist.dir}"/>
	</target>

</project>
